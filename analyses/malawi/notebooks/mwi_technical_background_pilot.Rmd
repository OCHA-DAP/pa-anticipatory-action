---
title: "Forecasting dry Spells in Malawi"
author: "By Centre for Humanitarian Data"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

## Background
This document summaries all the data work that has been done to inform the trigger mechanism for OCHA Anticipatory Action pilot in Malawi. This pilot is focussed on dry spells, and this document explores the historical dry spells, relations with seasonal observed indicators, and the skill of short-term forecast to predict these dry spells. All work presented here has been done by the Centre for Humanitarian Data, but with indispensable help from techincal partners. All the code is openly available [here](https://github.com/OCHA-DAP/pa-anticipatory-action), and will regularly be referred to in this document. 

### Geographical scale
Analysis done on ADM2 

### Historical analysis
Dry spells [Include full dry spell analysis here or in a separate notebook?]
Seasonal indicators
Impact

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
#copied this from the dry spell description document, sets some general settings
source("historical_dry_spells_description_setup.R")
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = FALSE) # do not print output by default
```

```{r data-load-formatting}
data_dir <- Sys.getenv("AA_DATA_DIR") # AA_DATA_DIR is set as a variable in .Renviron or .bashprofile
rainy_seasons_detail <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/rainy_seasons_detail_2000_2020.csv"))
dry_spells_during_rainy_season_list <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/dry_spells_during_rainy_season_list_2000_2020.csv"))

rainy_seasons_detail$onset_date <- as.Date(rainy_seasons_detail$onset_date, format = "%Y-%m-%d")
rainy_seasons_detail$cessation_date <- as.Date(rainy_seasons_detail$cessation_date, format = "%Y-%m-%d")
```


## Meteorological indicators with a long lead-time
Optimally the pre-alert of the trigger could be based on indicators with a long lead time, preferable 3 to 6 months. This would give the possibility of a wider range of anticipatory actions to be implemented by the organizations in country. Most information provided with such a long lead time doesn't report directly the probability of dry spells in a certain location. They report a more general pattern, such as the ENSO state or the total precipitation over a 3 month period. Therefore, we explored whether these more broad properties that are forecasted well ahead of the rainy season, do have a correlation with the occurrence of a dry spell. We are thus first solely looking at **observational** data, not at forecasts. If the correlations between these observed data sources turn out to be significant, we move to forecasts. This with the assumption that if there is no such correlation in the observed data, there won't be any in the forecasted data. 

### ENSO state
A commonly used long-term meteorological indicator is the El Niño Southern Oscillation (ENSO) state. This state is a global phenomenon, that causes seasonal climatological fluctuations and is related to Sea Surface Temperatures (SSTs). More background on the ENSO phenomenon can be found [here](https://iri.columbia.edu/our-expertise/climate/enso/). 

Several different indicators exist to measure the ENSO state, of which most are indicated [here](https://www.psl.noaa.gov/enso/dashboard.html). The two indicators most commonly used are the NINO3.4 index and ONI. They use slightly different sources of data and aggregation methodologies, but show similar historical patterns. For our analysis it was chosen to use ONI, as their data is commonly used to keep track of the current ENSO state. Nevertheless, both indicators could be used here but no large differences in results are expected. 

#### The data
ONI is reported as a running mean over a 3-month period. Open data exists from 1950 till present. Warm periods are defined as an ONI larger or equal to 0.5, while cold periods are defined as an ONI smaller or equal to -0.5. If 5 or more consecutive overlapping periods reach the threshold for a warm period, these seasons are defined as experiencing El Niño state. As you might guessed, 5 or more consecutive overlapping periods that reach the threshold for a cold period, are defined as experiencing La Niña state. All other seasons are defined as the neutral state. 

#### Analysis
TODO after discussed with Meti
assigning a dry spell to a season/year
Combining seasons to year

#### Results

#### Forecasts
Due to not seeing a relationship between observed ENSO state and dry spells, we didn't move on to analyze the forecasts with the assumption that this relationship will only be weaker. For those interested in the forecasts, the most commonly used forecasts seems to be that [produced by IRI](https://iri.columbia.edu/our-expertise/climate/forecasts/enso/current/), of which the [historical data](https://iri.columbia.edu/~forecast/ensofcst/Data/) can also be downloaded. 

#### Data used
[ONI data](https://www.cpc.ncep.noaa.gov/data/indices/oni.ascii.txt)
Observed dry spells

#### Scripts
Due to circumstances, we derived the values manually from [NOAA's table](https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php), but they are also [available as txt for download](https://www.cpc.ncep.noaa.gov/data/indices/oni.ascii.txt). 
Processing script


### Seasonal precipitation forecasts
Another commonly used forecast source with a long lead time are the so-called seasonal forecasts. Here a season is defined as a 3 month period. Seasonal precipitaiton forecasts are an often used product for informing predictions related to seasonal drought, and depending on the source include forecasts for 1 to 7 months ahead. 



Seasonal precipitation forecasts exist in different formats. The most common format is that of a tercile-based forecasts,where the three terciles are referred to as below-average, normal, and above-average precipitation. These tercile-based forecasts report the probability for the precipitation to be in each tercile, per raster cell. See [here] for a clear resource on the definition of a tercile-based forecast. The Malawi Met services (DCCMS) provide their forecast in this format, as well as global organizations such as IRI and NMME. While we do investigate the relationship of dry spells with seasonal below-average precipitation, by definition the occurence of below-average precipitation is not expected to have a strong relation with dry spells. This is the case for two reasons, namely 1) below-average precipitation occurs on average once every three years, while dry spells are a more extreme event (as we saw in our analysis) and 2) the amount of rainfall that is classified as "below-average" depends on the average rainfall for the given location. The tercile is thus location dependent, whereas the definition of a dry spell is based on an absolute number of milimeters and thus doesn't depend on the location. 

Some organizations also provide absolute forecasted amounts, either as an expected amount per day or per month. The main organizations providing this data are ECMWF and the UK Met office. From the daily projected amounts, one could in theory directly forecast the occurence of a dry spell. However, since those forecasts have such a large uncertainty, it is very unlikely that the forecast will predict the occurence of a dry spell by calendar year. Nevertheless, you can come up with other aggregated measures that might correlate with the occurrence of a dry spell. In this analysis we investigated the relationship of dry spells with total monthly and total seasonal precipitation. 

<!-- The reason we want to know this relation, and do not link the forecasts directly to dry spells, is because these forecast have high uncertainty, which might be partially diminished by looking at the numbers over a longer period of time.  -->


#### The data
We use CHIRPS as datasource to compute the monthly and 3-monthly total precipitation, and the occurrences of below-average precipitation. CHIRPS was chosen as data source, since this is the same source as was used to detect observed dry spells and thus thereby we eliminate any weakening of relationship due to biases in different sources. See for more information about CHIRPS the section on defining observed dry spells. 
We work with the monthly sum of precipitations as directly provided by CHC on their FTP server. We compute the 3-monthly sum from this per raster cell and aggregate this to admin2 level by [.... set aggregation method]. Whether a cell had below-average precipitation, is information that is not readily available, and thus we had to compute this ourselves. [This notebook] shows and explains all the steps taken to do so. Once we had the information whether a raster cell had below-average precipitation or not in a given season, we also aggregated this information to admin2 level. For the aggregation to admin2 level, we used a percentage-based approach since whether a raster cell had below-average precipitation is a binary variable, and thus taking the mean would not be approriate here. 

#### Analysis
Only gonna write this, once we have a final decision on definition of dry spell and aggregation methodology

#### Results
Only gonna write this, once we have a final decision on definition of dry spell and aggregation methodology

#### Scripts
Computing the below average and aggregating
Correlations below average
Correlations total rainfall

#### Data sources used
CHIRPS
Shapefiles

#### TODO
Check format UK Met office (paper, email, ECMWF)
Add flexible forecast IRI once understood better

#### Future
Number of dry days during a month

<!-- ### Monthly precipitation forecasts -->
<!-- Besides forecasted quantities over a 3-month period, one can also look at these quantities over a monthly period. This quantity is reported by a few seasonal forecasts, and might be a better indicator for the occurence of a dry spell than the precipitation over a 3-month period  -->
<!-- We are not aware of any suitable, openly available subseasonal forecasts, but we could possibly use the seasonal forecasts that also provide values per month.  -->


List of available forecasts
Seasonal timescale
Seasonal tercile - IRI, NMME, ECMWF, NMA
Daily seasonal - ECMWF
Monthly seasonal - ECMWF

Monthly timescale
SubX - too experimental 
S2S - Ask IRI -- dont see precipitation on ECMWF website?


## Forecasting of dry spells
As described in the previous section, the long-term indicators were shown to not have a strong correlation with the occurrence of a dry spell. We therefore move on to look at forecasts that can directly forecast dry spells, instead of predicting other indicators such as the ENSO state. Since forecasting skill generally decreases as the lead time decreases, the first forecast that was analyzed was that with the shortest lead time, namely 15 days ahead. This would mean that at the start of a dry spell, the alert could be triggered. Several organizations produce forecasts with this lead time, but most of them are not openly available. For this analysis, we used CHIRPS-GEFS. This is a forecast produced by GEFS, and bias-corrected to the CHIRPS data. This forecast was chosen because it is openly available, has a long historical record, is well-acknowledged, and is bias-corrected to the same data as was used to determine observed dry spells. 

#### The data
CHIRPS-GEFS is available as raster data at 0.05 resolution. A forecast is produced each day, and these forecasts are available from 2000 till present, with a data gap in 2020. Each forecasts indicates the projected cumulative precipitation during the next 15 days per raster cell. For each forecast, the raster cell values were aggregated to admin2 [by.....]

#### Analysis
### Bias of CHIRPS-GEFS
We first analyzed the general performance of CHIRPS-GEFS, by computing a bias plot. This plot shows the observed precipitation over 15 days per admin2, retrieved from CHIRPS data, and on the y-axis the forecasted minus observed 15-day precipitation. If the forecast would be perfect, all values would form a horizontal line on the x-axis. However, from this plot we can see that CHIRPS-GEFS has the tendency to overpredict low amount of rainfall, while underpredicting high amounts of rainfall. Since we are interested in the extreme low amount of rainfall, this fact can be problematic for the forecasting skill of dry spells. 

### CHIRPS-GEFS to forecast dry spells
Besides the bias, the forecast might be good enough to detect dry spells. We define a dry spell as "detected", if any part of the observed dry spell overlaps with any part of the forecasted dry spell. Thus, this is a very loose definition. First, a forecasted dry spell was defined as a forecast projecting less than 2mm of cumulative rainfall, i.e. the same definition as for the observed dry spells. Additionally, we tested several higher thresholds, since as we saw CHIRPS-GEFS has the tendency to overpredict observed numbers. From this we can see that [Only write once final definition of dry spell]


