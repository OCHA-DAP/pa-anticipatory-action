---
title: "Forecasting dry Spells in Malawi"
author: "By Centre for Humanitarian Data"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
editor_options:
  chunk_output_type: inline
bibliography: ["mwi_bibliography.bib"]
biblio-style: "apalike"
link-citations: true
---

## Background
This document summaries all the data work that has been done to inform the trigger mechanism for OCHA Anticipatory Action pilot in Malawi related to dry spells. It explores the historical dry spells, relations with seasonal observed indicators, and the skill of short-term forecast to predict these dry spells. All work presented here has been done by the Centre for Humanitarian Data, but with indispensable help from technical partners. All the code is openly available [here](https://github.com/OCHA-DAP/pa-anticipatory-action), and will regularly be referred to in this document. 

## Historical dry spells 
We identified, for each district (n = 32), all dry spells that occurred during their rainy season. To do so we identified the onset and cessation date of the rainy season for each district and every year. We report on the characteristics of the rainy seasons as well as the dry spells.

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
source("historical_dry_spells_description_setup.R")
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = FALSE) # do not print output by default
```

```{r data-load-formatting}
data_dir <- Sys.getenv("AA_DATA_DIR") # AA_DATA_DIR is set as a variable in .Renviron or .bashprofile
plot_dir <-paste0(data_dir,'/processed/malawi/plots/dry_spells')
rainy_seasons_detail <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/rainy_seasons_detail_2000_2020_mean_back.csv"))
dry_spells_during_rainy_season_list <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/dry_spells_during_rainy_season_list_2000_2020_mean_back.csv"))

rainy_seasons_detail$onset_date <- as.Date(rainy_seasons_detail$onset_date, format = "%Y-%m-%d")
rainy_seasons_detail$cessation_date <- as.Date(rainy_seasons_detail$cessation_date, format = "%Y-%m-%d")

rainy_seasons_detail <- rainy_seasons_detail %>%
  mutate(region = substr(pcode, 3, 3)) %>% mutate(region = ifelse(region == 3, "Southern", ifelse(region == 2, "Central", "Northern")))
```

### Data Source
We chose to use CHIRPS as data source of historical precipitation. Different data sets exist, but among those that we had access to CHIRPS generally shows good accuracy in Malawi [@zhao2019evaluating]. We used the CHIRPS data between 1 Jan 2000 and 31 Dec 2020 at 0.05-degree resolution. 

### Definitions
Many different definitions of a dry spell, rainy day, rainy season onset, and rainy season cessation exist. The following definitions were used in the current analysis, based on literature and consultation with partners.

**Dry spells:** At least 14 consecutive days with a total rainfall less than 2 mm during the rainy season in an ADMIN2 region.

**Rainy day:** At least 4mm of rainfall on a calendar day (DCCMS 2008).

**Rainy season onset:** First day of a period after 1 Nov with at least 40mm of rain over 10 days AND no 10 consecutive days with less than 2mm of total rain in the following 30 days (DCCMS 2008).

**Rainy season cessation:** First day of a 15-day period after 15 March with 25mm or less of rain (DCCMS 2008).

**Rainy season duration:** Rainy season cessation date minus rainy season onset (in days).

### Methodology
[TODO: Do we also want to include the experimentation with different dry spell definitions? ]
The CHIRPS data is released as raster data, so we aggregated this to district (admin2) level, by extracting the mean value of all raster cells whose centre lied within the district. 
Different methodologies for aggregation from the raster cells to the admin areas were explored, which are further explained in [TODO: Add appendix]. It was chosen to compute the analysis on the district (admin2) level, since this gives a higher granularity for anticipatory actions than on region (admin1) level. Moreover, it was chosen to not go down to TA (admin3) level since the uncertainty of forecasts is too high to predict on such a small scale. 
Besides the admin level, a methodology has to be chosen to aggregate the raster cells to the desired admin level. It was chosen to use the mean of the raster cells within a district, since it ... [TODO: add if we finalize decision to use mean or pixel based]. 
Lastly, we also analyzed the detection of dry spells when allowing less than 2 mm per day instead of a total of 2mm over 14 days. This was done due to the tendency of CHIRPS, or satellite precipitation products in general, to overestimate low amounts (<0.1mm/day) of rainfall [dinku2011challenges]. Since we didn't see large differences in patterns, see appendix, we chose to stick to the original definition for this analysis. 

After we extracted the mean rain fallen within a district for every day over the last 20 years, we then computed the 10-day, 14-day, and 15-day rolling sums for each district. The earliest records in the dataset were assigned rolling sums of NA (non-applicable) until at least 10/14/15 records were available, respectively. Using these sums, the dry spells and rainy seasons were computed. 

"Total rainfall" was summed over the relevant period and rounded to the first decimal.

### Rainy Seasons

We identified the onset and cessation date of every rainy season between 2000 and 2020 for each district (n = 32). Rainy seasons are labelled after the year in which they begin. Seasons that began in the Fall of 1999 and 2020 are not reported on since the dataset only had partial data for them (since the dataset did not include 1999 data and the 2020 season is ongoing). We also note that the 2020 season in certain districts had not started or met our onset definition by 31 Dec 2020. 


``` {r rainy-seasons}

round(prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$onset_month), 1)*100, 1)

rainy_seasons_detail %>% mutate(onset_month = month.abb[rainy_seasons_detail$onset_month]) %>% with(., round(prop.table(table(ADM2_EN, onset_month), margin = 1)*100),1)

prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$cessation_month), 1)

rainy_seasons_summary_per_region <- rainy_seasons_detail %>%
                                      mutate(nov1 = as.Date(paste0(season_approx, '-11-01'), format = "%Y-%m-%d"), # 1 nov before the onset of the season
                                             onset_days_since_1nov = as.numeric(difftime(onset_date, nov1, units = "days")), # count of days since 1 nov
                                             cessation_days_since_1nov = as.numeric(difftime(cessation_date, nov1, units = "days")), # count of days since 1 nov
                                             rainy_season_at_least_125d = ifelse(rainy_season_duration >= 125, 1, 0)) %>% # 125 days is length of maize growing season
                                      group_by(region, ADM2_EN) %>%
                                      summarise(min_rainy_season_onset_post1nov = min(onset_days_since_1nov, na.rm = T), # na.rm to remove incomplete seasons
                                                max_rainy_season_onset_post1nov = max(onset_days_since_1nov, na.rm = T),
                                                mean_rainy_season_onset_post1nov = round(mean(onset_days_since_1nov, na.rm = T),1), # average nbr of days since 1 Nov
                                                min_rainy_season_cessation_post1nov = min(cessation_days_since_1nov, na.rm = T), 
                                                max_rainy_season_cessation_post1nov = max(cessation_days_since_1nov, na.rm = T),
                                                mean_rainy_season_cessation_post1nov = round(mean(cessation_days_since_1nov, na.rm = T),1), # average nbr of days since 1 Nov
                                                min_rainy_season_duration = min(rainy_season_duration, na.rm = T), 
                                                max_rainy_season_duration = max(rainy_season_duration, na.rm = T),
                                                mean_rainy_season_duration = round(mean(rainy_season_duration, na.rm = T),1),
                                                nbr_125d_seasons = sum(rainy_season_at_least_125d, na.rm = T),
                                                min_rainy_season_rainfall = min(rainy_season_rainfall, na.rm = T), 
                                                max_rainy_season_rainfall = max(rainy_season_rainfall, na.rm = T),
                                                mean_rainy_season_rainfall = round(mean(rainy_season_rainfall, na.rm = T),1)) %>%
                                      ungroup() %>%
                                      unique() %>%
                                      data.frame()

```

&nbsp;

#### Onsets
Based on our definition, rainy seasons started in Nov, Dec, Jan, or Feb.

```{r, include = T}

regions <- rainy_seasons_detail[,c('ADM2_EN', 'region')] %>% unique()
                     
as.data.frame(round(prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$onset_month), 1)*100, 1)) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  left_join(regions, by = c('Var1' = 'ADM2_EN')) %>% # bring back regions 
  rename(Region = region, District = Var1, Jan = `1`, Feb = `2`, Nov = `11`, Dec = `12`) %>%
  dplyr::select(Region, District, Nov, Dec, Jan, Feb) %>%
  arrange(Region, District) %>%
  knitr::kable(caption = "Rainy Season Onset Months (% of seasons)",
               align = c('l')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")
```

&nbsp;
&nbsp;


```{r}
# [TODO: Description of results on onset of rainy season. What is the variability across adm regions?]
```

```{r rainy-onset-table, include = T} 

rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_onset_post1nov, max_rainy_season_onset_post1nov, mean_rainy_season_onset_post1nov) %>%
  knitr::kable(caption = "Rainy Season Onsets (in Days Since 1 Nov)",
               col.names = c('Region','District', 'Earliest', 'Latest', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```

&nbsp;

#### Cessations


```{r}
#[TODO: Summary of cessation results.]
```

```{r rainy-cessation-table, include = T} 
rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_cessation_post1nov, max_rainy_season_cessation_post1nov, mean_rainy_season_cessation_post1nov) %>%
  knitr::kable(caption = "Rainy Season Cessations (in Days Since 1 Nov)",
               col.names = c('Region','District', 'Earliest', 'Latest', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```

&nbsp;

#### Durations

```{r}
#[TODO: Summary of rainy season duration results. Add boxplot]
```

```{r rainy-duration-table, include = T} 
rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_duration, max_rainy_season_duration, mean_rainy_season_duration, nbr_125d_seasons) %>%
  knitr::kable(caption = "Rainy Season Durations (in Days)",
               col.names = c('Region','District', 'Shortest', 'Longest', 'Mean', 'Nbr of 125+day Seasons'),
               align = c('l', 'l', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")


```

&nbsp;

#### Total rainfall
[TODO: add boxplot total rainfall per season]

### Dry Spells

A dry spell was included if at least 1 day on which the criterion was met fell during the rainy season. In other words, a dry spell was included when it overlapped with the rainy season, even if it started before or ended after it. The graph presents frequency over the years by region. A summary per district follows in table format.
[TODO: add heatmap]
&nbsp;

```{r dry-spells}

dry_spells_during_rainy_season_list <- dry_spells_during_rainy_season_list %>% mutate(region = substr(pcode, 3, 3)) %>% mutate(region = ifelse(region == 3, "Southern", ifelse(region == 2, "Central", "Northern")))

rainy_season_dry_spells_summary_per_region <- dry_spells_during_rainy_season_list %>% 
                                                group_by(region, pcode, ADM2_EN) %>%
                                                summarise(nbr_dry_spells = n(),
                                                          mean_ds_duration = round(mean(dry_spell_duration),1),
                                                          min_ds_duration = min(dry_spell_duration),
                                                          max_ds_duration = max(dry_spell_duration)
                                                          ) %>%
                                                ungroup() %>%
                                                as.data.frame()

rainy_season_dry_spells_summary_per_region <- merge(rainy_season_dry_spells_summary_per_region, regions, by.x = c('region', 'ADM2_EN'), by.y = c('region', 'ADM2_EN'), all.x = T, all.y = T) # ensure every region is in dataset
rainy_season_dry_spells_summary_per_region$nbr_dry_spells <- ifelse(is.na(rainy_season_dry_spells_summary_per_region$nbr_dry_spells), 0, rainy_season_dry_spells_summary_per_region$nbr_dry_spells) # replace NAs with 0 under nbr of dry spells

# relate dry spells freq and rainy season duration
x <- rainy_seasons_detail %>%
      mutate(nov1 = as.Date(paste0(season_approx, '-11-01'), format = "%Y-%m-%d"), # 1 nov before the onset of the season
            onset_days_since_1nov = as.numeric(difftime(onset_date, nov1, units = "days")), # count of days since 1 nov
            rainy_season_at_least_125d = ifelse(rainy_season_duration >= 125, 1, 0))%>%
      dplyr::select(region, ADM2_EN, season_approx, onset_days_since_1nov, rainy_season_at_least_125d)

y <- dry_spells_during_rainy_season_list %>% group_by(region, ADM2_EN, season_approx) %>% summarise(n = n())

z <- merge(x, y, by = c('region', 'ADM2_EN', 'season_approx'))

z %>% filter(n > 1)
table(z$rainy_season_at_least_125d, z$n)

```

```{r ds-freq-plot, include = T, warning = F, error = F, message = F}

# country-wide trends

year_list <- data.frame(year = lubridate::year(seq.Date(from = as.Date("2000-01-01"), to = as.Date("2020-12-31"), by = 'year')))
list_adm2_EN_region <- rainy_seasons_detail[,c('region', 'pcode', 'ADM2_EN')] %>% unique()
year_by_adm2_EN_region <- crossing(list_adm2_EN_region, year_list) # full list of adm2 * year along with region and ADM2_EN

trends <- dry_spells_during_rainy_season_list %>%
          mutate(season_approx = as.numeric(season_approx)) %>%
          right_join(year_by_adm2_EN_region,  by = c('region' = 'region', 'pcode' = 'pcode', 'ADM2_EN' = 'ADM2_EN', 'season_approx' = 'year')) %>%
          #left_join(dry_spells_during_rainy_season_list, by = c('region' = 'region', 'pcode' = 'pcode', 'ADM2_EN' = 'ADM2_EN', 'year' = 'season_approx')) %>% 
          dplyr::select(season_approx, region, ADM2_EN, dry_spell_first_date) %>%
          rename('Year' = 'season_approx', 'Region' = 'region') %>%
          group_by(Region, Year) %>%
          summarise(Count = sum(!is.na(dry_spell_first_date)))

ggplot(trends, aes(x=Year, y=Count, fill=Region)) + 
        geom_bar(stat="identity", width=0.7, position=position_dodge(width=0.8)) +
        scale_x_continuous(breaks= seq(min(trends$Year), max(trends$Year), by=1)) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle("Dry Spells Over the Past 20 Years")

# p + ggthemes::theme_economist()
```

```{r ds-stats-summary, include = T}

rainy_season_dry_spells_summary_per_region %>%
  dplyr::select(region, ADM2_EN, nbr_dry_spells, min_ds_duration, max_ds_duration, mean_ds_duration) %>%
  arrange(region, ADM2_EN) %>%
  knitr::kable(caption = "Dry Spells During Rainy Seasons",
               col.names = c('Region','District', 'Nbr of Dry Spells', 'Min', 'Max', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        add_header_above(c(" " = 3, "Duration" = 3)) %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")


```

&nbsp; 

#### Frequency


[TODO: Summary on frequency of dry spells]

[TODO: Adjust below comparison]


We note a convergence between these results and the Analysis of Predictable Food Crises in Malawi carried out in January 2020 by WFP. The analysis reported on the location, frequency and impact of dry spells at the Traditional Authority (TA; adm3) level in 2011-2019. Similar findings include:

* A single district has never experienced a dry spell while 5% (n = 15) of TAs did not. That is, some areas are unaffected or rarely affected by dry spells.

* Some districts have experienced dry spells regularly. While WFP's analysis reported yearly dry spells in certain TAs, our results indicate a recurrence of once every other year at the district level.

* The two observations above indicate that districts are not homogeneously affected by dry spells. An implication is that an Anticipatory Action Trigger developed at the adm2 level should have a threshold that is sensitive to the non-uniform return period within the district not to miss shocks only happening in a subset of TAs.

* The districts in the Southern region experienced the highest number of dry spells in total (n = 86) compared to the Central (n = 56) and Northern (n = 22) regions. That is, the Southern region is more likely to experience dry spells.


#### Duration

```{r}
#[TODO: Summary of duration of dry spells]
```

#### Timing

```{r}
#[TODO: Summary of timing results]
```

This may partly be due to our definition of rainy seasons. For onset, we require that a rainy streak not be followed by a 10-day period with less than 2mm rainfall in the next 30 days for the streak. Therefore by definition the first month of the rainy season cannot have dry spells. For cessation, once rainy days become rarer the criterion for cessation is likely to be met, ending the rainy season and the window during which dry spells are included in this analysis.

The breakdown by district is shown below.

```{r ds-timing-table}

# when did the dry spells start in each district?

timing_counts <- prop.table(table(dry_spells_during_rainy_season_list$ADM2_EN, lubridate::month(dry_spells_during_rainy_season_list$dry_spell_first_date)), 1)*100

as.data.frame(round(timing_counts, 1)) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  left_join(regions, by = c('Var1' = 'ADM2_EN')) %>% # bring back regions 
  rename(Region = region, District = Var1, Jan = `1`, Feb = `2`, Mar = `3`) %>%
  dplyr::select(Region, District, Jan, Feb, Mar) %>%
  arrange(Region, District) %>%
  knitr::kable(caption = "Dry Spell Onset Months (% of district's dry spells)",
               align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```
Month in which a dry spell started is a good proxy for when in the growing cycle it occurred. However it would be appropriate considering the frequent late rainy (and likely planting) season onsets to examine instead how many days in the planting season the dry spell started. 

Such an analysis would require a definition of Effective Planting Start such as WFP's (two consecutive 10-day periods with at least 20mm of rain each after 1 Nov) as well as definitions of the periods when crops are most vulnerable, likely within days of planting and during flowering (how many days after Day 1 of Effective Planting Start?)

&nbsp; 

### Addendum

#### Rainy Seasons 

Duration is reported in days and rainfall, in mm.

```{r addendum-rainy-seasons-detail, include = TRUE}
rainy_seasons_detail %>%
  dplyr::select(region, ADM2_EN, season_approx, onset_date, cessation_date, rainy_season_duration, rainy_season_rainfall) %>%
  arrange(ADM2_EN, season_approx) %>%
  rename(Region = region, District = ADM2_EN, Season = season_approx, Onset = onset_date, Cessation = cessation_date, Duration = rainy_season_duration, TotalRainfall = rainy_season_rainfall) %>%
  kbl(align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
    collapse_rows(columns = 1, valign = "top") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  fixed_thead = T) %>%
    scroll_box(width = "100%", height = "500px") %>%
    footnote(general = "Duration reported in days and Total Rainfall in mm. ")
```

&nbsp;

#### Dry Spells 

The complete list of dry spells is displayed below. Only dry spells that overlapped with the rainy season are included. Duration is reported in days and rainfall, in mm.

```{r addendum-dry-spells-during-rainy-season-list, include = TRUE}

dry_spells_during_rainy_season_list %>%
   dplyr::select(region, ADM2_EN, season_approx, dry_spell_first_date, dry_spell_last_date, dry_spell_duration, dry_spell_rainfall) %>%
        arrange(region, ADM2_EN, season_approx) %>%
        rename(Region = region, District = ADM2_EN, Season = season_approx, FirstDay = dry_spell_first_date, LastDay = dry_spell_last_date, Duration = dry_spell_duration, TotalRainfall = dry_spell_rainfall) %>%
          kbl(align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
          collapse_rows(columns = 1:2, valign = "top") %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                        fixed_thead = T) %>%
          scroll_box(width = "100%", height = "500px") %>%
          footnote(general = "Duration reported in days and Total Rainfall in mm. ")
        
```



## Correlation of dry spells and seasonal indicators
Optimally the pre-alert of the trigger could be based on indicators with a long lead time, preferable 3 to 6 months. This would give the possibility of a wider range of anticipatory actions to be implemented by the organizations in country. Most information provided with such a long lead time doesn't report directly the probability of dry spells in a certain location. They report a more general pattern, such as the ENSO state or the total precipitation over a 3 month period. Therefore, we explored whether these more broad properties that are forecasted well-ahead of the rainy season, do have a correlation with the occurrence of a dry spell. This analysis is thus solely looking at **observational** data, not at forecasts. If the correlations between these observed data sources turn out to be significant, we move to forecasts. This with the assumption that if there is no such correlation in the observed data, there won't be any in the forecasted data. 

### Previous work
The body of literature on the relation between long-term meteorological indicators and the occurence of dry spells in Malawi is rather limited. We are aware of two articles who investigated the correlation of dry spells in Malawi with ENSO, and 3-monthly precipitation, as well as temperature, wind speed, and wind direction. 
@mittal2021co investigated the correlation with total precipitation in a 3-month period and the occurrence of a prolonged dry spell in Malawi. This work defines a dry spell as 14 consecutive dry days, where a dry day is a day with <=2mm of precipitation. They found that there was only a weak correlation between the occurrence of a dry spell and the total 3-monthly precipitation, where again the strength of the correlation heavily depended on the location. 
@streefkerk2020linking looked at the correlation between 5-day long dry spells and the meteorological indicators of temperature, wind speed, wind direction and ENSO strength. It should be noted that 5-day long dry spells is a significantly different phenomenon than 14-day long dry spells, and thus results might not be transferable.  She showed that the chosen indicators do have some predictive value for the occurrence of the 5-day dry spells, while these correlations heavily depend on the location. Moreover, the analysis suggests that the while the ENSO phenomenon has predictive value for overall drought, it is less decisive for the occurrence of dry spells, as these are more local events. 

### ENSO state
A commonly used long-term meteorological indicator is the El Niño Southern Oscillation (ENSO) state. This state is a global phenomenon, that causes seasonal climatological fluctuations and is related to Sea Surface Temperatures (SSTs). More background on the ENSO phenomenon can be found [here](https://iri.columbia.edu/our-expertise/climate/enso/). Our analysis explores the correlation with the observed ENSO state and the occurence of a prolonged dry spell. 

Several different indicators exist to measure the ENSO state, of which most are indicated [here](https://www.psl.noaa.gov/enso/dashboard.html). The two indicators most commonly used are the NINO3.4 index and ONI. They use slightly different sources of data and aggregation methodologies, but show similar historical patterns. For our analysis it was chosen to use ONI, as their data is commonly used to keep track of the current ENSO state. 
<!-- Nevertheless, both indicators could be used here but no large differences in results are expected.  -->

#### Data source
ONI is reported as a running mean over a 3-month period. Open data exists from 1950 till present. Warm periods are defined as an ONI larger or equal to 0.5, while cold periods are defined as an ONI smaller or equal to -0.5. If 5 or more consecutive overlapping periods reach the threshold for a warm period, these seasons are defined as experiencing El Niño state. As you might guessed, 5 or more consecutive overlapping periods that reach the threshold for a cold period, are defined as experiencing La Niña state. All other seasons are defined as the neutral state. 

#### Methodology
For each 3 month period, an ENSO state was assigned to the ONI data based on the definition as described above. 
A 3-month period was marked as having experienced a dry spell if a dry spell started during the middle-month of that 3-month period. I.e. if a dry spell started on 15-03-2010, the FMA 2010 season was indicated to have experienced a dry spell. 
Moreover, for part of the analysis the dominant ENSO state over the rainy season was computed, which was defined as the most common state from the SON till MAM season
TODO: might want to change this to months where some time in the past a dry spell occured!! 

#### Analysis
TODO have to clean-up code to do this properly but
- Include plot of dominant state and percentage of seasons experiencing a dry spell
- same plot but per 3month period
- boxplot with ONI anomaly

#### Results

#### Forecasts
Due to not seeing a relationship between observed ENSO state and dry spells, we didn't move on to analyze the forecasts with the assumption that this relationship will only be weaker. For those interested in the forecasts, the most commonly used forecasts is the one [produced by IRI](https://iri.columbia.edu/our-expertise/climate/forecasts/enso/current/), of which the [historical data](https://iri.columbia.edu/~forecast/ensofcst/Data/) can also be downloaded. 

<!-- #### Data used -->
<!-- [ONI data](https://www.cpc.ncep.noaa.gov/data/indices/oni.ascii.txt) -->
<!-- Observed dry spells -->

<!-- #### Scripts -->
<!-- Due to circumstances, we derived the values manually from [NOAA's table](https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php), but they are also [available as txt for download](https://www.cpc.ncep.noaa.gov/data/indices/oni.ascii.txt).  -->
<!-- Processing script -->


### Seasonal precipitation
Another commonly used forecast source with a long lead time are the so-called seasonal forecasts. Here a season is defined as a 3 month period. Seasonal precipitation forecasts are an often used product for informing predictions related to seasonal drought, and depending on the source include forecasts for 1 to 6 months ahead. 

Seasonal precipitation forecasts exist in different formats. The most common format is that of a tercile-based forecasts,where the three terciles are referred to as below-average, normal, and above-average precipitation. These tercile-based forecasts report the probability for the precipitation to be in each tercile, per raster cell. See [here] for a clear resource on the definition of a tercile-based forecast. The Malawi Met services (DCCMS) provide their forecast in this format, as well as global organizations such as IRI and NMME. While we do investigate the relationship of dry spells with seasonal below-average precipitation, by definition the occurrence of below-average precipitation is not expected to have a strong relation with dry spells. This is the case for two reasons, namely 1) below-average precipitation occurs on average once every three years, while dry spells are a more extreme event (as we saw in the historical dry spell analysis) and 2) the amount of rainfall that is classified as "below-average" depends on the average rainfall for the given location. The tercile is thus location dependent, whereas the definition of a dry spell is based on an absolute number of millimeters and thus doesn't depend on the location. 

Some organizations also provide absolute forecasted amounts, either as an expected amount per day or per month. The main organizations providing this data are ECMWF and the UK Met office. From the daily projected amounts, one could in theory directly forecast the occurrence of a dry spell. However, since those forecasts have such a large uncertainty, it is very unlikely that the forecast will predict the occurrence of a dry spell by calendar day. Nevertheless, you can come up with other aggregated measures that might correlate with the occurrence of a dry spell. In this analysis we investigated the relationship of dry spells with total monthly and total seasonal precipitation. 

#### Data source
CHIRPS was used as data source to compute the monthly and 3-monthly total precipitation, and the occurrences of 3-monthly below-average precipitation. CHIRPS was chosen as data source, since this is the same source as was used to detect observed dry spells and thus thereby we eliminate any weakening of relationship due to biases in different sources. See for more information about CHIRPS the section on defining observed dry spells. 

#### Methodology
We work with the monthly sum of precipitations as directly provided by CHC on their FTP server. We compute the 3-monthly sum from this per raster cell and aggregate this to admin2 level by [.... set aggregation method]. Whether a cell had below-average precipitation, is information that is not readily available, and thus we had to compute this ourselves. [This notebook] shows and explains all the steps taken to do so. Once we had the information whether a raster cell had below-average precipitation or not in a given season, we also aggregated this information to admin2 level.

For the aggregation to admin2 level, we used a percentage-based approach since whether a raster cell had below-average precipitation is a binary variable, and thus taking the mean would not be approriate here. We therefore classified an admin2 having observed below-average precipitaiton if at least 50% of the raster cells received below-average precipitation

A 3-month period was assigned as having experienced a dry spell if a dry spell started during any of the 3 months in the given admin2.  

#### Seasonal below-average precipitation
Below the confusion matrix is shown, which indicates the co-occurence of dry spells and below-average precipitation. As can be seen this co-occurence is not great. Only 55% (52/94) of the seasons with a dry spell also had below-average precipitation. Moreover, there were many 3-month periods with below-average precipitation but during which no dry spell occured. To be more precise this was the case in 89% of the below-average periods. Further analysis was done to determine if better correlations occur in certain admin2's or during specific periods. This analysis didn't show a significantly stronger signal, but for the curiously-minded the full analysis can be found here. 

Based on this confusion matrix and the other analyses, we conclude that the occurence of below-average precipitation is not a good indicator for the likelihood of a dry spell occuring. We therefore didn't move on to analyze the performance of seasonal forecasts instead of observations. 

![seasonal below average precipitation confusion matrix](`r paste0(plot_dir,'/seasonal/seasonal_below_average_confusionmatrix.png')`)

#### Total seasonal precipitation
As we saw dry spells are more extreme than below-average precipitaiton. Therefore, a better correlation might be found if we define a threshold ourselves of the maximum precipitation (in mm) instead. We investigated different thresholds and the ability to detect dry spells. As can be seen ... [Include the graph Josee made for the presentation]

#### Total monthly precipitation
<!-- #### Scripts -->
<!-- Computing the below average and aggregating -->
<!-- Correlations below average -->
<!-- Correlations total rainfall -->

<!-- #### Data sources used -->
<!-- CHIRPS -->
<!-- Shapefiles -->

<!-- #### TODO -->
<!-- Check format UK Met office (paper, email, ECMWF) --> same as ECMWF but Met office generally wants to adjust their products to the use case..  -->
<!-- Add flexible forecast IRI once understood better -->

#### Future
Number of dry days during a month

<!-- ### Monthly precipitation forecasts -->
<!-- Besides forecasted quantities over a 3-month period, one can also look at these quantities over a monthly period. This quantity is reported by a few seasonal forecasts, and might be a better indicator for the occurence of a dry spell than the precipitation over a 3-month period  -->
<!-- We are not aware of any suitable, openly available subseasonal forecasts, but we could possibly use the seasonal forecasts that also provide values per month.  -->


<!-- List of available forecasts -->
<!-- Seasonal timescale -->
<!-- Seasonal tercile - IRI, NMME, ECMWF, NMA -->
<!-- Daily seasonal - ECMWF -->
<!-- Monthly seasonal - ECMWF -->

<!-- Monthly timescale -->
<!-- SubX - too experimental  -->
<!-- S2S - Ask IRI -- dont see precipitation on ECMWF website? -->

## Forecasting of dry spells
As described in the previous section, the long-term indicators were shown to not have a strong correlation with the occurrence of a dry spell. We therefore move on to look at forecasts that can directly forecast dry spells, instead of predicting other indicators such as the ENSO state. Since forecasting skill generally decreases as the lead time decreases, the first forecast that was analyzed was that with the shortest lead time, namely 15 days ahead. This would mean that at the start of a dry spell, the alert could be triggered. 

#### Previous work
We are not aware of any work attempting to forecast prolonged dry spells in Malawi. 
Moving away from Malawi, @gbangou2020rainfall researched the predictability of dry spells in Ghana. They analyze how well the forecasts can predict the number of dry spells within a season, where a dry spell is defined as at least 5 consecutive days with less than 1mm of rainfall per day. Moreover, they try to forecast the length of the longest dry spell. For the forecasting, ECMWF's seasonal forecast as well as a statistical model based on Sea Surface Temperatures (SST) is used. They show that skill of these two forecasts depend on the lead time and location. However, the found correlations are generally weak. Interestingly, the forecasts do show to be better at predicting the extreme years, though the correlations are still not strong. Nevertheless, they argue that the forecasts have better skill than guessing based on climatologies and thus can be used to inform actions.
Similar work has been done by @surmaini2021use, but focusing on Indonesia and using NOAA's CFSv2 seasonal forecast model. They showed a bit higher correlations, again also showing that these correlations heavily depend on location. Due to a completely different climate, these results are not directly transferable to Malawi. 

<!-- ### Geographical scale -->
<!-- Analysis done on ADM2  -->

<!-- ### Historical analysis -->
<!-- Dry spells [Include full dry spell analysis here or in a separate notebook?] -->
<!-- Seasonal indicators -->
<!-- While the focus of this analysis is on dry spells, we also conducted an analysis on a few key seasonal parameters which are often related to seasonal drought. The purpose of this analysis is to understand the generic patterns across the years in Malawi better, and also get a quick feel for if they show the same pattern as the observed dry spells.  -->
<!-- [Include once aggregation methodology decided...] -->



#### The data
Several organizations produce forecasts with a 15-day lead time, but most of them are not openly available. For this analysis, we used CHIRPS-GEFS. This is a forecast produced by GEFS, and bias-corrected to the CHIRPS data. This forecast was chosen because it is openly available, has a long historical record, is well-acknowledged, and is bias-corrected to the same data that was used to determine observed dry spells. CHIRPS-GEFS is available as raster data at 0.05 resolution. A forecast is produced each day, and these forecasts are available from 2000 till present, with a data gap in 2020. Each forecast indicates the projected cumulative precipitation during the next 15 days per raster cell. 

#### Methodology
For each forecast, the raster cell values were aggregated to admin2 [by.....]

#### Bias of CHIRPS-GEFS
We first analyzed the general performance of CHIRPS-GEFS, by computing a bias plot. This plot shows the observed precipitation over 15 days per admin2, retrieved from CHIRPS data, and on the y-axis the forecasted minus observed 15-day precipitation. If the forecast would be perfect, all values would form a horizontal line on the x-axis. However, from this plot we can see that CHIRPS-GEFS has the tendency to overpredict low amount of rainfall, while underpredicting high amounts of rainfall. Since we are interested in extremely low amounts of rainfall, this fact can be problematic for the forecasting skill of dry spells. 

![seasonal below average precipitation confusion matrix](`r paste0(plot_dir,'/chirps_gefs/plot_mwi_chirpsgefs_15days_density.png')`)

#### CHIRPS-GEFS to forecast dry spells
Besides the bias, the forecast might be good enough to detect dry spells. We define a dry spell as "detected", if any part of the observed dry spell overlaps with any part of the forecasted dry spell. Thus, this is a very loose definition. First, a forecasted dry spell was defined as a forecast projecting less than 2mm of cumulative rainfall, i.e. the same definition as for the observed dry spells. Additionally, we tested several higher thresholds, since as we saw CHIRPS-GEFS has the tendency to overpredict observed numbers. From this we can see that [Only write once final definition of dry spell]

## Real-time observation of dry spells
Chirps vs ARC2

## References