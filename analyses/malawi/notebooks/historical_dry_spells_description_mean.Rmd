---
title: "Dry Spells in Malawi"
author: "By Centre for Humanitarian Data"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

### Background
This is a descriptive summary of the groundtruth dataset of dry spells in Malawi that was created to inform the OCHA Anticipatory Action pilot. More information about the trigger mechanism for OCHA Anticipatory Action in Malawi or the computation of the dataset can be found [here](https://github.com/OCHA-DAP/pa-anticipatory-action).

We identified, for each district (n = 32), all dry spells that occurred during their rainy season. To do so we identified the onset and cessation date of the rainy season for each district and every year. We report on the characteristics of the rainy seasons as well as the dry spells.

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
source("historical_dry_spells_description_setup.R")
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = FALSE) # do not print output by default
```

```{r data-load-formatting}
data_dir <- Sys.getenv("AA_DATA_DIR") # AA_DATA_DIR is set as a variable in .Renviron or .bashprofile
rainy_seasons_detail <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/rainy_seasons_detail_2000_2020_mean_back.csv"))
dry_spells_during_rainy_season_list <- read.csv(file = paste0(data_dir, "/processed/malawi/dry_spells/dry_spells_during_rainy_season_list_2000_2020_mean_back.csv"))

rainy_seasons_detail$onset_date <- as.Date(rainy_seasons_detail$onset_date, format = "%Y-%m-%d")
rainy_seasons_detail$cessation_date <- as.Date(rainy_seasons_detail$cessation_date, format = "%Y-%m-%d")

rainy_seasons_detail <- rainy_seasons_detail %>%
  mutate(region = substr(pcode, 3, 3)) %>% mutate(region = ifelse(region == 3, "Southern", ifelse(region == 2, "Central", "Northern")))
```

### Data Source
We analysed the CHIRPS global daily datasets between 2000 and 2020 (5-degree resolution) at the district (admin2) level.

### Methodology
We extracted the mean rain fallen within a district for every day between 1 Jan 2000 and 31 Dec 2020 (by selecting raster cells whose centre lied within the district). 

We then computed the 10-day, 14-day, and 15-day rolling sums for each district. The earliest records in the dataset were assigned rolling sums of NA (non-applicable) until at least 10/14/15 records were available, respectively. 

"Total rainfall" was summed over the relevant period and rounded to the first decimal.

### Definitions

**Dry spells:** At least 14 consecutive days with a total rainfall less than 2 mm during the rainy season in an ADMIN2 region.

**Rainy day:** At least 4mm of rainfall on a calendar day (DCCMS 2008).

**Rainy season onset:** First day of a period after 1 Nov with at least 40mm of rain over 10 days AND no 10 consecutive days with less than 2mm of total rain in the following 30 days (DCCMS 2008).

**Rainy season cessation:** 25mm or less of rain in 15 days after 15 March (DCCMS 2008).

**Rainy season duration:** Rainy season cessation date minus rainy season onset (in days).

### Rainy Seasons

We identified the onset and cessation date of every rainy season between 2000 and 2020 for each district (n = 32). Rainy seasons are labelled after the year in which they begin. Seasons that began in the Fall of 1999 and 2020 are not reported on since the dataset only had partial data for them (since the dataset did not include 1999 data and the 2020 season is ongoing). We also note that the 2020 season in certain districts had not started or met our onset definition by 31 Dec 2020. 


``` {r rainy-seasons}

round(prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$onset_month), 1)*100, 1)

rainy_seasons_detail %>% mutate(onset_month = month.abb[rainy_seasons_detail$onset_month]) %>% with(., round(prop.table(table(ADM2_EN, onset_month), margin = 1)*100),1)

prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$cessation_month), 1)

rainy_seasons_summary_per_region <- rainy_seasons_detail %>%
                                      mutate(nov1 = as.Date(paste0(season_approx, '-11-01'), format = "%Y-%m-%d"), # 1 nov before the onset of the season
                                             onset_days_since_1nov = as.numeric(difftime(onset_date, nov1, units = "days")), # count of days since 1 nov
                                             cessation_days_since_1nov = as.numeric(difftime(cessation_date, nov1, units = "days")), # count of days since 1 nov
                                             rainy_season_at_least_125d = ifelse(rainy_season_duration >= 125, 1, 0)) %>% # 125 days is length of maize growing season
                                      group_by(region, ADM2_EN) %>%
                                      summarise(min_rainy_season_onset_post1nov = min(onset_days_since_1nov, na.rm = T), # na.rm to remove incomplete seasons
                                                max_rainy_season_onset_post1nov = max(onset_days_since_1nov, na.rm = T),
                                                mean_rainy_season_onset_post1nov = round(mean(onset_days_since_1nov, na.rm = T),1), # average nbr of days since 1 Nov
                                                min_rainy_season_cessation_post1nov = min(cessation_days_since_1nov, na.rm = T), 
                                                max_rainy_season_cessation_post1nov = max(cessation_days_since_1nov, na.rm = T),
                                                mean_rainy_season_cessation_post1nov = round(mean(cessation_days_since_1nov, na.rm = T),1), # average nbr of days since 1 Nov
                                                min_rainy_season_duration = min(rainy_season_duration, na.rm = T), 
                                                max_rainy_season_duration = max(rainy_season_duration, na.rm = T),
                                                mean_rainy_season_duration = round(mean(rainy_season_duration, na.rm = T),1),
                                                nbr_125d_seasons = sum(rainy_season_at_least_125d, na.rm = T),
                                                min_rainy_season_rainfall = min(rainy_season_rainfall, na.rm = T), 
                                                max_rainy_season_rainfall = max(rainy_season_rainfall, na.rm = T),
                                                mean_rainy_season_rainfall = round(mean(rainy_season_rainfall, na.rm = T),1)) %>%
                                      ungroup() %>%
                                      unique() %>%
                                      data.frame()

```

&nbsp;

#### Onsets
Based on our definition, rainy seasons started in Nov, Dec, Jan, or Feb.

```{r, include = T}

regions <- rainy_seasons_detail[,c('ADM2_EN', 'region')] %>% unique()
                     
as.data.frame(round(prop.table(table(rainy_seasons_detail$ADM2_EN, rainy_seasons_detail$onset_month), 1)*100, 1)) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  left_join(regions, by = c('Var1' = 'ADM2_EN')) %>% # bring back regions 
  rename(Region = region, District = Var1, Jan = `1`, Feb = `2`, Nov = `11`, Dec = `12`) %>%
  dplyr::select(Region, District, Nov, Dec, Jan, Feb) %>%
  arrange(Region, District) %>%
  knitr::kable(caption = "Rainy Season Onset Months (% of seasons)",
               align = c('l')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")
```

&nbsp;
&nbsp;


[TODO: Description of results on onset of rainy season. What is the variability across adm regions?]

```{r rainy-onset-table, include = T} 

rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_onset_post1nov, max_rainy_season_onset_post1nov, mean_rainy_season_onset_post1nov) %>%
  knitr::kable(caption = "Rainy Season Onsets (in Days Since 1 Nov)",
               col.names = c('Region','District', 'Earliest', 'Latest', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```

&nbsp;

#### Cessations

[TODO: Summary of cessation results.]

```{r rainy-cessation-table, include = T} 
rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_cessation_post1nov, max_rainy_season_cessation_post1nov, mean_rainy_season_cessation_post1nov) %>%
  knitr::kable(caption = "Rainy Season Cessations (in Days Since 1 Nov)",
               col.names = c('Region','District', 'Earliest', 'Latest', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```

&nbsp;

#### Durations

[TODO: Summary of rainy season duration results.]

```{r rainy-duration-table, include = T} 
rainy_seasons_summary_per_region %>%
  dplyr::select(region, ADM2_EN, min_rainy_season_duration, max_rainy_season_duration, mean_rainy_season_duration, nbr_125d_seasons) %>%
  knitr::kable(caption = "Rainy Season Durations (in Days)",
               col.names = c('Region','District', 'Shortest', 'Longest', 'Mean', 'Nbr of 125+day Seasons'),
               align = c('l', 'l', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")


```

&nbsp;

### Dry Spells

A dry spell was included if at least 1 day on which the criterion was met fell during the rainy season. In other words, a dry spell was included when it overlapped with the rainy season, even if it started before or ended after it. The graph presents frequency over the years by region. A summary per district follows in table format.

&nbsp;

```{r dry-spells}

dry_spells_during_rainy_season_list <- dry_spells_during_rainy_season_list %>% mutate(region = substr(pcode, 3, 3)) %>% mutate(region = ifelse(region == 3, "Southern", ifelse(region == 2, "Central", "Northern")))

rainy_season_dry_spells_summary_per_region <- dry_spells_during_rainy_season_list %>% 
                                                group_by(region, pcode, ADM2_EN) %>%
                                                summarise(nbr_dry_spells = n(),
                                                          mean_ds_duration = round(mean(dry_spell_duration),1),
                                                          min_ds_duration = min(dry_spell_duration),
                                                          max_ds_duration = max(dry_spell_duration)
                                                          ) %>%
                                                ungroup() %>%
                                                as.data.frame()

rainy_season_dry_spells_summary_per_region <- merge(rainy_season_dry_spells_summary_per_region, regions, by.x = c('region', 'ADM2_EN'), by.y = c('region', 'ADM2_EN'), all.x = T, all.y = T) # ensure every region is in dataset
rainy_season_dry_spells_summary_per_region$nbr_dry_spells <- ifelse(is.na(rainy_season_dry_spells_summary_per_region$nbr_dry_spells), 0, rainy_season_dry_spells_summary_per_region$nbr_dry_spells) # replace NAs with 0 under nbr of dry spells

# relate dry spells freq and rainy season duration
x <- rainy_seasons_detail %>%
      mutate(nov1 = as.Date(paste0(season_approx, '-11-01'), format = "%Y-%m-%d"), # 1 nov before the onset of the season
            onset_days_since_1nov = as.numeric(difftime(onset_date, nov1, units = "days")), # count of days since 1 nov
            rainy_season_at_least_125d = ifelse(rainy_season_duration >= 125, 1, 0))%>%
      dplyr::select(region, ADM2_EN, season_approx, onset_days_since_1nov, rainy_season_at_least_125d)

y <- dry_spells_during_rainy_season_list %>% group_by(region, ADM2_EN, season_approx) %>% summarise(n = n())

z <- merge(x, y, by = c('region', 'ADM2_EN', 'season_approx'))

z %>% filter(n > 1)
table(z$rainy_season_at_least_125d, z$n)

```

```{r ds-freq-plot, include = T, warning = F, error = F, message = F}

# country-wide trends

year_list <- data.frame(year = lubridate::year(seq.Date(from = as.Date("2000-01-01"), to = as.Date("2020-12-31"), by = 'year')))
list_adm2_EN_region <- rainy_seasons_detail[,c('region', 'pcode', 'ADM2_EN')] %>% unique()
year_by_adm2_EN_region <- crossing(list_adm2_EN_region, year_list) # full list of adm2 * year along with region and ADM2_EN

trends <- dry_spells_during_rainy_season_list %>%
          mutate(season_approx = as.numeric(season_approx)) %>%
          right_join(year_by_adm2_EN_region,  by = c('region' = 'region', 'pcode' = 'pcode', 'ADM2_EN' = 'ADM2_EN', 'season_approx' = 'year')) %>%
          #left_join(dry_spells_during_rainy_season_list, by = c('region' = 'region', 'pcode' = 'pcode', 'ADM2_EN' = 'ADM2_EN', 'year' = 'season_approx')) %>% 
          dplyr::select(season_approx, region, ADM2_EN, dry_spell_first_date) %>%
          rename('Year' = 'season_approx', 'Region' = 'region') %>%
          group_by(Region, Year) %>%
          summarise(Count = sum(!is.na(dry_spell_first_date)))

ggplot(trends, aes(x=Year, y=Count, fill=Region)) + 
        geom_bar(stat="identity", width=0.7, position=position_dodge(width=0.8)) +
        scale_x_continuous(breaks= seq(min(trends$Year), max(trends$Year), by=1)) +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
        ggtitle("Dry Spells Over the Past 20 Years")

# p + ggthemes::theme_economist()
```

```{r ds-stats-summary, include = T}

rainy_season_dry_spells_summary_per_region %>%
  dplyr::select(region, ADM2_EN, nbr_dry_spells, min_ds_duration, max_ds_duration, mean_ds_duration) %>%
  arrange(region, ADM2_EN) %>%
  knitr::kable(caption = "Dry Spells During Rainy Seasons",
               col.names = c('Region','District', 'Nbr of Dry Spells', 'Min', 'Max', 'Mean'),
               align = c('l', 'l', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        add_header_above(c(" " = 3, "Duration" = 3)) %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")


```

&nbsp; 

#### Frequency

[TODO: Summary on frequency of dry spells]

[TODO: Adjust below comparison]

We note a convergence between these results and the Analysis of Predictable Food Crises in Malawi carried out in January 2020 by WFP. The analysis reported on the location, frequency and impact of dry spells at the Traditional Authority (TA; adm3) level in 2011-2019. Similar findings include:

* A single district has never experienced a dry spell while 5% (n = 15) of TAs did not. That is, some areas are unaffected or rarely affected by dry spells.

* Some districts have experienced dry spells regularly. While WFP's analysis reported yearly dry spells in certain TAs, our results indicate a recurrence of once every other year at the district level.

* The two observations above indicate that districts are not homogeneously affected by dry spells. An implication is that an Anticipatory Action Trigger developed at the adm2 level should have a threshold that is sensitive to the non-uniform return period within the district not to miss shocks only happening in a subset of TAs.

* The districts in the Southern region experienced the highest number of dry spells in total (n = 86) compared to the Central (n = 56) and Northern (n = 22) regions. That is, the Southern region is more likely to experience dry spells.


#### Duration

[TODO: Summary of duration of dry spells]


#### Timing

[TODO: Summary of timing results]

This may partly be due to our definition of rainy seasons. For onset, we require that a rainy streak not be followed by a 10-day period with less than 2mm rainfall in the next 30 days for the streak. Therefore by definition the first month of the rainy season cannot have dry spells. For cessation, once rainy days become rarer the criterion for cessation is likely to be met, ending the rainy season and the window during which dry spells are included in this analysis.

The breakdown by district is shown below.

```{r ds-timing-table}

# when did the dry spells start in each district?

timing_counts <- prop.table(table(dry_spells_during_rainy_season_list$ADM2_EN, lubridate::month(dry_spells_during_rainy_season_list$dry_spell_first_date)), 1)*100

as.data.frame(round(timing_counts, 1)) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  left_join(regions, by = c('Var1' = 'ADM2_EN')) %>% # bring back regions 
  rename(Region = region, District = Var1, Jan = `1`, Feb = `2`, Mar = `3`) %>%
  dplyr::select(Region, District, Jan, Feb, Mar) %>%
  arrange(Region, District) %>%
  knitr::kable(caption = "Dry Spell Onset Months (% of district's dry spells)",
               align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
        collapse_rows(columns = 1, valign = "top") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                      fixed_thead = T) %>%
        scroll_box(width = "100%", height = "500px")

```
Month in which a dry spell started is a good proxy for when in the growing cycle it occurred. However it would be appropriate considering the frequent late rainy (and likely planting) season onsets to examine instead how many days in the planting season the dry spell started. 

Such an analysis would require a definition of Effective Planting Start such as WFP's (two consecutive 10-day periods with at least 20mm of rain each after 1 Nov) as well as definitions of the periods when crops are most vulnerable, likely within days of planting and during flowering (how many days after Day 1 of Effective Planting Start?)

&nbsp; 

### Addendum

#### Rainy Seasons 

Duration is reported in days and rainfall, in mm.

```{r addendum-rainy-seasons-detail, include = TRUE}
rainy_seasons_detail %>%
  dplyr::select(region, ADM2_EN, season_approx, onset_date, cessation_date, rainy_season_duration, rainy_season_rainfall) %>%
  arrange(ADM2_EN, season_approx) %>%
  rename(Region = region, District = ADM2_EN, Season = season_approx, Onset = onset_date, Cessation = cessation_date, Duration = rainy_season_duration, TotalRainfall = rainy_season_rainfall) %>%
  kbl(align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
    collapse_rows(columns = 1, valign = "top") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                  fixed_thead = T) %>%
    scroll_box(width = "100%", height = "500px") %>%
    footnote(general = "Duration reported in days and Total Rainfall in mm. ")
```

&nbsp;

#### Dry Spells 

The complete list of dry spells is displayed below. Only dry spells that overlapped with the rainy season are included. Duration is reported in days and rainfall, in mm.

```{r addendum-dry-spells-during-rainy-season-list, include = TRUE}

dry_spells_during_rainy_season_list %>%
   dplyr::select(region, ADM2_EN, season_approx, dry_spell_first_date, dry_spell_last_date, dry_spell_duration, dry_spell_rainfall) %>%
        arrange(region, ADM2_EN, season_approx) %>%
        rename(Region = region, District = ADM2_EN, Season = season_approx, FirstDay = dry_spell_first_date, LastDay = dry_spell_last_date, Duration = dry_spell_duration, TotalRainfall = dry_spell_rainfall) %>%
          kbl(align = c('l', 'l', 'c', 'c', 'c', 'c', 'c')) %>%
          collapse_rows(columns = 1:2, valign = "top") %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
                        fixed_thead = T) %>%
          scroll_box(width = "100%", height = "500px") %>%
          footnote(general = "Duration reported in days and Total Rainfall in mm. ")
        
```

