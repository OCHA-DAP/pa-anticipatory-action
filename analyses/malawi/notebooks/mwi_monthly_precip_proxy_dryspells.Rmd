---
title: "Monthly precipitation as a proxy for dry spells in Malawi"
author: "By Centre for Humanitarian Data"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
editor_options:
  chunk_output_type: inline
bibliography: ["mwi_bibliography.bib"]
biblio-style: "apalike"
link-citations: true
---
## Questions
- I am currently aggregating dry spells from admin2 to admin1, by saying if any of the admin2's experienced a dry spell, so did the admin1. Do you think this is a good methodology or should we take severity into account? 
  - Discussed with Josee: set severity such that it is approx a 1 in 3 year event --> remove occurences where <=3 adm2's had a dry spell
<!-- - Did you compute the 4mm/day outside the rainy season as well? -->
<!-- - Do we want to set the threshold to overlap as much as possible with the dry spells, or to be a one in three/five years event?  -->
<!--   - set dry spells to be one in three years event and then overlap as much as possible -->

### To do
- Remove occurrences of dry spells where <=3 adm2's within Southern region experienced a dry spell

## Background
Since previous work showed that it is difficult to forecast dry spells in Malawi, this document explores the option of using monthly precipitation as a proxy for the occurrence of dry spells and the forecasting skill for monthly precipitation. 
The precipitation patterns differ per region in Malawi. Since 41 out of 44 month-admin2 combinations with a dry spell occurred in the Southern region, this analysis solely focuses on this region to prevent weakening of signals due to the differences in climates between the regions.
<!-- All the code used to produce this analysis is openly available [here](https://github.com/OCHA-DAP/pa-anticipatory-action). -->

<!-- This work uses a list of historical dry spells and rainy seasons, that was also created as part of this project. Further information and analyses of the detection of these historical dry spells can be found [here](https://github.com/OCHA-DAP/pa-anticipatory-action/blob/develop/analyses/malawi/notebooks/historical_dry_spells_description_mean.html) -->


```{r setup, include = FALSE, message = FALSE, warning = FALSE}
source("historical_dry_spells_description_setup.R")
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = FALSE) # do not print output by default
```

```{r data-load-formatting}
data_dir <- Sys.getenv("AA_DATA_DIR") # AA_DATA_DIR is set as a variable in .Renviron or .bashprofile
plot_dir <-paste0(data_dir,'/public/processed/mwi/plots/dry_spells')
exploration_dry_spell_dir <- paste0(data_dir,'/public/exploration/mwi/dryspells/')
```

## Definitions
This analysis

- Only looks at the Southern region since almost all historical dry spells occurred in that region
- Only looks at the months of December, January, February since these months the crops are most sensitive to dry spells
- Defines a dry spell as at least 14 consecutive days with less than 2mm cumulative precipitation. The second part of the analysis compares this with a definition of at least 14 consecutive dry days, where a dry day is defined as receiving less than 4mm on one day. 
- Includes all dry spells, regardless of whether they occurred during the rainy season or not (only relevant for December)
- Classifies a month as having experienced a dry spell, if at least **7** days of that month were within a dry spell
- Aggregates historical dry spells and monthly precipitation to admin1 (Southern region), since precipitation forecasts have too much spatial uncertainty to forecast ad the admin2 level
- Computes the monthly precipitation as the mean value of all cells within the admin1
- Firstly computes the occurrence of a dry spell as the mean value of all cells within an admin2. Therafter, this is aggregated to admin1 by identifying it as a dry spell if at least one admin2 within the admin1 experienced a dry spell at that time.
- Classifies a match between monthly precipitation and a dry spell, if they occurred during the same month **and** in the same admin1.

## What is the monthly precipitation in months during which a dry spell occurred? 
The figure below shows the monthly precipitation, colored by whether a dry spell started during that month. 
From this figure we can see that 

1) Months with a dry spell do on average have less precipitation than the months during which no dry spell occurred
2) Nevertheless, some months with no dry spell also have precipitation in the same range as those months with a dry spell. 

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_distribution_facet_decjanfeb_southern_ds7_adm1.png')`)

We can see that precipitation patterns clearly differ by month, which is expected. Moreover, the figures show that the separability of the occurrence of a dry spell differs by month. This becomes more clear when looking at a boxplot

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_boxplot_decjanfeb_southern_ds7_adm1.png')`){width=50%}

## What is a sensible threshold for the amount of monthly precipitation? 
In order to use the monthly precipitation as a proxy for the occurence of a dry spell, we need to set a threshold on the amount of monthly precipitation. I.e. if the precipitation is forecasted to be lower than X, we trigger and else we don't. 

One method to get a sense for this, is by investigating a range of thresholds, and for each of them looking at the percentage of months with a dry spell that are below the threshold, and the percentage of months without a dry spell that are above the threshold. This is shown in the figure below. The figure shows that the trade-off between sensitivity and specificity depends on the month. Moreover, there is better separability during January and February than during December.    

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_threshold_decjanfeb_southern_ds7_adm1.png')`)

Since a trigger becomes too complex when setting a threshold for each month separately, we decide to set one threshold for all months. This is chosen by choosing the intersection of the two lines computed over all months, which is at 180mm. The graph below illustrates this. 

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_threshold_categorized_adm1.png')`)

## What is the co-occurrence of <=180 mm monthly precipitation and dry spells? 
To further understand the co-occurrence of low amounts of monthly precipitation and dry spells, it is important to look at the temporal distribution. To do so, the below figure shows a heatmap indicating the months with less than 180 mm of precipitation and the occurrence of dry spells. 
From this figure we can conclude that most dry spells overlap with most of <=180 mm, except a few occurrences in December and one in February 2002. It also becomes clear that <=180 mm monthly precipitation occurs in years that no dry spell was identified. Thus, with this threshold one would trigger more often than the occurrences of dry spells. 
<!-- From this figure it becomes clear that there were 5 periods during which many districts experienced a dry spell. During 4 out of those 5 periods, there was also less than 100 mm of monthly precipitation in most of the districts. The 5th period, during January 2010, received more rain (between 140 and 160 mm depending on the district).  -->
<!-- Moreover, we can see that there are several events where many districts received less than 100 mm of rainfall, but no dry spell was observed. These events mainly occur during March. -->

![](`r paste0(exploration_dry_spell_dir,'mwi_viz_hm_dry_spell_monthly_precip_mean_th180_adm1_southern_decjanfeb.png')`)

To conclude, the confusion matrix with a threshold of 180 mm is as follows. Thus 78% of the dry spells would be identified, and in 33% of the months with less than 180 mm of precipitation, a dry spell occurred. 

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_confusionmatrix_th180_adm1.png')`)


## Does a change in definition of a dry spell produce different results? 
Within this pilot, the accepted definition of a dry spell is that of <=2mm cumulative precipitation during 14 consecutive days. However, observational and forecast products often have trouble detecting such small amounts of rainfall and therefore many practitioners before us have defined dry spells based on dry days. Meaning that a dry spell consists of at least 14 consecutive dry days. The definition of a dry day differs between projects, but we take a commonly used definition of 4mm/day. 

We compute the same analysis with this different definition, and find that the optimal threshold is also at 180mm. As shown below. 

![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_threshold_categorized_adm1.png')`)

From the heatmap we can conclude that there are slightly more occurrences of dry spells than when allowing max 2mm of cumulative precipitation, which is as expected.    

NOTE: the missing of dry spells during December compared to the other definition, is due to the fact that with this definition only dry spells during the rainy season were included --> to be improved. 

![](`r paste0(exploration_dry_spell_dir,'mwi_viz_hm_dry_spell_monthly_precip_mean_4mm_th180_adm1_southern_decjanfeb.png')`)

When looking at the confusion matrix, we can see slightly more agreement. 90% of the dry spells would be identified, and in 43% of the months with less than 180 mm of precipitation, a dry spell occurred.   

NOTE: these numbers are missing the dry spells outside the rainy season, which will probably lower the 90%! 
![](`r paste0(plot_dir,'/seasonal/mwi_plot_monthly_precipitation_confusionmatrix_th180_4mm_adm1.png')`)

## How does the severity of dry spells differ? 
To support our discussion on severity, here is the heatmap on admin2 with <=2mm cumulative rainfall

![](`r paste0(exploration_dry_spell_dir,'mwi_viz_hm_dry_spell_mean_adm2_southern_decjanfeb.png')`)

<!-- ## Forecasts -->
<!-- This image shows the resolution of ECMWF's forecast. Due to the low resolution combined with the high uncertainy of long-term forecasts, we should look at admin1 and not admin2 -->

<!-- ![](`r paste0(exploration_dry_spell_dir,'ecmwf_forecast_resolution_mwi.png')`) -->