---
title: '<img src="https://drive.google.com/uc?id=118y5T73-iSUZoAMtoJGddxq9QzD_GDKX" style="height:40px;float:centre; margin:10px" /><img src="https://drive.google.com/uc?id=1fHQUzF3ZjaoHj9KQ33-94dK_X1hcmjzW" style="height:50px;float:centre; margin:10px" />'
pagetitle: 'Secondary Humanitarian Impacts of Ukraine Crisis' 
output:
  html_document:
    css: ../country_template/docs/style.css 
    includes:
      in_header: ../country_template/docs/header.html 
    df_print: paged
    toc: yes
    toc_float: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: console
---

***
Last updated: `r Sys.Date()`

## Key Messages
* Situation is degrading in Ukraine and elsewhere.
* Food insecurity is projected to increase in several countries including xyz


```{r setup, include = F}
library(tidyverse)
library(kableExtra)
library(zoo)
library(ggrepel)

knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(message = FALSE) 
knitr::opts_chunk$set(warning = FALSE)

data_dir <- Sys.getenv("AA_DATA_DIR")
ukr_data_folder_path <- paste0(data_dir, "/private/exploration/glb/ukr_crisis/")
ukr_inform_data_folder_path <- paste0(data_dir, "/private/exploration/glb/ukr_crisis/inform/")
ukr_data_filepath <- paste0(data_dir, "/private/exploration/glb/ukr_crisis/TEMP_ukr-secondary-impacts.csv")

```

```{r data-pulls}
data <- read.csv(ukr_data_filepath) # TEMP. TO BE REPLACED WITH DIRECTLY SOURCED DATA

risk <- readxl::read_excel(paste0(ukr_inform_data_folder_path, "INFORM_Risk_Mid2022_v064.xlsx"), 
                             sheet = "INFORM Risk 2022 (a-z)",
                             range = readxl::cell_cols("A:AD")) %>%
          select(COUNTRY, ISO3, `INFORM RISK`, `RISK CLASS`, `HAZARD & EXPOSURE`, VULNERABILITY, `LACK OF COPING CAPACITY`) %>%
          rename(country = COUNTRY, 
                 risk_score_apr2022 = `INFORM RISK`,
                 risk_class_apr2022 = `RISK CLASS`,
                 he = `HAZARD & EXPOSURE`,
                 vu = VULNERABILITY,
                 cc = `LACK OF COPING CAPACITY`) %>%
          slice(-1) %>%
          mutate(risk_score_apr2022 = round(as.numeric(risk_score_apr2022), 1),
                 he = round(as.numeric(he), 1),
                 vu = round(as.numeric(vu), 1),
                 cc = round(as.numeric(cc), 1))
          

severity <- readxl::read_excel(paste0(ukr_inform_data_folder_path, "20220405_inform_severity_-_march_2022_0.xlsx"), 
                             sheet = "INFORM Severity - country",
                             range = readxl::cell_cols("B:J")) %>%
          select(COUNTRY, ISO3, `CRISIS ID`, `INFORM Severity Index`, `INFORM Severity category...6`, `INFORM Severity category...7`, `Trend (last 3 months)`, Reliability) %>%
          rename(country = COUNTRY, 
                 crisis_id = `CRISIS ID`,
                 severity_index = `INFORM Severity Index`,
                 severity_level = `INFORM Severity category...6`,
                 severity_cat = `INFORM Severity category...7`,
                 trend_3mo = `Trend (last 3 months)`,
                 reliability = Reliability) %>%
                 slice(-(1:2))

crisis_ids <- severity[, 'crisis_id']
                       
severity_trends <- readxl::read_excel(paste0(ukr_inform_data_folder_path, "20220405_inform_severity_-_march_2022_0.xlsx"), 
                             sheet = "Trends") %>%
             rename(country = Country, 
                crisis_name = Crisis,
                crisis_id = `Crisis ID`,
                current_trend_label = Trend) %>%
            pivot_longer(!c(country, crisis_name, crisis_id, current_trend_label), 
                         names_to = "date") %>%
            rename(severity_index = value) %>%
            mutate(date = as.Date(as.numeric(date), origin = "1899-12-30"),
                   severity_index = as.numeric(severity_index))

hrp <- c('Afghanistan',
'Burkina Faso',
'Burundi',
'Cameroon',
'Central African Republic',
'Chad',
'Colombia',
'Democratic Republic of the Congo',
'Congo DRC', # manual addition to match CERF spelling
'El Salvador',
'Ethiopia',
'Guatemala',
'Haiti',
'Honduras',
'Iraq',
'Libya',
'Mali',
'Mozambique',
'Myanmar',
'Niger',
'Nigeria',
'occupied Palestinian territory',
'Somalia',
'South Sudan',
'Sudan',
'Syrian Arab Republic',
'Syria', # manual addition to match CERF spelling
'Ukraine',
'Venezuela',
'Yemen'
)
```

```{r data-formatting}
severity_deltas <- severity_trends %>%
                    select(country, crisis_id, date, severity_index) %>%
                    filter(crisis_id %in% crisis_ids$crisis_id) %>% # to address multi-crisis countries
                    group_by(country, crisis_id) %>% 
                    arrange(country, crisis_id, desc(date)) %>%
                    mutate(rollmean_last3 = round(rollmean(severity_index, k = 3, align = 'left', fill = NA), 1), # mean of last 3 months including current
                           roll_mean_prev3 = round(rollmean(lead(severity_index, 4), k = 3, align = 'left', fill = NA), 1)) %>% # mean of 3-mo period preceding the last 3 mos (last 4 to 6 mos)
                    ungroup(country, crisis_id) %>%
                    mutate(delta = round(rollmean_last3 - roll_mean_prev3, 1), # without rounding BDI001 2022-03-01 is misclassified.
                           trend_label = dplyr::case_when(delta >= 0.1 ~ "Deterioration",
                                                   delta <= -0.1 ~ "Improvement",
                                                   delta == 0 ~ "Stable", # note the rounding so no values between -0.1 and 0.1 possible besides 0
                                                   TRUE ~ "NA"))

severity_deltas$trend_label <- factor(severity_deltas$trend_label, levels = c("Deterioration", "Stable", "Improvement", "NA"))

```

## Data

### Current Crisis Severity

The [INFORM Severity Index](https://drmkc.jrc.ec.europa.eu/inform-index/INFORM-Severity/Methodology) defines severity as “a measure of the outcomes generated by the impact of a crisis, which can be exacerbated by the complexity of the operational environment”. It is designed to measure the severity of humanitarian crises globally against a common scale. It categorises all crises into five levels and tracks changes in crisis severity over time. It should not be used for decisions about the operational response to a specific crisis.

The plot below shows the current severity of crises with **more severe crises at the top** of the graph. It also shows the 3-month trend of the crisis where crisis that recently showed a **deterioration are listed in \textcolor{firebrick4}{red} on the right-hand side** of the graph. Change in severity was computed by subtracting from the average of the last 3 months the average of the previous 3 months (months 4 - 6), per INFORM methodology.

<br>

```{r severity, dpi=300, fig.height=7, fig.weight=9, fig.align="center"}

inform_publication_date <- "2022-03-01"

min_delta <- severity_deltas %>% filter(date == inform_publication_date) %>% summarise(min(delta, na.rm=T)) %>% as.numeric()
max_delta <- severity_deltas %>% filter(date == inform_publication_date) %>% summarise(max(delta, na.rm=T)) %>% as.numeric()
lowest_delta <- ifelse(min_delta < -0.4, min_delta, -0.42)
highest_delta <- ifelse(max_delta > 0.4, max_delta, 0.42)

severity_deltas %>%
  filter(date == inform_publication_date) %>%
  ggplot(aes(x = delta,
           y = severity_index,
           color = trend_label)) +
     geom_point() + 
  scale_x_continuous(limits = c(lowest_delta, highest_delta),
                      breaks = seq(round(lowest_delta, 1), signif(highest_delta, 1), by = 0.1)) +
  ylim(1, 5.5) +
  scale_color_manual(breaks = c("Improvement", "Stable", "Deterioration"), values = c("darkblue", "azure4", "firebrick4", "cyan")) + # must leave value for NA as well
  geom_text_repel(aes(label = country), size = 3, seed = 50) +
  labs(title = "Severity of Humanitarian Crises",
       subtitle = "Index by 3-month Trend",
        x = "Change in Severity",
        y = "Current Severity Index",
       caption = "Source: INFORM Severity Index. Only countries with trend data shown.",
       colour = "Trend") +
  theme_minimal() +
  theme(axis.line.x.bottom = element_line(colour = "black"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = c(0.5, 0.93),
        legend.direction="horizontal",
        legend.box.background = element_rect(colour = "black")) +
  geom_hline(colour="darkgreen", yintercept=3) +
  annotate(geom = "text", x = lowest_delta, y = 1, label = "Very Low", color="darkgreen", alpha = 0.8, size = 3.5) +
  annotate(geom = "text", x = lowest_delta, y = 1.5, label = "Low", color="darkgreen", alpha = 0.8, size = 3.5) +
  annotate(geom = "text", x = lowest_delta, y = 2.5, label = "Medium", color="darkgreen", alpha = 0.8, size = 3.5) +
  annotate(geom = "text", x = lowest_delta, y = 3.5, label = "High", color="darkgreen", alpha = 0.8, size = 3.5) +
  annotate(geom = "text", x = lowest_delta, y = 4.5, label = "Very High", color='darkgreen', alpha = 0.8, size = 3.5) +
  annotate(geom = "rect", xmin = 0.05, xmax = highest_delta, ymin = 3, ymax = 5, fill = 'gold2', alpha = 0.2) +
  annotate(geom = "text", x = 0.05 + ((highest_delta - 0.05) / 2), y = 5.1, label = "Most severe and deteriorating", color = 'gold2', alpha = 1, size = 4, align = "left")
  
  
```

<br>

### Trajectory of Food Security

<br>

\textcolor{firebrick4}{Note: Current Situation figures are as of November 2021. Projections from Novembre 2021 for Apr - June 2022.}

```{r food-security-computations}

current_fs <- data %>%
  mutate(HRP = ifelse(country %in% hrp, 'Yes', 'No')) %>% 
  arrange(desc(HRP), country) %>%
  mutate(curr_2021Q4_ipc3_perc = round(curr_2021Q4_ipc3/pop * 100, 1),
         curr_2021Q4_ipc4_perc = round(curr_2021Q4_ipc4/pop * 100, 1),
         curr_2021Q4_ipc5_perc = round(curr_2021Q4_ipc5/pop * 100, 1)) %>%
  select(HRP, country, pop, curr_2021Q4_ipc3plus, curr_2021Q4_ipc3plus_perc, curr_2021Q4_ipc4, curr_2021Q4_ipc4_perc, curr_2021Q4_ipc5, curr_2021Q4_ipc5_perc) %>%
  replace(is.na(.), 0) 

current_fs_tbl <- current_fs %>%
  kbl(
    format = 'html',
    row.names = FALSE, 
    col.names = c("HRP", "Country", "Population", 'IPC3+', 'IPC3+ (%)', 'IPC4', 'IPC4 (%)', 'IPC5','IPC5 (%)'),
    align = "lllcccccc",
    format.args = list(big.mark = ",", scientific = FALSE),
    escape = F
    ) %>%
  add_footnote("Source: FewsNet, World Pop") %>%
  kable_minimal(c("hover", "striped")) %>%
  kable_styling() %>%
  add_header_above(c(" " = 3, "Current" = 6)) %>%
  scroll_box(width = "100%", height = "500px", fixed_thead = T)

proj_fs <- data %>%
  mutate(HRP = ifelse(country %in% hrp, 'Yes', 'No')) %>% 
  arrange(desc(HRP), country) %>%
  select(HRP, country, pop, highest_projected_ipc, delta_22Q2_21Q4_ipc3plus_perc, delta_22Q2_21Q4_ipc4_perc, delta_22Q2_21Q4_ipc5_perc) %>%
  replace(is.na(.), 0) 

proj_fs_tbl <- proj_fs %>%
  kbl(
    format = 'html',
    row.names = FALSE, 
    col.names = c("HRP", "Country", "Population", "Highest Projected Phase", 'Change IPC3+ (%)','Change IPC4 (%)', 'Change IPC5 (%)'),
    align = "lllcccc",
    format.args = list(big.mark = ",", scientific = FALSE),
    escape = F
    ) %>%
  add_footnote("Source: FewsNet, World Pop") %>%
  kable_minimal(c("hover", "striped")) %>%
  kable_styling() %>%
  add_header_above(c(" " = 3,  "Projected" = 4)) %>%
  scroll_box(width = "100%", height = "500px", fixed_thead = T)

fs_plot <- 
  current_fs %>%
  filter(HRP == 'Yes') %>%
  left_join(proj_fs, by = c('HRP', 'country', 'pop')) %>%
    ggplot(aes(x = curr_2021Q4_ipc3plus_perc,
           y = delta_22Q2_21Q4_ipc3plus_perc)) +
         #  color = trend_label)) +
     geom_point() +
     geom_text_repel(aes(label = country), size = 3, seed = 50) +
  labs(title = "Current and Projected Food Security in HRP Countries",
       subtitle = "Nov 2021 - Jun 2022",
        x = "Current Population in Phases 3+ (%)",
        y = "Projected Change in Phase 3+ (%)",
       caption = "Source: FewsNet") +
  theme_minimal() +
  theme(axis.line.x.bottom = element_line(colour = "black"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = c(0.5, 0.93),
        legend.direction="horizontal",
        legend.box.background = element_rect(colour = "black")) +
 # annotate(geom = "text", x = lowest_delta, y = 1, label = "Lowest \n Increase", color="darkgreen", alpha = 0.8, size = 3.5) +
  #annotate(geom = "text", x = lowest_delta, y = 4.5, label = "Highest \n Increase", color='darkgreen', alpha = 0.8, size = 3.5) +
  annotate(geom = "rect", xmin = 0.3, xmax = 0.6, ymin = 0.0, ymax = 0.25, fill = 'gold2', alpha = 0.2) +
  annotate(geom = "text", x = 0.45, y = 0.28, label = "Currently most severe", color = 'gold2', alpha = 1, size = 4) +
  annotate(geom = "rect", xmin = 0.0, xmax = 0.2, ymin = 0.5, ymax = 0.82, fill = 'darkorange', alpha = 0.2) +
  annotate(geom = "text", x = 0.1, y = 0.85, label = "Largest Projected Increase", color = 'darkorange', alpha = 1, size = 4)

```
```{r food-security-table}
current_fs_tbl
```

<br>

```{r food-security-plot}
fs_plot
```

<br>

Countries projected to reach phase 5: `r data %>% mutate(HRP = ifelse(country %in% hrp, 'Yes', 'No')) %>% filter(highest_projected_ipc == 'IPC 5' | highest_projected_ipc == 'IPC5') %>% select(HRP, country)` 

Countries projected to reach phase 4: `r data %>% mutate(HRP = ifelse(country %in% hrp, 'Yes', 'No')) %>% filter(highest_projected_ipc == 'IPC 4') %>% select(HRP, country)` 

<br>
Food security projections per phase in the table below.

`r proj_fs_tbl`

<br>

### Risk Exposure

The [INFORM Risk Score](https://drmkc.jrc.ec.europa.eu/inform-index/INFORM-Risk/Methodology) envisages three dimensions of risk, treated equally: hazards & exposure, vulnerability and lack of coping capacity. The **hazard & exposure** dimension reflects the probability of physical exposure associated with specific hazards. Physical vulnerability, which is a hazard-dependent characteristic, is included in the hazard & exposure dimension. **Vulnerability** addresses the intrinsic predispositions of an exposed population to be affected or to be susceptible to the damaging effects of a hazard as captured with hazard-independent indicators. It represents economic, political and social characteristics of the community that can be destabilized in case of a hazard event. The **coping capacity** dimension measures the ability of a country to cope with disasters in terms of formal, organized activities and the effort of the country’s government as well as the existing infrastructure which contribute to the reduction of disaster risk. The Risk Score can support decisions about prevention, preparedness and response.

<br>

```{r risk}

risk %>%
  left_join(data[, c('country', 'pop')], by = "country") %>%
  mutate(HRP = ifelse(country %in% hrp, 'Yes', 'No')) %>% 
  arrange(desc(HRP), country) %>%
  select(HRP, country, pop, risk_score_apr2022, risk_class_apr2022, he, vu, cc) %>%
   mutate(risk_class_apr2022 = cell_spec(risk_class_apr2022, 
                                         color = "white", 
                                         background = case_when(risk_class_apr2022 %in% c("High", "Very High") ~ "red",
                                                                risk_class_apr2022 == "Medium" ~ "orange",
                                                                risk_class_apr2022%in% c("Low", "Very Low") ~ "green"))) %>%
  kbl(
    format = 'html',
    row.names = FALSE, 
    col.names = c("HRP", "Country", "Population", "Risk Score", "Risk Class", "Hazard & Exposure", "Vulnera-\n bility", "Coping Capacity"),
    align = "llrccccc",
    format.args = list(big.mark = ",", scientific = FALSE),
    escape = F
    ) %>%
  add_footnote("Source: INFORM Risk, World Pop") %>%
  kable_minimal(c("hover", "striped")) %>%
  kable_styling() %>%
  column_spec(2, width = "8em") %>%
  column_spec(5, width = "8em") %>%
  add_header_above(c(" " = 3, "Score" = 2, "Dimensions" = 3)) %>%
  add_header_above(c(" " = 3, "INFORM" = 5)) %>%
  scroll_box(width = "100%", height = "500px", fixed_thead = T)

```

