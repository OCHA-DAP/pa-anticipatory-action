---
title: '<img src="https://drive.google.com/uc?id=118y5T73-iSUZoAMtoJGddxq9QzD_GDKX" style="height:40px;float:left;margin:10px" /><img src="https://drive.google.com/uc?id=1fHQUzF3ZjaoHj9KQ33-94dK_X1hcmjzW" style="height:50px;float:left;margin:10px" />'
pagetitle: 'AA Trigger Report'
output:
  html_document:
    css: ../country_template/docs/style.css
    includes:
      in_header: ../country_template/docs/header.html
    toc: no
    toc_float: yes
    toc_depth: '4'
    df_print: paged
  html_notebook:
    css: ../country_template/docs/style.css
    includes:
      in_header: ../country_template/docs/header.html
    toc: no
    toc_float: yes
    toc_depth: '4'
    df_print: paged
editor_options:
  chunk_output_type: console
---
<style type="text/css">
.main-container {
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r README, echo = FALSE, message = FALSE, warning = FALSE}
### NOTE: The template is set up for two 3-timepoint predictive triggers and a 1-timepoint observational trigger

### Create a trigger_report folder under DATA_DIR > /private/exploration/{country_pcode3/trigger_performance}
### Copy the dummy_learning_table_for_template.csv file to the trigger_report folder on DATA_DIR; remove 'dummy" and "for_template" from filename; add the 3-letter pcode for the country at the very beginning of the filename (eg: ner_perf_metrics_table.csv)
### Create a "plots" folder sister to the RMD file in the country's `analyses` folder
### Update the "hard-coded-values" code chunk below
### If there are fewer or more than 3 triggers: Adjust the number of triggers throughout the Rmd (template has 3)
### Remove the Annex if no trigger has more than 1 activation timepoint or adjust the Annex as needed 
### Knit
```

```{r paths}
data_folder_path <- paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/", country_pcode3,"/trigger_performance/")
perf_metrics_95_filename <- paste0(data_folder_path, country_pcode3, "_perf_metrics_table_ci_0.95.csv")
perf_metrics_68_filename <- paste0(data_folder_path, country_pcode3, "_perf_metrics_table_ci_0.68.csv")
learning_table_filename <- paste0(data_folder_path, country_pcode3, "_learning_table.csv")

```

```{r hard-coded-values, echo = FALSE, message = FALSE, warning = FALSE}
country_name <- "Niger"
country_pcode3 <- "ner"
shock <- "Drought"
nbr_hist_shocks <- 9 # X is a number. #NER: Number of reported bad years 

# trigger A info  
name_a <- "Trigger1" # what name is the trigger listed as in the eprf_metrics_table?
type_a <- 'Predictive' # Predictive or Observational?
monitored_area_a <- "National"
timepoints_a<- 'Jan, Feb, Mar' # eg: 'Jan, Feb, Mar'
package_a <- 'Package 1' # eg: 'Package 1'
funding_a <- 5.25 # input number only, no $ sign or 'm' for million. Formatting will be done automatically.
predicted_window_a <- 'Jul-Sep' # 3-letter names for first and last month. eg: 'Jul-Sep' 
lead_time_a <- '6-4 months' # 'eg: 7-5 months', Change units as needed. Include all lead times if multiple activation timepoints
data_source_a <- 'IRI flexible seasonal forecast' # name of product + provider
hist_period_a <- "1991 - 2020" # period for which historical data is available
monitored_by_a <- 'IRI' # owner of monitoring responsibilities

# trigger B info  
name_b <- "Trigger2"
type_b <- 'Predictive'
monitored_area_b <- "National"
timepoints_b <- 'Apr, May, Jun'
package_b <- 'Package 2'
funding_b <- 9.5
predicted_window_b <- 'Jul-Sep'
lead_time_b <- '3-1 months'
data_source_b <- 'IRI flexible seasonal forecast'
hist_period_b <- "1991 - 2020"
monitored_by_b <- 'IRI'

# trigger C info  
name_c <- "Trigger3"
type_c <- 'Observational'
monitored_area_c <- "National"
timepoints_c <- 'Aug'
package_c <- 'Package 2'
funding_c <- 9.5
predicted_window_c <- 'N/A'
lead_time_c <- 'N/A'
data_source_c <- 'ENACTS or CHIRP'
hist_period_c <- "1991 - 2020"
monitored_by_c <- 'IRI'

# activation timepoints for triggers with multiple timepoints ONLY
atv_timepoints <- c("Jan", "Feb", "Mar", "Apr", "May", "June")
  
# Compile list of triggers to be included in the report (exclude framework-full and framework-min)
trigger_list <- c(name_a, name_b, name_c, atv_timepoints)

# Table footnotes
trigger_table_footnote <- "Triggers A and B can reach their threshold and activate independently from one another. Trigger C can only activate the framework if Trigger B was not met. See Annex for performance metrics per timepoint."

framework_table_footnote <- "A full activation is defined as Triggers A and B being met, or as Trigger A and C being met."

# Data providers
data_providers <- "The Direction de la météorologie nationale du Niger, IRI Columbia University, World Food Programme Niger" # will be followed by "provide data and/or analytical support."

# Data sources: historical shocks
hist_shocks_source <- "IRI Financial Instruments Team and WFP Niger. Partial historical data is available through IRI's Maproom [tool](http://iridl.ldeo.columbia.edu/fbfmaproom2/niger)" # Prompt: "The data on historical shocks was provided by.." .

# Analysis
analysis <- "The triggers were developed by IRI in close collaboration with DMN, WFP Niger, and the Centre for Humanitarian Data with valuable input from participating agencies and OCHA."

# Monitoring process
monitoring_process <- "Between January and June inclusively, the FIT team at IRI updates the forecast (Triggers A and B) and the decision tool within Maproom by the 22nd of each month. Within 24 hours of the update, the IRI team notifies the AA team, the Niger Humanitarian Coordinator, and the Chief of CERF by email whether or not the trigger is met. By 7 August the Direction de la météorologie nationale du Niger will collate the rainfall measurements from the stations specified in the framework for the period 1 June - 31 July, and share them with the IRI FIT team. By 10 August the IRI FIT team will confirm the number of stations for which complete data is available; select ENACTS (80% or more available) or CHIRP (less than 80% available) accordingly; compute the SPI values and update Maproom. The IRI FIT team will then notify the AA team, the Niger Humanitarian Coordinator, and the Chief of CERF by email whether or not the trigger is met. In case of an activation, additional meteorological data will be shared by the DMN, the IRI FIT team, and/or Centre for Humanitarian Data to inform response targeting."
  
```

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = TRUE) # include chunk output by default
knitr::opts_chunk$set(message = FALSE) # do not print messages by default
knitr::opts_chunk$set(warning = FALSE) # do not print warnings by default

options(scipen = 999) # turn off scientific notation
options(encoding = "UTF-8") # set encoding to UTF-8 instead of ANSI
```

```{r libraries, include = FALSE}
packages <- c('tidyverse', 'ggthemes', 'kableExtra', 'knitr', 'flextable')

# install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load libraries 
lapply(packages, library, character.only = TRUE)

```

```{r functions}
source("../country_template/docs/plotCIs.R")
```

```{r data-loading-and-formatting}

# read in performance metrics files
perf_metrics_95_data <- read.csv(perf_metrics_95_filename,
                              colClasses = c('character', 'character', 'numeric', 'character')
                              )
perf_metrics_68_data <- read.csv(perf_metrics_68_filename,
                              colClasses = c('character', 'character', 'numeric', 'character')
                              )
# format performance metrics values
perf_metrics_95_data$value <- round(100 * perf_metrics_95_data$value, 0)
perf_metrics_68_data$value <- round(100 * perf_metrics_68_data$value, 0)

# uniquely identify point labels
perf_metrics_95_data$upoint <- paste0(perf_metrics_95_data$point, "_95")
perf_metrics_68_data$upoint <- paste0(perf_metrics_68_data$point, "_68")

# combine datasets
perf_metrics_data <- rbind(perf_metrics_95_data, perf_metrics_68_data)

# format funding amounts
funding_a <- paste0('$',funding_a,'m')
funding_b <- paste0('$',funding_b,'m')
funding_c <- paste0('$',funding_c,'m')

```

```{r plot-CIs}

# Compile list of metrics to be included in the report
metrics_list <- c('atv', 'det', 'far', 'mis', 'var') # trigger activation prob, detection rate, false alarm rate, miss rate, valid activation rate 
framework_triggers_list <- c("framework-min", "framework-full")

# Create a record of segment dimensions
segment_dim_summary <- data.frame(trigger_id = NA, metric_name = NA, segment = NA, lo_end = NA, hi_end = NA)
  
# Create a CI visual + segment_dimension dataframe for all metrics, for each trigger
for(trigger in trigger_list) {
  for (metric in metrics_list) {
  
  # produce segment_dimensions and plots for triggers 
  output <- plotCI(trigger_id = trigger, 
                   metric_name = metric)
  
  # save plot as png
  filename <- paste0(trigger, "_", metric, "_ci.png")
  png(filename = paste0("plots/", filename), width = 815, height = 410, units = "px")
  print(output$plot)
  dev.off()
    
  # save segment_dimensions in summary
  segment_dim_temp <- data.frame(trigger_id = trigger_id, metric_name = metric, output$segment_dims)
    
  segment_dim_summary <- dplyr::bind_rows(segment_dim_summary, segment_dim_temp)
  
  }
}


# compute width and position of CIs for trigger a
df_a_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = name_a) 
df_a_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = name_a) # detection rate
df_a_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = name_a) # false alarm rate
df_a_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = name_a) # miss rate
df_a_atv <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'atv', trigger_id = name_a) # probability of trigger activation

# compute width and position of CIs for trigger b
df_b_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = name_b) # valid activation rate 
df_b_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = name_b) # detection rate
df_b_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = name_b) # false alarm rate
df_b_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = name_b) # miss rate
df_b_atv <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'atv', trigger_id = name_b) # probability of trigger activation

# compute width and position of CIs for trigger c
df_c_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = name_c) # valid activation rate 
df_c_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = name_c) # detection rate
df_c_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = name_c) # false alarm rate
df_c_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = name_c) # miss rate
df_c_atv <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'atv', trigger_id = name_c) # probability of trigger activation

# compute width and position of CIs for the framework
df_fmwk_min <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'atv', trigger_id = 'framework-min') # prob minimum framework activation 
df_fmwk_ful <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'atv', trigger_id = 'framework-full') # prob full framework activation 

```

```{r data-plotting}



plotCI(trigger_id = 'a', metric = 'var', ci_widths_df = 'df_a_var') 
plotCI(trigger_id = 'a', metric = 'det', ci_widths_df = 'df_a_det')
plotCI(trigger_id = 'a', metric = 'far', ci_widths_df = 'df_a_far')
plotCI(trigger_id = 'a', metric = 'mis', ci_widths_df = 'df_a_mis')
plotCI(trigger_id = 'a', metric = 'atv', ci_widths_df = 'df_a_atv')

plotCI(trigger_id = 'b', metric = 'var', ci_widths_df = 'df_b_var') 
plotCI(trigger_id = 'b', metric = 'det', ci_widths_df = 'df_b_det')
plotCI(trigger_id = 'b', metric = 'far', ci_widths_df = 'df_b_far') 
plotCI(trigger_id = 'b', metric = 'mis', ci_widths_df = 'df_b_mis')
plotCI(trigger_id = 'b', metric = 'atv', ci_widths_df = 'df_b_atv')

plotCI(trigger_id = 'c', metric = 'var', ci_widths_df = 'df_c_var') 
plotCI(trigger_id = 'c', metric = 'det', ci_widths_df = 'df_c_det') 
plotCI(trigger_id = 'c', metric = 'far', ci_widths_df = 'df_c_far') 
plotCI(trigger_id = 'c', metric = 'mis', ci_widths_df = 'df_c_mis') 
plotCI(trigger_id = 'c', metric = 'atv', ci_widths_df = 'df_c_atv')

plotCI(trigger_id = 'framework', metric = 'min', ci_widths_df = 'df_fmwk_min') 
plotCI(trigger_id = 'framework', metric = 'ful', ci_widths_df = 'df_fmwk_ful') 
```

# Anticipatory Action Trigger Mechanism Report

<p style="color:#007ce1;font-size:22px;text-align:center;"> `r paste0(shock, ' in ', country_name)`</p> 
<p style="color:black;font-size:14px;text-align:right;"> Last updated: `r Sys.Date()`</p> 

***
## Trigger Mechanism Snapshot

<p style="color:black;font-size:16px;text-align:left;"> This table summarises the definition of the triggers and their performance in offering a reliable signal of the targeted severe shocks. The performance metrics are presented as ranges (called confidence intervals) that describe the inherent uncertainty of the measurements. The coloured graphs show the ranges within which the triggers will perform `r ci`% of the time. Blue confidence intervals refer to activations, green confidence intervals represent desired outcomes while red confidence intervals represent undesired outcomes or errors. </p>

&nbsp;

```{r mechanism-snapshot, include = TRUE}

snapshot_df <- data.frame(row_name = c('Type', 
                                       'Monitored Area',
                                       'Activation Timepoints', 
                                       'Predicted Period', 
                                       'Lead Time', 
                                       'Data Source',
                                       'Historical Data Coverage',
                                       'Monitored by',
                                       'Probability of being met in a given year', 
                                       'Valid Activations (X% of all activations expected to be followed by a shock)', 
                                       'Detections (An activation is expected to occur for X% of the shocks)', 
                                       'False Alarms (X% of all activations expected NOT to be followed by a shock)', 
                                       'Misses (X% of the time there is a shock, no activation is expected)', 
                                       'Activity Package', 
                                       'Funding Amount'),
                       trigger_a = c(type_a, 
                                     monitored_area_a,
                                     timepoints_a, 
                                     predicted_window_a, 
                                     lead_time_a, 
                                     data_source_a,
                                     hist_period_a,
                                     monitored_by_a,
                                     paste0("<img src=plots/trimmed_trigger_a_atv_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_a_var_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_a_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_a_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_a_mis_ci.png"), 
                                     package_a, 
                                     funding_a),
                       trigger_b = c(type_b,
                                     monitored_area_b,
                                     timepoints_b, 
                                     predicted_window_b, 
                                     lead_time_b, 
                                     data_source_b,
                                     hist_period_b,
                                     monitored_by_b,
                                     paste0("<img src=plots/trimmed_trigger_b_atv_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_b_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_b_det_ci.png"),  
                                     paste0("<img src=plots/trimmed_trigger_b_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_b_mis_ci.png"), 
                                     package_b, 
                                     funding_b),
                       trigger_c = c(type_c, 
                                     monitored_area_c,
                                     timepoints_c, 
                                     predicted_window_c, 
                                     lead_time_c, 
                                     data_source_c,
                                     hist_period_c,
                                     monitored_by_c,
                                     paste0("<img src=plots/trimmed_trigger_c_atv_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_c_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_c_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_c_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_c_mis_ci.png"), 
                                     package_c, 
                                     funding_c))

kbl(snapshot_df,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("","Trigger A", "Trigger B", "Trigger C"), 
    align = "rccc") %>%
  kable_minimal(c("hover")) %>%
  row_spec(c(1:9, 14:15), extra_css = "line-height: 25px;") %>%
  row_spec(c(10:13), extra_css = "line-height: 45px;") %>%
  column_spec(column = 1, extra_css = "vertical-align: bottom;") %>%
  column_spec(column = c(2:4), width = "20em") %>%
  pack_rows("Description", start_row = 1, end_row = 9, color = '#1bb580') %>%
  pack_rows("Performance", start_row = 10, end_row = 13, color = '#1bb580') %>%
  pack_rows("Programming and Funding", start_row = 14, end_row = 15, color = '#1bb580') %>%
  kableExtra::footnote(general = "", general_title = trigger_table_footnote)

```

&nbsp;

## Framework Activation

<p style="color:black;font-size:16px;text-align:left;"> This section examines the likelihood of a framework activation in a given year under various scenarios. The estimates are presented as ranges (called confidence intervals) to illustrate the inherent uncertainty of the measurements. The graphs show the ranges of probabilities that the scenario is to occur `r ci`% of the time.</p>

&nbsp;

```{r framework-activation-table}
framework_df <- data.frame(row_name = c('At least one trigger being met (probability in %)', 
                                        'Full framework activation (probability in %)'),
                           frmwk_stats = c(paste0("<","img src=","plots/trimmed_framework_min_ci",".png",">"),  
                                           paste0("<","img src=","plots/trimmed_framework_ful_ci",".png",">")))  

kbl(framework_df,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("",""), 
    align = "rc") %>%
  kable_styling(full_width = F) %>%
  kable_minimal(c("hover")) %>%
  row_spec(c(1:2), extra_css = "line-height: 45px;") %>%
  column_spec(column = 1, width = "28em", extra_css = "vertical-align: bottom;") %>%
  column_spec(column = 2, width = "20em") %>%
  pack_rows("Activation Scenario", start_row = 1, end_row = 2, color = '#1bb580') %>%
  kableExtra::footnote(general = "", general_title = framework_table_footnote)
    
```

&nbsp;

## Data Underlying Trigger Mechanism
<p style="color:black;font-size:16px;text-align:left;"> `r data_providers` provide data and/or analytical support. The data on historical shocks was provided by `r hist_shocks_source`. A total of `r nbr_hist_shocks` historical occurrences of severe shocks were documented and used to develop the trigger mechanism. The shocks reached the level of severity targeted with AA. `r analysis` </p>

## Monitoring Process
<p style="color:black;font-size:16px;text-align:left;"> `r monitoring_process` </p>

## Learning Opportunities
<p style="color:black;font-size:16px;text-align:left;"> This table summarises the decisions, assumptions, and open questions that arose during trigger development. They are documented for transparency and to inform the learning agenda.</p>

&nbsp;

```{r learning-table}

learning_table <- read.csv(learning_table_filename)

kbl(learning_table,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("Decision","Rationale", "Assumption", "Open Question"), 
    align = "llll") %>%
  kable_minimal(c("hover", "striped")) %>%
  column_spec(column = c(1:4), width = "28em")

```

&nbsp;

## Annex

<p style="color:black;font-size:16px;text-align:left;"> This table reports the performance metrics of the predictive triggers per timepoint. </p>

&nbsp;

```{r timepoint-table-setup}

# compute width and position of CIs for trigger at timepoint: Jan
jan_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'Jan') # valid activation rate 
jan_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'Jan') # detection rate
jan_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'Jan') # false alarm rate
jan_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'Jan') # miss rate

# compute width and position of CIs for trigger at timepoint: Feb
feb_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'Feb') # valid activation rate 
feb_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'Feb') # detection rate
feb_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'Feb') # false alarm rate
feb_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'Feb') # miss rate

# compute width and position of CIs for trigger at timepoint: Mar
mar_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'Mar') # valid activation rate 
mar_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'Mar') # detection rate
mar_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'Mar') # false alarm rate
mar_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'Mar') # miss rate

# compute width and position of CIs for trigger at timepoint: Apr
apr_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'Apr') # valid activation rate 
apr_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'Apr') # detection rate
apr_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'Apr') # false alarm rate
apr_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'Apr') # miss rate

# compute width and position of CIs for trigger at timepoint: May
may_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'May') # valid activation rate 
may_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'May') # detection rate
may_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'May') # false alarm rate
may_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'May') # miss rate

# compute width and position of CIs for trigger at timepoint: June
jun_var <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'var', trigger_id = 'June') # valid activation rate 
jun_det <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'det', trigger_id = 'June') # detection rate
jun_far <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'far', trigger_id = 'June') # false alarm rate
jun_mis <- computeCIwidths(perf_metrics_df = perf_metrics_data, metric_name = 'mis', trigger_id = 'June') # miss rate

# plot CIs for every timepoint
plotCI(trigger_id = 'Jan', metric = 'var', ci_widths_df = 'jan_var') 
plotCI(trigger_id = 'Jan', metric = 'det', ci_widths_df = 'jan_det')
plotCI(trigger_id = 'Jan', metric = 'far', ci_widths_df = 'jan_far')
plotCI(trigger_id = 'Jan', metric = 'mis', ci_widths_df = 'jan_mis')

plotCI(trigger_id = 'Feb', metric = 'var', ci_widths_df = 'feb_var') 
plotCI(trigger_id = 'Feb', metric = 'det', ci_widths_df = 'feb_det')
plotCI(trigger_id = 'Feb', metric = 'far', ci_widths_df = 'feb_far') 
plotCI(trigger_id = 'Feb', metric = 'mis', ci_widths_df = 'feb_mis')

plotCI(trigger_id = 'Mar', metric = 'var', ci_widths_df = 'mar_var') 
plotCI(trigger_id = 'Mar', metric = 'det', ci_widths_df = 'mar_det') 
plotCI(trigger_id = 'Mar', metric = 'far', ci_widths_df = 'mar_far') 
plotCI(trigger_id = 'Mar', metric = 'mis', ci_widths_df = 'mar_mis') 

plotCI(trigger_id = 'Apr', metric = 'var', ci_widths_df = 'apr_var') 
plotCI(trigger_id = 'Apr', metric = 'det', ci_widths_df = 'apr_det') 
plotCI(trigger_id = 'Apr', metric = 'far', ci_widths_df = 'apr_far') 
plotCI(trigger_id = 'Apr', metric = 'mis', ci_widths_df = 'apr_mis') 

plotCI(trigger_id = 'May', metric = 'var', ci_widths_df = 'mar_var') 
plotCI(trigger_id = 'May', metric = 'det', ci_widths_df = 'mar_det') 
plotCI(trigger_id = 'May', metric = 'far', ci_widths_df = 'mar_far') 
plotCI(trigger_id = 'May', metric = 'mis', ci_widths_df = 'mar_mis') 

plotCI(trigger_id = 'June', metric = 'var', ci_widths_df = 'jun_var') 
plotCI(trigger_id = 'June', metric = 'det', ci_widths_df = 'jun_det') 
plotCI(trigger_id = 'June', metric = 'far', ci_widths_df = 'jun_far') 
plotCI(trigger_id = 'June', metric = 'mis', ci_widths_df = 'jun_mis') 

```


```{r timepoint-table, include = TRUE}
timepoint_df <- data.frame(row_name = c('Valid Activations', 
                                       'Detections', 
                                       'False Alarms', 
                                       'Misses'),
                       trigger_jan = c(paste0("<img src=plots/trimmed_trigger_Jan_var_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Jan_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Jan_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Jan_mis_ci.png")),
                       trigger_feb = c(paste0("<img src=plots/trimmed_trigger_Feb_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_Feb_det_ci.png"),  
                                     paste0("<img src=plots/trimmed_trigger_Feb_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Feb_mis_ci.png")),
                       trigger_mar = c(paste0("<img src=plots/trimmed_trigger_Mar_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_Mar_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Mar_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Mar_mis_ci.png")),
                       trigger_apr = c(paste0("<img src=plots/trimmed_trigger_Apr_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_Apr_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Apr_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_Apr_mis_ci.png")),
                       trigger_may = c(paste0("<img src=plots/trimmed_trigger_May_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_May_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_May_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_May_mis_ci.png")),
                       trigger_jun = c(paste0("<img src=plots/trimmed_trigger_June_var_ci.png"),
                                     paste0("<img src=plots/trimmed_trigger_June_det_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_June_far_ci.png"), 
                                     paste0("<img src=plots/trimmed_trigger_June_mis_ci.png")))

kbl(timepoint_df,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("","January", "February", "March", "April", "May", "June"), 
    align = "rcccccc") %>%
  kable_minimal(c("hover")) %>%
  row_spec(c(1:4), extra_css = "line-height: 45px;") %>%
  column_spec(column = 1, extra_css = "vertical-align: bottom", width = "10em") 

```
