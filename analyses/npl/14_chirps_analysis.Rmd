---
title: "Analysing CHIRPS data for Flood Trigger Development"
output: md_document
---

## Rainfall Analysis

Reading data from shapefile to get river basin bounds:

```{r intro, echo=FALSE, warning = FALSE, message=FALSE, results='hide'}
filePath <- paste0(Sys.getenv("AA_DATA_DIR"), "/public/processed/npl/chirps/")
options(scipen = 100000)
    
# libraries
library(tidyverse)
library(sf)
library(tidyquant)
library(extRemes)
library(tseries)
library(ncdf4)
library(raster)

# reading in shapefiles
temp <- tempfile()
unzip(zipfile = paste0(Sys.getenv("AA_DATA_DIR"), "/public/raw/npl/cod_ab/npl_cod_ab.shp.zip"), exdir = temp)
nplSF <- st_read(temp, layer = "npl_admbnda_districts_nd_20201117")

nplRBSF <- st_read(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/shapefiles/Major_River_Basins.shp"))

nplWSSF <- st_read(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/shapefiles/Major_watershed.shp"))

# reading in historical floods
NPLHistFloods <- readxl::read_xlsx(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/NepalHistoricalFlood1971-2020.xlsx"))

# function for reading in files 
read_files <- function(filePath, fileName){
    ncObj <- nc_open(paste0(filePath, fileName))
    # Karnali
    KarnaliBox <- nplRBSF %>%
        filter(Major_Basi == "Karnali River Basin") %>%
        extent()
    
    KarBoxXMin <- which.min(abs(KarnaliBox[1] - round(ncvar_get(ncObj, "X"), 3)))
    KarBoxXMax <- which.min(abs(KarnaliBox[2] - round(ncvar_get(ncObj, "X"), 3)))
    KarBoxXLen <- KarBoxXMax - KarBoxXMin + 1
    KarBoxYMin <- which.min(abs(KarnaliBox[3] - round(ncvar_get(ncObj, "Y"), 3)))
    KarBoxYMax <- which.min(abs(KarnaliBox[4] - round(ncvar_get(ncObj, "Y"), 3)))
    KarBoxYLen <- KarBoxYMin - KarBoxYMax + 1
    KarDataCube <- ncvar_get(ncObj, "precipitation", 
                             start = c(KarBoxXMin, KarBoxYMax, 1), 
                             count = c(KarBoxXLen, KarBoxYLen, 1)) %>%
        data.frame() %>%
        bind_cols(paste0(round(ncvar_get(ncObj, "X")[KarBoxXMin:KarBoxXMax], 3), "E")) %>%
        setNames(c(paste0(round(ncvar_get(ncObj, "Y")[KarBoxYMax:KarBoxYMin], 3), "N"), "Longitude")) %>%
        gather(key = "Latitude", value = "precipitation", -Longitude) %>%
        mutate(Date = as.Date(str_extract(ncObj$filename,"(?<=daily_).+(?=_r0.05)"), format = "%Y_%m_%d"), 
               Basin = "Karnali River Basin")
    
    # Koshi
    KoshiBox <- nplWSSF %>%
        filter(WSH_NME == "Saptakoshi Watershed") %>%
        extent()
    
    KoshBoxXMin <- which.min(abs(KoshiBox[1] - round(ncvar_get(ncObj, "X"), 3)))
    KoshBoxXMax <- which.min(abs(KoshiBox[2] - round(ncvar_get(ncObj, "X"), 3)))
    KoshBoxXLen <- KoshBoxXMax - KoshBoxXMin + 1
    KoshBoxYMin <- which.min(abs(KoshiBox[3] - round(ncvar_get(ncObj, "Y"), 3)))
    KoshBoxYMax <- which.min(abs(KoshiBox[4] - round(ncvar_get(ncObj, "Y"), 3)))
    KoshBoxYLen <- KoshBoxYMin - KoshBoxYMax + 1
    KoshDataCube <- ncvar_get(ncObj, "precipitation", 
                              start = c(KoshBoxXMin, KoshBoxYMax, 1), 
                              count = c(KoshBoxXLen, KoshBoxYLen, 1)) %>%
        data.frame() %>%
        bind_cols(paste0(round(ncvar_get(ncObj, "X")[KoshBoxXMin:KoshBoxXMax], 3), "E")) %>%
        setNames(c(paste0(round(ncvar_get(ncObj, "Y")[KoshBoxYMax:KoshBoxYMin], 3), "N"), "Longitude")) %>%
        gather(key = "Latitude", value = "precipitation", -Longitude) %>%
        mutate(Date = as.Date(str_extract(ncObj$filename,"(?<=daily_).+(?=_r0.05)"), format = "%Y_%m_%d"), 
               Basin = "Saptakoshi Watershed")
    # close
    nc_close(ncObj)
    # data object
    return(bind_rows(KarDataCube, KoshDataCube))
}


# chirps data frame
chirpsData <- list.files(filePath, pattern = "*.nc") %>%
    map_df(~ read_files(filePath, .)) 

```

```{r}
# rolling sum
# aggregate all grids into one and find mean
# rolling sum is assigned to last day of window
n = 10
AggNational <- chirpsData %>%
    group_by(Date, Basin) %>%
    summarise(rfe = mean(precipitation)) %>%
    group_by(Basin) %>%
    mutate(rollsum = c(rep(0, n-1), rollapplyr(rfe, n, sum))) %>%
    ungroup()
    
# getting top month every year
AggNational2 <- AggNational %>%
    mutate(Year = substr(Date, 1, 4)) %>%
    group_by(Year, Basin) %>%
    top_n(1, rollsum)

ggplot(data = AggNational2, aes(x = Year, y = rollsum, fill = Basin)) + 
    geom_bar(stat="identity", position = "dodge") + 
    theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) + 
    ggtitle("CHIRPS Maximum 10-day Rolling Sum of Precipitation with the Associated Month") +
    xlab("Month") + 
    ylab("Maximum 10-day Rolling Sum(mm)")

# checking for stationarity

adf.test(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"]) # reject H0 and say series is stationary at alpha = 0.05
adf.test(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"]) # reject H0 and say series is stationary at alpha = 0.05

returnValues2 <- AggNational2 %>%
    group_by(Basin) %>%
    summarise(returnyr2 = return.level(fevd(x = rollsum), return.period = 2), 
              returnyr5 = return.level(fevd(x = rollsum), return.period = 5), 
              returnyr10 = return.level(fevd(x = rollsum), return.period = 10))

plot(fevd(x = AggNational2$rollsum[AggNational2$Basin == "Karnali River Basin"]))
plot(fevd(x = AggNational2$rollsum[AggNational2$Basin == "Saptakoshi Watershed"]))

ggplot(data = AggNational2, aes(x = Date, y = rollsum, group = Basin)) + 
    geom_line(aes(colour = Basin)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr2"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr2"]), 
                  label = "RP: 2", vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr2"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr2"]), 
                  label = "RP: 2", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr5"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr5"]), 
                  label = "RP: 5", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr5"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr5"]), 
                  label = "RP: 5", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr10"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr10"]), 
                  label = "RP: 10", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr10"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr10"]), 
                  label = "RP: 10", vjust = -1)) + 
    ggtitle("Maximum 10-day Rolling Sums Per Year with Return Periods") + 
    ylab("Rolling Sums(mm)")

# extracting the return period
mrlplot(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"], main="Mean Residual Life Plot: Karnali River Basin")
mrlplot(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"], main="Mean Residual Life Plot: Saptakoshi Watershed")

threshrange.plot(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"], r = c(0, 100), nint = 25)
threshrange.plot(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"], r = c(0, 150), nint = 25)

returnValues <- AggNational %>%
    group_by(Basin) %>%
    summarise(returnyr2 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                            threshold = 25), return.period = 2), 
              returnyr5 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                            threshold = 25), return.period = 5), 
              returnyr10 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                             threshold = 25), return.period = 10))

ggplot(data = AggNational, aes(x = Date, y = rollsum, group = Basin)) + 
    geom_line(aes(colour = Basin)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr2"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues[1,"returnyr2"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr2"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues[2,"returnyr2"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr5"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues[1,"returnyr5"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr5"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues[2,"returnyr5"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr10"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues[1,"returnyr10"]))), 
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr10"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues[2,"returnyr10"]))),
                  vjust = -1)) + 
    ggtitle("10-day Rolling Sums with Return Periods in Years") + 
    ylab("Rolling Sums(mm)")

```

```{r}
# comparing historical values with return values
# dates where value was exceeded
AggNational3 <- AggNational %>%
    arrange(Date, Basin) %>%
    mutate(thresh2Yr = rollsum >= unlist(returnValues[,"returnyr2"])) %>%
    mutate(thresh5Yr = rollsum >= unlist(returnValues[,"returnyr5"])) %>%
    mutate(thresh10Yr = rollsum >= unlist(returnValues[,"returnyr10"])) %>%
    filter(thresh2Yr) %>%
    group_by(Basin) %>%
    arrange(Basin, Date) %>%
    # remove if consecutive
    mutate(notConsecutive = c(T, diff(Date) != 1), 
           maxRolWindow = ave(rollsum, cumsum(notConsecutive), FUN = max)) %>%
    filter(rollsum == maxRolWindow)

# write.csv(AggNational3, "C:/Users/pauni/Desktop/Work/OCHA/Nepal/Rolling Sums Exceeding 2year return level.csv", row.names = F)

# summary(ecdf(unique(NPLHistFloods$`Affected Family`)))
NPLHistFloodsWorst <- NPLHistFloods
    # filter(`Affected Family` >= 5000)


unique(NPLHistFloodsWorst$`District Name`[which(!NPLHistFloodsWorst$`District Name` %in% nplSF$DIST_EN)])

```

There are 3 districts in the Historical Floods file not found in the shapefile. On further inspection, there seems to be very slight differences in the name that can be explained by data entry. Changing Makwanpur to Makawanpur, Dhanusa to Dhanusha and Kavrepalanchok to Kabhrepalanchok:

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(`District Name` = str_replace_all(`District Name`, "Makwanpur", "Makawanpur"), 
           `District Name` = str_replace_all(`District Name`, "Dhanusa", "Dhanusha"))
unique(NPLHistFloodsWorst$`District Name`[which(!NPLHistFloodsWorst$`District Name` %in% nplSF$DIST_EN)])

```

Trying to clean up the dates in the Historical Floods Data:
 - Replacing the day column with 0 values with 1 
 - Creating Date column from Year, Month and Amended Day column

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(DayVal = str_replace_all(Day, "0", "1"), 
           AmenDate = as.Date(paste0(Year, "-", Month, "-", DayVal)))
```

Checking which districts are in which water basins:

```{r}
nplRBSF2 <- nplRBSF %>%
    filter(Major_Basi %in% "Karnali River Basin")
nplWSSF2 <- nplWSSF %>%
    filter(WSH_NME %in% "Saptakoshi Watershed")

KarnalioverlapVals <- st_intersection(nplRBSF2, nplSF)$DIST_EN
KoshioverlapVals <- st_intersection(nplWSSF2, nplSF)$DIST_EN

```

There are 24 districts that overlap with the Karnali river basin and 4 districts that overlap with the Saptakoshi watershed.

Filtering the Historical Flood Data using these districts:

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(Basin = ifelse(`District Name` %in% KarnalioverlapVals, "Karnali River Basin", 
                          ifelse(`District Name` %in% KoshioverlapVals, "Saptakoshi Watershed", "Other"))) %>%
    filter(Basin %in% c("Karnali River Basin", "Saptakoshi Watershed"))
    
unique(NPLHistFloodsWorst$`District Name`[NPLHistFloodsWorst$Basin == "Karnali River Basin"])
unique(NPLHistFloodsWorst$`District Name`[NPLHistFloodsWorst$Basin == "Saptakoshi Watershed"])

```

There is data for 24 districts for the Karnali River Basin and data for 4 districts for the Saptakoshi watershed.

Comparing the data for the 2 river basins:

```{r}
# joining the two dataframes using full join
CompleteDF <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Date, units = "days"), 
           WeekDiff = difftime(AmenDate, Date, units = "weeks")) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(AmenDate) %>%
    slice(which.min(TimeDiff)) %>%
    filter(TimeDiff > -5 & TimeDiff <= 30)

```

The analysis shows that one of the flood events were preceded by some extreme rainfall events for the Karnali water basin. A negative time difference value shows that the flooding occurred before the rain event. 



