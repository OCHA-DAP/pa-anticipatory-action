---
title: "Analysing CHIRPS data for Flood Trigger Development"
output: md_document
---

## Rainfall Analysis

Reading data from shapefile to get river basin bounds:

```{r intro, echo=FALSE, warning = FALSE, message=FALSE, results='hide'}
filePath <- paste0(Sys.getenv("AA_DATA_DIR"), "/public/processed/npl/chirps/")
options(scipen = 100000)

# devtools::install_github("RS-eco/processNC")
    
# libraries
library(tidyverse)
library(sf)
library(tidyquant)
library(extRemes)

library(tseries)
library(ncdf4)
# library(processNC)
library(raster)


# reading in shapefiles
temp <- tempfile()

unzip(zipfile = paste0(Sys.getenv("AA_DATA_DIR"), "/public/raw/npl/cod_ab/npl_cod_ab.shp.zip"), exdir = temp)

nplSF <- st_read(temp, layer = "npl_admbnda_districts_nd_20201117")

nplRBSF <- st_read(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/shapefiles/Major_River_Basins.shp"))

nplWSSF <- st_read(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/shapefiles/Major_watershed.shp"))

# reading in historical floods
NPLHistFloods <- readxl::read_xlsx(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/unrco/NepalHistoricalFlood1971-2020.xlsx"))

# reading in GLOFAS Data
NPLGLOFASNC <- nc_open(paste0(Sys.getenv("AA_DATA_DIR"),                        "/public/processed/npl/glofas/npl_cems-glofas-historical_v3_incorrect-coords.nc"))

NPLGLOFAS <- tibble(Chatara = ncvar_get(NPLGLOFASNC, "Chatara_v3"),
                    Chisapani = ncvar_get(NPLGLOFASNC, "Chisapani_v3"),
                    Time = as.Date("1979-01-01") + (NPLGLOFASNC$dim$time$vals))

nc_close(NPLGLOFASNC)

NPLWaterLevel <- read_csv(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/dhm/processed/waterl_level_procssed.csv"))

# subsetting shapefiles
nplRBSF2 <- nplRBSF %>%
    filter(Major_Basi %in% "Karnali River Basin")
nplWSSF2 <- nplWSSF %>%
    filter(WSH_NME %in% "Saptakoshi Watershed")

# box subset function
BoxFXN <- function(shapeFile, basin){
    BasinBox <- shapeFile %>%
        filter({if("Major_Basi" %in% names(.)) Major_Basi else WSH_NME} == basin) %>%
        extent()
    
    BoxXMin <- which.min(abs(BasinBox[1] - round(ncvar_get(ncObj, "X"), 3)))
    BoxXMax <- which.min(abs(BasinBox[2] - round(ncvar_get(ncObj, "X"), 3)))
    BoxXLen <- BoxXMax - BoxXMin + 1
    BoxYMin <- which.min(abs(BasinBox[3] - round(ncvar_get(ncObj, "Y"), 3)))
    BoxYMax <- which.min(abs(BasinBox[4] - round(ncvar_get(ncObj, "Y"), 3)))
    BoxYLen <- BoxYMin - BoxYMax + 1
    DataCube <- ncvar_get(ncObj, "precipitation", 
                             start = c(BoxXMin, BoxYMax, 1), 
                             count = c(BoxXLen, BoxYLen, 1)) %>%
        data.frame() %>%
        bind_cols(paste0(round(ncvar_get(ncObj, "X")[BoxXMin:BoxXMax], 3), "E")) %>%
        setNames(c(paste0(round(ncvar_get(ncObj, "Y")[BoxYMax:BoxYMin], 3), "N"), "Longitude")) %>%
        gather(key = "Latitude", value = "precipitation", -Longitude) %>%
        mutate(Date = as.Date(str_extract(ncObj$filename,"(?<=daily_).+(?=_r0.05)"), format = "%Y_%m_%d"), 
               Basin = basin)
    return(DataCube)
}

# function for reading in files 
read_files <- function(filePath, fileName){
    ncObj <- nc_open(paste0(filePath, fileName))
    # Karnali
    KarDataCube <- BoxFXN(nplRBSF, "Karnali River Basin")
    
    # Koshi
    KoshiBox <- BoxFXN(nplWSSF, "Saptakoshi Watershed")
        
    # close
    nc_close(ncObj)
    # data object
    return(bind_rows(KarDataCube, KoshDataCube))
}


# chirps data frame
# chirpsData <- list.files(filePath, pattern = "*.nc") %>%
#     map_df(~ read_files(filePath, .)) 

# to minimise read time
chirpsData <- read_csv(paste0(Sys.getenv("AA_DATA_DIR"), "/public/processed/npl/chirps/BasinsCHIRPSdata.csv"))

```

```{r}
chirpsGrid <- st_sf(st_make_grid(nplRBSF, cellsize = 0.05, offset = c(80.05, 26.3), n = c(163, 83)))
chirpsGrid <- chirpsGrid %>%
    mutate(Centroids = st_centroid(chirpsGrid), 
           Long = round(st_coordinates(Centroids)[,1], 3),
           Lat = paste0(round(st_coordinates(Centroids)[,2], 3), "N"), 
           Coords = paste0(Long, "E", Lat))

chirpsData <- chirpsData %>%
    mutate(Coords = paste0(Longitude, "E", Latitude))

# Karnali
KarnaliGrids <- st_intersection(chirpsGrid, nplRBSF2)
KarnaliCHIRPS <- chirpsData %>%
    filter(Coords %in% KarnaliGrids$Coords)

# Koshi
KoshiGrids <- st_intersection(chirpsGrid, nplWSSF2)
KoshiCHIRPS <- chirpsData %>%
    filter(Coords %in% KoshiGrids$Coords)

chirpsData2 <- bind_rows(KarnaliCHIRPS, KoshiCHIRPS)

```

```{r message=FALSE, warning=FALSE}
# rolling sum
# aggregate all grids into one and find mean
# rolling sum is assigned to last day of window
n = 10
AggNational <- chirpsData2 %>%
    group_by(Date, Basin) %>%
    summarise(rfe = mean(precipitation)) %>%
    group_by(Basin) %>%
    mutate(rollsum = c(rep(0, n-1), rollapplyr(rfe, n, sum))) %>%
    ungroup()
    
# getting top month every year
AggNational2 <- AggNational %>%
    mutate(Year = substr(Date, 1, 4)) %>%
    group_by(Year, Basin) %>%
    top_n(1, rollsum)

ggplot(data = AggNational2, aes(x = Year, y = rollsum, fill = Basin)) + 
    geom_bar(stat="identity", position = "dodge") + 
    theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) + 
    ggtitle("CHIRPS Maximum 10-day Rolling Sum of Precipitation with the Associated Month") +
    xlab("Month") + 
    ylab("Maximum 10-day Rolling Sum(mm)")

# checking for stationarity

adf.test(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"]) # reject H0 and say series is stationary at alpha = 0.05
adf.test(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"]) # reject H0 and say series is stationary at alpha = 0.05

returnValues2 <- AggNational2 %>%
    group_by(Basin) %>%
    summarise(returnyr2 = return.level(fevd(x = rollsum), return.period = 2), 
              returnyr5 = return.level(fevd(x = rollsum), return.period = 5), 
              returnyr10 = return.level(fevd(x = rollsum), return.period = 10))

plot(fevd(x = AggNational2$rollsum[AggNational2$Basin == "Karnali River Basin"]))
plot(fevd(x = AggNational2$rollsum[AggNational2$Basin == "Saptakoshi Watershed"]))

ggplot(data = AggNational2, aes(x = Date, y = rollsum, group = Basin)) + 
    geom_line(aes(colour = Basin)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr2"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr2"]), 
                  label = "RP: 2", vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr2"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr2"]), 
                  label = "RP: 2", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr5"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr5"]), 
                  label = "RP: 5", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr5"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr5"]), 
                  label = "RP: 5", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[2,"returnyr10"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[2,"returnyr10"]), 
                  label = "RP: 10", vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues2[1,"returnyr10"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues2[1,"returnyr10"]), 
                  label = "RP: 10", vjust = -1)) + 
    ggtitle("Maximum 10-day Rolling Sums Per Year with Return Periods") + 
    ylab("Rolling Sums(mm)")

# extracting the return period
mrlplot(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"], main="Mean Residual Life Plot: Karnali River Basin")
mrlplot(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"], main="Mean Residual Life Plot: Saptakoshi Watershed")

threshrange.plot(AggNational$rollsum[AggNational$Basin == "Karnali River Basin"], r = c(0, 100), nint = 25)
threshrange.plot(AggNational$rollsum[AggNational$Basin == "Saptakoshi Watershed"], r = c(0, 150), nint = 25)

returnValues <- AggNational %>%
    group_by(Basin) %>%
    summarise(returnyr2 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                            threshold = 25), return.period = 2), 
              returnyr5 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                            threshold = 25), return.period = 5), 
              returnyr10 = return.level(fevd(x = rollsum, method = "MLE", type="GP", 
                                             threshold = 25), return.period = 10))

ggplot(data = AggNational, aes(x = Date, y = rollsum, group = Basin)) + 
    geom_line(aes(colour = Basin)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr2"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues[1,"returnyr2"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr2"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues[2,"returnyr2"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr5"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues[1,"returnyr5"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr5"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues[2,"returnyr5"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues[1,"returnyr10"]), colour = Basin[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[1,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues[1,"returnyr10"]))), 
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues[2,"returnyr10"]), colour = Basin[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues[2,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues[2,"returnyr10"]))),
                  vjust = -1)) + 
    ggtitle("10-day Rolling Sums with Return Periods in Years") + 
    ylab("Rolling Sums(mm)")

```

```{r}
# comparing historical values with return values
# dates where value was exceeded
AggNational3 <- AggNational %>%
    arrange(Date, Basin) %>%
    mutate(thresh2Yr = rollsum >= unlist(returnValues[,"returnyr2"])) %>%
    mutate(thresh5Yr = rollsum >= unlist(returnValues[,"returnyr5"])) %>%
    mutate(thresh10Yr = rollsum >= unlist(returnValues[,"returnyr10"])) %>%
    filter(thresh2Yr) %>%
    group_by(Basin) %>%
    arrange(Basin, Date) %>%
    # remove if consecutive
    mutate(notConsecutive = c(T, diff(Date) != 1), 
           maxRolWindow = ave(rollsum, cumsum(notConsecutive), FUN = max)) %>%
    filter(rollsum == maxRolWindow)

# write.csv(AggNational3, "C:/Users/pauni/Desktop/Work/OCHA/Nepal/Rolling Sums Exceeding 2year return level.csv", row.names = F)

# summary(ecdf(unique(NPLHistFloods$`Affected Family`)))
NPLHistFloodsWorst <- NPLHistFloods
    # filter(`Affected Family` >= 5000)


unique(NPLHistFloodsWorst$`District Name`[which(!NPLHistFloodsWorst$`District Name` %in% nplSF$DIST_EN)])

```

There are 3 districts in the Historical Floods file not found in the shapefile. On further inspection, there seems to be very slight differences in the name that can be explained by data entry. Changing Makwanpur to Makawanpur, Dhanusa to Dhanusha and Kavrepalanchok to Kabhrepalanchok:

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(`District Name` = str_replace_all(`District Name`, "Makwanpur", "Makawanpur"), 
           `District Name` = str_replace_all(`District Name`, "Dhanusa", "Dhanusha"),
           `District Name` = str_replace_all(`District Name`, "Kavrepalanchok", "Kabhrepalanchok"))
unique(NPLHistFloodsWorst$`District Name`[which(!NPLHistFloodsWorst$`District Name` %in% nplSF$DIST_EN)])

```

Trying to clean up the dates in the Historical Floods Data:
 - Replacing the day column with 0 values with 1 
 - Creating Date column from Year, Month and Amended Day column

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(DayVal = str_replace_all(Day, "0", "1"), 
           AmenDate = as.Date(paste0(Year, "-", Month, "-", DayVal)))
```

Checking which districts are in which water basins:

```{r}
KarnalioverlapVals <- st_intersection(nplRBSF2, nplSF)$DIST_EN
KoshioverlapVals <- st_intersection(nplWSSF2, nplSF)$DIST_EN

```

There are 24 districts that overlap with the Karnali river basin and 4 districts that overlap with the Saptakoshi watershed.

Filtering the Historical Flood Data using these districts:

```{r}
NPLHistFloodsWorst <- NPLHistFloodsWorst %>%
    mutate(Basin = ifelse(`District Name` %in% KarnalioverlapVals, "Karnali River Basin", 
                          ifelse(`District Name` %in% KoshioverlapVals, "Saptakoshi Watershed", "Other"))) %>%
    filter(Basin %in% c("Karnali River Basin", "Saptakoshi Watershed"))
    
unique(NPLHistFloodsWorst$`District Name`[NPLHistFloodsWorst$Basin == "Karnali River Basin"])
unique(NPLHistFloodsWorst$`District Name`[NPLHistFloodsWorst$Basin == "Saptakoshi Watershed"])

```

There is data for 24 districts for the Karnali River Basin and data for 4 districts for the Saptakoshi watershed.

Comparing the data for the 2 river basins:

```{r}
# joining the two dataframes using full join
CompleteDF <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Date, units = "days"), 
           WeekDiff = difftime(AmenDate, Date, units = "weeks")) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(AmenDate) %>%
    filter(TimeDiff >= 0 & TimeDiff <= 30) %>%
    slice(which.min(TimeDiff))

```

The analysis shows that one of the flood events were preceded by some extreme rainfall events for the Karnali water basin. A negative time difference value shows that the flooding occurred before the rain event. 

# Comparing Actual Flood Event and CHIRPS Extreme Rainfall Event

```{r}
# finding false positives
# flood event did not occur but there was an extreme rainfall event
FloodCheckFP <- NPLHistFloodsWorst %>%
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Date, units = "days"), 
           WeekDiff = difftime(AmenDate, Date, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(Date, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate <- sum(FloodCheckFP$TPVals == 0)/nrow(FloodCheckFP)

print(paste0("The proportion of false positive events to number of CHIRPS events is: ", round(FPRate*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by CHIRPS
FloodCheckFN <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Date, units = "days"), 
           WeekDiff = difftime(AmenDate, Date, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(AmenDate, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate <- sum(FloodCheckFN$TNVals == 0)/nrow(FloodCheckFN)

print(paste0("The False Negative Rate is: ", round(FNRate*100, 2), "%."))

# we have to take into account that Flood Data starts earlier than CHIRPS Data.
```


# Comparing Actual Flood Event and GLOFAS Event

```{r}
# matching Chisapani to Karnali and Chatara to Saptakoshi
ggplot(NPLGLOFAS, aes(x = Time)) + 
    geom_line(aes(y = Chisapani)) + 
    geom_line(aes(y = Chatara), color = "blue") + 
    ggtitle("Nepal GLOFAS Data: Chisapani(in black) and Chatara(in blue)") +
    ylab("GLOFAS")

# mrlplot(NPLGLOFAS$Chisapani, main="Mean Residual Life Plot: Chisapani")
# mrlplot(NPLGLOFAS$Chatara, main="Mean Residual Life Plot: Chatara")

# threshrange.plot(NPLGLOFAS$Chisapani, r = c(0, 10000), nint = 20)
# threshrange.plot(NPLGLOFAS$Chatara, r = c(0, 10000), nint = 20)

returnValues3 <- NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    group_by(Station) %>%
    summarise(returnyr2 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 2), 
              returnyr5 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 5), 
              returnyr10 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                             threshold = 6000), return.period = 10))

NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    ggplot(aes(x = Time, y = GLOFAS, group = Station)) + 
    geom_line(aes(colour = Station)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues3[1,"returnyr2"]), colour = Station[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[1,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues3[1,"returnyr2"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues3[2,"returnyr2"]), colour = Station[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[2,"returnyr2"]), 
                  label = paste0("RP: 2-", round(as.numeric(returnValues3[2,"returnyr2"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues3[1,"returnyr5"]), colour = Station[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[1,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues3[1,"returnyr5"]))),
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues3[2,"returnyr5"]), colour = Station[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[2,"returnyr5"]), 
                  label = paste0("RP: 5-", round(as.numeric(returnValues3[2,"returnyr5"]))),
                  vjust = -1)) + 
    geom_hline(aes(yintercept = as.numeric(returnValues3[1,"returnyr10"]), colour = Station[1])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[1,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues3[1,"returnyr10"]))), 
                  vjust = -1)) +
    geom_hline(aes(yintercept = as.numeric(returnValues3[2,"returnyr10"]), colour = Station[2])) + 
    geom_text(aes(as.Date("1980-01-01"), as.numeric(returnValues3[2,"returnyr10"]), 
                  label = paste0("RP: 10-", round(as.numeric(returnValues3[2,"returnyr10"]))),
                  vjust = -1)) + 
    ggtitle("GLOFAS with Return Periods in Years") + 
    ylab("GLOFAS")


AggGLOFAS <- NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    arrange(Time, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    mutate(thresh2Yr = GLOFAS >= unlist(returnValues3[,"returnyr2"])) %>%
    mutate(thresh5Yr = GLOFAS >= unlist(returnValues3[,"returnyr5"])) %>%
    mutate(thresh10Yr = GLOFAS >= unlist(returnValues3[,"returnyr10"])) %>%
    filter(thresh2Yr)

# finding false positives
# flood event did not occur but there was a GLOFAS event
# assumption is that on-the-ground is recorded on the day of or before GLOFAS records an event

FloodCheckFP2 <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggGLOFAS, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Time, units = "days"), 
           WeekDiff = difftime(AmenDate, Time, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(Time, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate2 <- sum(FloodCheckFP2$TPVals == 0)/nrow(FloodCheckFP2)

print(paste0("The proportion of false positive events to number of GLOFAS events is: ", round(FPRate2*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by GLOFAS
FloodCheckFN2 <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggGLOFAS, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, Time, units = "days"), 
           WeekDiff = difftime(AmenDate, Time, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(AmenDate, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate2 <- sum(FloodCheckFN2$TNVals == 0)/nrow(FloodCheckFN2)

print(paste0("The False Negative Rate is: ", round(FNRate2*100, 2), "%."))

```

# Comparing GLOFAS Events and CHIRPS Events

```{r}

# finding false positives
# flood event did not occur but there was a GLOFAS event
# assumption is that CHIRPS event occurs before GLOFAS records an event

FloodCheckFP3 <- AggGLOFAS %>% 
    dplyr::select(Basin, Time) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Time, Date, units = "days"), 
           WeekDiff = difftime(Time, Date, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(Date, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate3 <- sum(FloodCheckFP3$TPVals == 0)/nrow(FloodCheckFP3)

print(paste0("The proportion of false positive GLOFAS events to number of CHIRPS events is: ", round(FPRate3*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by GLOFAS
FloodCheckFN3 <- AggGLOFAS %>% 
    dplyr::select(Basin, Time) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Time, Date, units = "days"), 
           WeekDiff = difftime(Time, Date, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(Time, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate3 <- sum(FloodCheckFN3$TNVals == 0)/nrow(FloodCheckFN3)

print(paste0("The False Negative Rate is: ", round(FNRate3*100, 2), "%."))

```

# Comparing Water Levels and CHIRPS Event

```{r}
ggplot(NPLWaterLevel, aes(x = date)) + 
    geom_line(aes(y = Chisapani)) + 
    geom_line(aes(y = Chatara), color = "blue") + 
    ggtitle("Nepal Water Level Data: Chisapani(in black) and Chatara(in blue)") +
    ylab("Water Level")

returnValues4 <- tibble(Station = c("Chatara", "Chisapani"), 
                        returnyr2 = c(return.level(fevd(x = NPLWaterLevel$Chatara, method = "MLE", type="GP", 
                                                        threshold = 6, na.action = na.remove), 
                                                   return.period = 2), 
                                      return.level(fevd(x = NPLWaterLevel$Chisapani, method = "MLE",
                                                        type="GP", threshold = 9.5, na.action = na.remove), 
                                                   return.period = 2)),
                        returnyr5 = c(return.level(fevd(x = NPLWaterLevel$Chatara, method = "MLE", type="GP", 
                                                        threshold = 6, na.action = na.remove), 
                                                   return.period = 5), 
                                      return.level(fevd(x = NPLWaterLevel$Chisapani, method = "MLE",
                                                        type="GP", threshold = 9.5, na.action = na.remove), 
                                                   return.period = 5)),
                        returnyr10 = c(return.level(fevd(x = NPLWaterLevel$Chatara, method = "MLE", type="GP", 
                                                        threshold = 6, na.action = na.remove), 
                                                   return.period = 10), 
                                      return.level(fevd(x = NPLWaterLevel$Chisapani, method = "MLE",
                                                        type="GP", threshold = 9.5, na.action = na.remove), 
                                                   return.period = 10)))
    
    
AggWaterLevel <- NPLWaterLevel %>%
    dplyr::select(date, Chatara, Chisapani) %>%
    pivot_longer(cols = c("Chatara", "Chisapani"), names_to = "Station", values_to = "WaterLevel") %>%
    arrange(date, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    mutate(thresh2Yr = WaterLevel >= unlist(returnValues4[,"returnyr2"])) %>%
    mutate(thresh5Yr = WaterLevel >= unlist(returnValues4[,"returnyr5"])) %>%
    mutate(thresh10Yr = WaterLevel >= unlist(returnValues4[,"returnyr10"])) %>%
    filter(thresh2Yr)

FloodCheckFP4 <- AggWaterLevel %>% 
    dplyr::select(Basin, date) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Date, date, units = "days"), 
           WeekDiff = difftime(Date, date, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(Date, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate4 <- sum(FloodCheckFP4$TPVals == 0)/nrow(FloodCheckFP4)

print(paste0("The proportion of false positive events to number of High Water Level events is: ", round(FPRate4*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by GLOFAS
FloodCheckFN4 <- AggWaterLevel %>% 
    dplyr::select(Basin, date) %>%
    full_join(AggNational3, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Date, date, units = "days"), 
           WeekDiff = difftime(Date, date, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(date, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate4 <- sum(FloodCheckFN4$TNVals == 0)/nrow(FloodCheckFN4)

print(paste0("The False Negative Rate is: ", round(FNRate4*100, 2), "%."))

```

# Comparing Water Levels and Actual Events

```{r}

FloodCheckFP5 <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggWaterLevel, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, date, units = "days"), 
           WeekDiff = difftime(AmenDate, date, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(date, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate5 <- sum(FloodCheckFP5$TPVals == 0)/nrow(FloodCheckFP5)

print(paste0("The proportion of false positive events to number of Historical Floods events is: ", round(FPRate5*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by GLOFAS
FloodCheckFN5 <- NPLHistFloodsWorst %>% 
    dplyr::select(Basin, AmenDate) %>%
    full_join(AggWaterLevel, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(AmenDate, date, units = "days"), 
           WeekDiff = difftime(AmenDate, date, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(AmenDate, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate5 <- sum(FloodCheckFN5$TNVals == 0)/nrow(FloodCheckFN5)

print(paste0("The False Negative Rate is: ", round(FNRate5*100, 2), "%."))

```

# Comparing Water Levels and GLOFAS

```{r}

FloodCheckFP6 <- AggGLOFAS %>% 
    dplyr::select(Basin, Time) %>%
    full_join(AggWaterLevel, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Time, date, units = "days"), 
           WeekDiff = difftime(Time, date, units = "weeks"), 
           FPCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding
    group_by(Time, Basin) %>%
    summarise(TPVals = sum(FPCheck, na.rm = T))

FPRate6 <- sum(FloodCheckFP6$TPVals == 0)/nrow(FloodCheckFP6)

print(paste0("The proportion of false positive events to number of High Water Level events is: ", round(FPRate6*100, 2), "%."))

# finding false negatives
# flood event occurred but not captured by GLOFAS
FloodCheckFN6 <- AggGLOFAS %>% 
    dplyr::select(Basin, Time) %>%
    full_join(AggWaterLevel, by = "Basin") %>%
    # rain event happens before flood event
    mutate(TimeDiff = difftime(Time, date, units = "days"), 
           WeekDiff = difftime(Time, date, units = "weeks"), 
           FNCheck = ifelse(TimeDiff >= 0 & TimeDiff <= 30, T, F)) %>%
    # for each reported date of flooding which was the closest excess rainfall event
    # for each reported date of flooding which was the closest excess rainfall event
    group_by(date, Basin) %>%
    summarise(TNVals = sum(FNCheck, na.rm = T))

FNRate6 <- sum(FloodCheckFN6$TNVals == 0)/nrow(FloodCheckFN6)

print(paste0("The False Negative Rate is: ", round(FNRate6*100, 2), "%."))

```
