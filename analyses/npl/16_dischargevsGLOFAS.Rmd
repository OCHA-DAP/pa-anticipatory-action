---
title: "DischargevsGLOFAS"
output: md_document
---

## Analysis of Discharge Data (DHM) vs GLOFAS Data

```{r intro, echo=FALSE, warning = FALSE, message=FALSE, results='hide'}
options(scipen = 100000)

library(tidyverse)
library(ncdf4)
library(extRemes)

```

### Reading in the files

```{r}
# reading in GLOFAS Data
NPLGLOFASNC <- nc_open(paste0(Sys.getenv("AA_DATA_DIR"),                        "/public/processed/npl/glofas/npl_cems-glofas-historical_v3_incorrect-coords.nc"))

NPLGLOFAS <- tibble(Chatara = ncvar_get(NPLGLOFASNC, "Chatara_v3"),
                    Chisapani = ncvar_get(NPLGLOFASNC, "Chisapani_v3"),
                    Time = as.Date("1979-01-01") + (NPLGLOFASNC$dim$time$vals))

nc_close(NPLGLOFASNC)

# reading in discharge data
NPLFlowChatara <- read.table(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/dhm/raw/daily_flow/DFL_695 Koshi Chatara.txt"), sep = ",", skip = 21)
NPLFlowChisapani <- read.table(paste0(Sys.getenv("AA_DATA_DIR"), "/private/exploration/npl/dhm/raw/daily_flow/DFL_280 Karnali Chisapani.txt"), sep = ",", skip = 21)
NPLFlow <- rbind(
    cbind(NPLFlowChatara, Basin = "Saptakoshi Watershed"),
    cbind(NPLFlowChisapani, Basin = "Karnali River Basin")
)
colnames(NPLFlow)[1:2] <- c("Dates", "Flow")
NPLFlow <- NPLFlow %>%
    mutate(Dates = as.Date(Dates, format = "%d/%b/%Y"))

```

# Plotting the 2 time series

```{r}
# Chatara Station/Saptakoshi Watershed
NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    filter(Station == "Chatara") %>%
    ggplot(aes(x = Time, y = GLOFAS)) + 
    geom_line(colour = "dark blue") + 
    geom_line(data = NPLFlow[NPLFlow$Basin %in% "Saptakoshi Watershed",], aes(x = Dates, y = Flow), colour = "dark orange") + 
    ggtitle("Comparison of GLOFAS(blue) and Discharge Data(orange) for Chatara Station/Saptakoshi Watershed")

# Chisapani Station/Karnali River Basin
NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    filter(Station == "Chisapani") %>%
    ggplot(aes(x = Time, y = GLOFAS)) + 
    geom_line(colour = "dark blue") + 
    geom_line(data = NPLFlow[NPLFlow$Basin %in% "Karnali River Basin",], aes(x = Dates, y = Flow), colour = "dark orange") + 
    ggtitle("Comparison of GLOFAS(blue) and Discharge Data(orange) for Chisapani Station/Karnali River Basin")

```
##### The data do not overlap and from a visual standpoint, it appears the time series show some differences for the extreme events.


# Discharge Data vs GLOFAS
### Getting the return values for DHM data (1 in 2, 5, and 10 years)
#### Using Peaks over threshold as we are using daily data. 

```{r}
# summary function
summaryFXN <- function(DF1, DF2, DateCol1, DateCol2){
    FloodCheck <- DF1 %>%
        dplyr::select(Basin, {{ DateCol1 }}) %>%
        full_join(DF2, by = "Basin") 
    FloodCheck[,"TimeDiff"] <- difftime(FloodCheck[[DateCol1]], FloodCheck[[DateCol2]], units = "days")
    FloodCheck[,"Check"] <- ifelse(FloodCheck$TimeDiff >= -15 & FloodCheck$TimeDiff <= 15, T, F)
    
    return(FloodCheck)
}

# return values for 1 in 2, 5 and 10 year period
returnValuesDHM <- NPLFlow %>%
    group_by(Basin) %>%
    summarise(returnyr2 = return.level(fevd(x = Flow, method = "MLE", type="GP", 
                                            threshold = 4000), return.period = 2), 
              returnyr5 = return.level(fevd(x = Flow, method = "MLE", type="GP", 
                                            threshold = 4000), return.period = 5), 
              returnyr10 = return.level(fevd(x = Flow, method = "MLE", type="GP", 
                                             threshold = 4000), return.period = 10))
# filtering for 1 in 2 year RP
AggFlow2yr <- NPLFlow %>%
    arrange(Dates, Basin) %>%
    left_join(returnValuesDHM, by = "Basin") %>%
    mutate(thresh2Yr = Flow >= returnyr2) %>%
    mutate(thresh5Yr = Flow >= returnyr5) %>%
    mutate(thresh10Yr = Flow >= returnyr10) %>%
    filter(thresh2Yr)
```

### Getting the return values for GLOFAS data (1 in 2, 5, and 10 years)
#### Using Peaks over threshold as we are using daily data. 
 
```{r}
returnValuesGlofas <- NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    group_by(Station) %>%
    summarise(returnyr2 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 2), 
              returnyr5 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 5), 
              returnyr10 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                             threshold = 6000), return.period = 10)) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed"))

AggGLOFAS2yr <- NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    arrange(Time, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    left_join(returnValuesGlofas, by = "Basin") %>%
    mutate(thresh2Yr = GLOFAS >= returnyr2) %>%
    mutate(thresh5Yr = GLOFAS >= returnyr5) %>%
    mutate(thresh10Yr = GLOFAS >= returnyr10) %>%
    filter(thresh2Yr)

```

#### Getting the FP, FN, TP values from the data sets

For FP, we work around the dates for the alternative data set. Checking for which dates show flooding in the alternative data set that do not show up in the ground truth data 

For FN and TP, we work around dates for the ground truth. Checking which dates show no floods and show floods that match up with the alternative data set.

```{r}
FloodCheckpos <- summaryFXN(AggGLOFAS2yr, AggFlow2yr, "Time", "Dates") %>%
    # Date of data to be checked
    group_by(Basin, Time) %>%
    summarise(TPVals = sum(Check, na.rm = T))
FloodCheckneg <- summaryFXN(AggGLOFAS2yr, AggFlow2yr, "Time", "Dates") %>%
    #Date of ground truth
    group_by(Basin, Dates) %>%
    summarise(TNVals = sum(Check, na.rm = T))
FloodStats2yr <- FloodCheckpos %>%
    group_by(Basin) %>%
    summarise(FP = sum(TPVals == 0)) %>%
    left_join(FloodCheckneg %>%
                  group_by(Basin) %>%
                  summarise(FN = sum(TNVals == 0), TP = sum(TNVals != 0)), by = "Basin")

```

# Using 1 in 5 years return period

```{r}
AggFlow5yr <- NPLFlow %>%
    arrange(Dates, Basin) %>%
    left_join(returnValuesDHM, by = "Basin") %>%
    mutate(thresh2Yr = Flow >= returnyr2) %>%
    mutate(thresh5Yr = Flow >= returnyr5) %>%
    mutate(thresh10Yr = Flow >= returnyr10) %>%
    filter(thresh5Yr)

AggGLOFAS5yr <- NPLGLOFAS %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    arrange(Time, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    left_join(returnValuesGlofas, by = "Basin") %>%
    mutate(thresh2Yr = GLOFAS >= returnyr2) %>%
    mutate(thresh5Yr = GLOFAS >= returnyr5) %>%
    mutate(thresh10Yr = GLOFAS >= returnyr10) %>%
    filter(thresh5Yr)

FloodCheckpos <- summaryFXN(AggGLOFAS5yr, AggFlow5yr, "Time", "Dates") %>%
    # Date of data to be checked
    group_by(Basin, Time) %>%
    summarise(TPVals = sum(Check, na.rm = T))
FloodCheckneg <- summaryFXN(AggGLOFAS5yr, AggFlow5yr, "Time", "Dates") %>%
    #Date of ground truth
    group_by(Basin, Dates) %>%
    summarise(TNVals = sum(Check, na.rm = T))
FloodStats5yr <- FloodCheckpos %>%
    group_by(Basin) %>%
    summarise(FP = sum(TPVals == 0)) %>%
    left_join(FloodCheckneg %>%
                  group_by(Basin) %>%
                  summarise(FN = sum(TNVals == 0), TP = sum(TNVals != 0)), by = "Basin")
```

## Filtering for only dates with Discharge Data

The data sets do not overlap exactly and issue is that the extreme events may be in the period they do not overlap.

```{r}
returnValuesGlofas2 <- NPLGLOFAS %>%
    filter(between(Time, min(NPLFlow$Dates), max(NPLFlow$Dates))) %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    group_by(Station) %>%
    summarise(returnyr2 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 2), 
              returnyr5 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                            threshold = 6000), return.period = 5), 
              returnyr10 = return.level(fevd(x = GLOFAS, method = "MLE", type="GP", 
                                             threshold = 6000), return.period = 10)) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed"))

AggGLOFAS2yr2 <- NPLGLOFAS %>%
    filter(between(Time, min(NPLFlow$Dates), max(NPLFlow$Dates))) %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    arrange(Time, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    left_join(returnValuesGlofas2, by = "Basin") %>%
    mutate(thresh2Yr = GLOFAS >= returnyr2) %>%
    mutate(thresh5Yr = GLOFAS >= returnyr5) %>%
    mutate(thresh10Yr = GLOFAS >= returnyr10) %>%
    filter(thresh2Yr)

FloodCheckpos <- summaryFXN(AggGLOFAS2yr2, AggFlow2yr, "Time", "Dates") %>%
    # Date of data to be checked
    group_by(Basin, Time) %>%
    summarise(TPVals = sum(Check, na.rm = T))
FloodCheckneg <- summaryFXN(AggGLOFAS2yr2, AggFlow2yr, "Time", "Dates") %>%
    #Date of ground truth
    group_by(Basin, Dates) %>%
    summarise(TNVals = sum(Check, na.rm = T))
FloodStats2yr2 <- FloodCheckpos %>%
    group_by(Basin) %>%
    summarise(FP = sum(TPVals == 0)) %>%
    left_join(FloodCheckneg %>%
                  group_by(Basin) %>%
                  summarise(FN = sum(TNVals == 0), TP = sum(TNVals != 0)), by = "Basin")

AggGLOFAS5yr2 <- NPLGLOFAS %>%
    filter(between(Time, min(NPLFlow$Dates), max(NPLFlow$Dates))) %>%
    pivot_longer(cols = starts_with("C"), names_to = "Station", values_to = "GLOFAS") %>%
    arrange(Time, Station) %>%
    mutate(Basin = ifelse(Station == "Chisapani", "Karnali River Basin", "Saptakoshi Watershed")) %>%
    left_join(returnValuesGlofas2, by = "Basin") %>%
    mutate(thresh2Yr = GLOFAS >= returnyr2) %>%
    mutate(thresh5Yr = GLOFAS >= returnyr5) %>%
    mutate(thresh10Yr = GLOFAS >= returnyr10) %>%
    filter(thresh5Yr)

FloodCheckpos <- summaryFXN(AggGLOFAS5yr2, AggFlow5yr, "Time", "Dates") %>%
    # Date of data to be checked
    group_by(Basin, Time) %>%
    summarise(TPVals = sum(Check, na.rm = T))
FloodCheckneg <- summaryFXN(AggGLOFAS5yr2, AggFlow5yr, "Time", "Dates") %>%
    #Date of ground truth
    group_by(Basin, Dates) %>%
    summarise(TNVals = sum(Check, na.rm = T))
FloodStats5yr2 <- FloodCheckpos %>%
    group_by(Basin) %>%
    summarise(FP = sum(TPVals == 0)) %>%
    left_join(FloodCheckneg %>%
                  group_by(Basin) %>%
                  summarise(FN = sum(TNVals == 0), TP = sum(TNVals != 0)), by = "Basin")

```

Both 1 in 2 year and 1 in 5 year return periods do not show a significant pattern in the data. There are drops in the false positive rates when only using dates with overlap. The FN and FP values are still higher than the TP rates. 

The criterion being that the events must have happened within 15 days of each other, it raises questions on the underlying data and their correlation.
