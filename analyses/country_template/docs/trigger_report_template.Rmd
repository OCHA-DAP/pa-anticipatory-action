---
title: '<img src="https://drive.google.com/uc?id=118y5T73-iSUZoAMtoJGddxq9QzD_GDKX" style="height:40px;float:left; margin:10px" /><img src="https://drive.google.com/uc?id=1fHQUzF3ZjaoHj9KQ33-94dK_X1hcmjzW" style="height:50px;float:left; margin:10px" />'
pagetitle: 'AA Trigger Report'
output:
  html_document:
    css: style.css
    includes:
      in_header: header.html
    toc: no
    toc_float: yes
    toc_depth: '4'
    df_print: paged
  html_notebook:
    css: style.css
    includes:
      in_header: header.html
    toc: no
    toc_float: yes
    toc_depth: '4'
    df_print: paged
editor_options:
  chunk_output_type: console
---
<style type="text/css">
.main-container {
  max-width: 90%;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r hard-coded values, echo = FALSE, message = FALSE, warning = FALSE}
country_name <- "Country Name"
shock <- "Shock"
plots_path <- ""
shock_return_period <- "1 in X years"
nbr_hist_shocks <-"X shocks"
hist_period <- "XXXX - XXXX" # eg: 1980 - 2021
prob_min_frmwk_activation <- 0.79 # input number only, in decimal format
prob_full_frmwk_activation <- 0.13 # input number only, in decimal format

# trigger A info  **** DEFAULTS TO CHANGE **** 
type_a <- 'eg: Predictive' 
timepoints_a<- 'eg: Jan, Feb, Mar'
package_a <- 'TBC' # input number only, no $ sign or 'm' for million
funding_a <- 'X'
predicted_window_a <- 'eg: JAS' 
lead_time_a <- 'eg: 7-5 months' # change units as needed. Include all lead times if multiple activation timepoints
prob_trigger_activation_a <- 0.42 #  input number only, in decimal format

# trigger B info  **** DEFAULTS TO CHANGE IF THERE IS A TRIGGER B **** 
type_b <- 'eg: Predictive'
timepoints_b <- 'eg: Apr, May, Jun'
package_b <- 'TBC'
funding_b <- 'X' 
predicted_window_b <- 'eg: ASO'
lead_time_b <- 'eg: 4-1 months'
prob_trigger_activation_b <- 0.23 

# trigger C info  **** DEFAULTS TO CHANGE IF THERE IS A TRIGGER C **** 
type_c <- 'eg: Observational'
timepoints_c <- 'eg: Jul'
package_c <- 'TBC'
funding_c <- 'X'
predicted_window_c <- 'N/A'
lead_time_c <- 'N/A'
prob_trigger_activation_c <- 0.78

```

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = TRUE) # include chunk output by default
knitr::opts_chunk$set(message = FALSE) # do not print messages by default
knitr::opts_chunk$set(warning = FALSE) # do not print warnings by default

options(scipen = 999) # turn off scientific notation
options(encoding = "UTF-8") # set encoding to UTF-8 instead of ANSI
```

```{r libraries, include = FALSE}
packages <- c('tidyverse', 'ggthemes', 'kableExtra', 'knitr', 'flextable')

# install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load libraries 
lapply(packages, library, character.only = TRUE)

```

```{r functions}
computeCIwidths <- function(metric_name) { 
  df %>%
  filter(metric == metric_name) %>%
  pivot_wider(names_from = point, values_from = value) %>%
  mutate(below_ci = low_end,  # width between zero and low end of CI
         ci = high_end - low_end,# width of CI
         above_ci = 100 - high_end) %>% # width between high_end of CI and 100
  pivot_longer(!c('metric','dummy'), names_to = 'point', values_to = 'value')
}
```

```{r data loading and formatting}
# read in performance metrics file
df <- data.frame(metric = c('var','var','var','far','far','far', 'det', 'det', 'det', 'mis', 'mis', 'mis', 'acc', 'acc', 'acc'),
                  point = c('low_end', 'central', 'high_end','low_end', 'central', 'high_end', 'low_end', 'central', 'high_end', 'low_end', 'central', 'high_end', 'low_end', 'central', 'high_end'), 
                   value = c(85, 91, 97, 20, 32, 42, 83, 89, 95, 16, 28, 38, 45, 50, 55),
                   dummy = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1, 1, 1)
                 )

# format probabilities
prob_trigger_activation_a <- paste0(round(prob_trigger_activation_a * 100, 1), '%')
prob_trigger_activation_b <- paste0(round(prob_trigger_activation_b * 100, 1), '%')
prob_trigger_activation_c <- paste0(round(prob_trigger_activation_c * 100, 1), '%')
prob_min_frmwk_activation <- paste0(round(prob_min_frmwk_activation * 100, 1), '%')
prob_full_frmwk_activation <- paste0(round(prob_full_frmwk_activation * 100, 1), '%')

# format funding amounts
funding_a <- paste0('$',funding_a,'m')
funding_b <- paste0('$',funding_b,'m')
funding_c <- paste0('$',funding_c,'m')

# TO REMOVE df dummy data above
# TO ADD read in data from analysis output file (csv)
# TO ADD data validation: values between 0 and 100, rounded to 1 decimal, low_end < central < high_end
# TO ADD filter df by metric if all values in 1 file 
```

```{r compute CI measurements}

# compute width and position of CI 
df_var <- computeCIwidths(metric_name = 'var') # valid activation rate 
df_det <- computeCIwidths(metric_name = 'det') # detection rate
df_far <- computeCIwidths(metric_name = 'far') # false alarm rate
df_mis <- computeCIwidths(metric_name = 'mis') # miss rate
df_acc <- computeCIwidths(metric_name = 'acc') # accuracy rate
#df_act <- computeCIwidths(metric_name = 'act') # prob trigger activation
#df_min <- computeCIwidths(metric_name = 'min') # prob minimum framework activation 
#df_ful <- computeCIwidths(metric_name = 'ful') # prob full framework activation 

```

```{r data plotting}
source("computeCIplots.R")

plotCI(dataframe = df_var, metric = 'var_ci') 
plotCI(dataframe = df_det, metric = 'det_ci') 
plotCI(dataframe = df_far, metric = 'far_ci') 
plotCI(dataframe = df_mis, metric = 'mis_ci') 
#plotCI(dataframe = df_acc, metric = 'acc_ci') 
#plotCI(dataframe = df_min, metric = 'min_ci') 
#plotCI(dataframe = df_ful, metric = 'ful_ci') 
```

<br> 
<br>
<br>

# Anticipatory Action Trigger Mechanism Report

&nbsp;

### Country: `r country_name`
### Shock: `r shock`
### Last updated: `r Sys.Date()`

&nbsp;

---

## Data sources

### Historical shocks 
* Compiled by X [Link to dataset on HDX]

### Forecasts
* Product 1 Name [Link to provider’s data portal]. Published [frequency, schedule].
* Product 2 Name [Link to provider’s data portal]. Published [frequency, schedule].

### Other data
* [Specify] [Link to dataset on HDX]

&nbsp;

## Analysis
Performed by the Centre for Humanitarian Data. Publicly available here [link to Github repo].

&nbsp;

## Trigger Mechanism Snapshot
```{r mechanism snapshot, include = TRUE}

snapshot_df <- data.frame(row_name = c('Type', 
                                       'Activation Timepoints', 
                                       'Predicted Window', 
                                       'Lead Time', 
                                       'Valid Activation Rate', 
                                       'Detection Rate', 
                                       'False Alarm Rate', 
                                       'Miss Rate' , 
                                       'Shock Return Period', 
                                       'Nbr of Historical Shocks', 
                                       'Historical Period', 
                                       'Activity Package', 
                                       'Funding Package', 
                                       'Prob. Trigger Activation', 
                                       'Prob. Min. Frwk Activ.', 
                                       'Prob. Full Frwk Activ.'),
                       trigger_a = c(type_a, 
                                     timepoints_a, 
                                     predicted_window_a, 
                                     lead_time_a, 
                                     paste0("<img src=trimmed_var_ci.png"), 
                                     paste0("<img src=trimmed_det_ci.png"), 
                                     paste0("<img src=trimmed_far_ci.png"), 
                                     paste0("<img src=trimmed_mis_ci.png"), 
                                     shock_return_period, 
                                     nbr_hist_shocks, 
                                     hist_period, 
                                     package_a, 
                                     funding_a, 
                                     paste0("<img src=trimmed_var_ci.png"), # TO CHANGE to prob of trigger activation CI plot FOR TRIGGER A
                                     "Covers all triggers",  
                                     "Covers all triggers"),
                       trigger_b = c(type_b, 
                                     timepoints_b, 
                                     predicted_window_b, 
                                     lead_time_b, 
                                     paste0("<img src=trimmed_var_ci.png"),
                                     paste0("<img src=trimmed_det_ci.png"),  
                                     paste0("<img src=trimmed_far_ci.png"), 
                                     paste0("<img src=trimmed_mis_ci.png"), 
                                     shock_return_period,
                                     nbr_hist_shocks, 
                                     hist_period, 
                                     package_b, 
                                     funding_b, 
                                     paste0("<img src=trimmed_var_ci.png"), # TO CHANGE to prob of trigger activation CI plot FOR EACH TRIGGER
                                     paste0("<","img src=","trimmed_var_ci",".png",">"), # TO CHANGE TO PROB OF MIN/FULL FRAMEWORK ACTIVATION PLOTS
                                     paste0("<","img src=","trimmed_var_ci",".png",">")), # TO CHANGE TO PROB OF MIN/FULL FRAMEWORK ACTIVATION PLOTS 
                       trigger_c = c(type_c, 
                                     timepoints_c, 
                                     predicted_window_c, 
                                     lead_time_c, 
                                     paste0("<img src=trimmed_var_ci.png"),
                                     paste0("<img src=trimmed_det_ci.png"), 
                                     paste0("<img src=trimmed_far_ci.png"), 
                                     paste0("<img src=trimmed_mis_ci.png"), 
                                     shock_return_period, 
                                     nbr_hist_shocks, 
                                     hist_period, 
                                     package_c, 
                                     funding_c, 
                                     paste0("<img src=trimmed_var_ci.png"), # TO CHANGE to prob of trigger activation CI plot for trigger-C
                                     "Covers all triggers",
                                     "Covers all triggers"))

## TO DO: MAKE TABLE CONDITIONAL ON NUMBER OF TRIGGERS
## TO DO: ADD PLOT PATH TO SRC IN DF

kbl(snapshot_df,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("","Trigger A", "Trigger B", "Trigger C"), 
    align = "rccc") %>%
  kable_minimal(c("hover")) %>%
  row_spec(c(1:4, 9:13), extra_css = "line-height: 25px;") %>%
  row_spec(c(5:8, 14:16), extra_css = "line-height: 45px;") %>%
  column_spec(column = 1, width = "16em", extra_css = "vertical-align: bottom;") %>%
  column_spec(column = c(2:4), width = "22em") %>%
  pack_rows("Description", start_row = 1, end_row = 4, color = '#1bb580') %>%
  pack_rows("Performance", start_row = 5, end_row = 8, color = '#1bb580') %>%
  pack_rows("Shock", start_row = 9, end_row = 11, color = '#1bb580') %>%
  pack_rows("Activation", start_row = 12, end_row = 13, color = '#1bb580') %>%
  pack_rows("Framework Activation", start_row = 15, end_row = 16, colnum = 1, color = "black", label_row_css = "font-size: 12; font-style: italic; text-align: center; background-color: #E5E5E5;") %>%
  kableExtra::footnote(general = "", general_title = "___", symbol = c("Every trigger can reach its threshold and activate independently from the others. Only 1 activation can occur per trigger in a given year."))


```

&nbsp;

## Monitoring & Governance
[Actor] will monitor the trigger(s). If a trigger is met, [Actor] will notify [Recipients] by email within [time delay]. Draft emails can be found here [link].

&nbsp;

## Assumptions & Open questions

```{r learning table}
learning_table <- data.frame(decision = c('Eg: Added a requirement for above average being 5 percentage points above', 'some text'),
                             rationale = c('Eg: A false alarm is costlier when the rains are above average than at normal levels', 'some text'),
                             assumption = c('Eg: A larger delta in probabilities between the two terciles reduces the risk of above average occurring', 'some text'),
                             questions = c('Eg: Does it help reduce false alarms in the face of above average rains? Is it a useful / needed condition?', 'some text'))

## TO REMOVE: mock dataframe above
## TO ADD: read in a csv

kbl(learning_table,
    format = 'html',
    escape = FALSE,
    row.names = FALSE, # omit row numbers
    col.names = c("Decision","Rationale", "Assumption", "Open Question"), 
    align = "llll") %>%
  kable_minimal(c("hover", "striped"))

```

