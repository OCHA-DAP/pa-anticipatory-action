---
title: '<img src="https://drive.google.com/uc?id=118y5T73-iSUZoAMtoJGddxq9QzD_GDKX" style="height:40px;float:align; margin:10px" /><img src="https://drive.google.com/uc?id=1fHQUzF3ZjaoHj9KQ33-94dK_X1hcmjzW" style="height:50px;float:align; margin:10px" />'
pagetitle: 'Malawi Rains Nov 2021 - April 2022'
output:
  html_document:
    css: ../../../country_template/docs/style.css
    includes:
      in_header: ../../../country_template/docs/header.html
    df_print: paged
    toc: yes
    toc_float: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: console
---

<br> 
<br>

## Executive Summary

* Q1: Could Dec/Mar dry spells be included or was the season not started/ended?
* Q2: How do streaks of dry days compare to streaks with max cumulative rainfall?
* Q3: How much rainfall in 14-day periods?

***
## Report Purpose
This report retrospectively examines rainfall patterns during the months of Nov 2021 through April 2022 to provide an evaluation of the trigger mechanism's performance. It uses ARC2 observational rainfall data to investigate rainfall patterns during the rainy season. Specifically, it determines the onset and offset of the rainy season, the frequency of rainy days and rainfall received, and the occurrence of dry streaks and spells. For each, an **exploration of the data** is followed by an **answer to a question** related to the trigger:

* Q1: Could Dec/Mar dry spells be included or was the season not started/ended?
* Q2: How do streaks of dry days compare to streaks with max cumulative rainfall?
* Q3: How much rainfall in 14-day periods? How extreme is the 2mm threshold?

## Background
Malawi implemented a multi-sectorial Anticipation Action Framework for the 2021-2022 rainy season to mitigate the humanitarian impact of dry spells. A trigger mechanism was designed to signal a higher risk of dry spells occurring (the **_predictive_** component) and the actual occurrence of a dry spell (the **_observational_** component) within the Southern region. Dry spells are defined as at least 14 consecutive days with no more than 2mm of cumulative rain. 

```{r global-setup, message = F, warning = F, echo = F}
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = TRUE) # include chunk output by default
knitr::opts_chunk$set(message = FALSE) # do not print messages by default
knitr::opts_chunk$set(warning = FALSE) # do not print warnings by default

options(scipen = 999) # turn off scientific notation
options(encoding = "UTF-8") # set encoding to UTF-8 instead of ANSI
```

```{r libraries, include = F}
packages <- c('tidyverse', 'ggthemes', 'kableExtra', 'knitr', 'flextable', 'terra')

# install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], repos = "https://cran.rstudio.com")
}

# load libraries 
lapply(packages, library, character.only = TRUE)
```

```{r paths}
data_dir <- Sys.getenv("AA_DATA_DIR")
shp_path <- paste0(data_dir, "/public/raw/mwi/cod_ab/mwi_adm_nso_20181016_shp")
postseason_folder_path <- paste0(data_dir, "/public/processed/mwi/dry_spells/2021_2022_postseason/")
```

```{r load_data, include = F}
adm3_shp <- vect(paste0(shp_path, "/mwi_admbnda_adm3_nso_20181016.shp"))
southern_shp <- adm3_shp[adm3_shp$ADM1_EN == 'Southern',]
season_dates <- readRDS(paste0(postseason_folder_path, "season_dates.RDS"))
streaks <- readRDS(paste0(postseason_folder_path, "streaks.RDS"))
in_season <- readRDS(paste0(postseason_folder_path, "in_season.RDS"))
static_r <- rast(paste0(postseason_folder_path, "static_r.tif"))
dry_days_per_month_r <- rast(paste0(postseason_folder_path, "dry_days_per_month_r.tif"))

nbr_cells <- 343 # nbr of cells in southern region (touching=T)
```

## Rainy Season Onset, Cessation and Duration

### Onset
```{r onset-setup}
onset_max <- minmax(static_r$onset)[2]
onset_breaks <- seq(0, onset_max + 7, by = 7) # +7 to ensure the max date is included
onset_labels <-  format(seq(from = as.Date('2021-11-01', format = "%Y-%m-%d"), 
                     to = as.Date('2021-11-01', format = "%Y-%m-%d") + onset_max + 7, 
                     by = "7 days"),
                 format = "%d-%b")

onset_palette <- c(RColorBrewer::brewer.pal(n = 10, name = "PuOr")[5], # one colour per month, darkens later in the month
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[4],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[3],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[2],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[1],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[6],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[7],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[8],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[9],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[10])

```

Season onset is defined as the first day of a period after 1 Nov with at least 40mm of rain over 10 days and no 10 consecutive days with less than 2mm of total rain in the following 30 days (DCCMS 2008).

The map below shows which week (7-day period) the season began. Beige-brown indicates a November onset date while blue-purple indicates Dec. The darker colours reflect onset dates later in the month.

Across the region the rainy season onset was recorded between `r format((as.Date("2021-11-01") + minmax(static_r$onset)[1]), "%d %b")` and `r format((as.Date("2021-11-01") + onset_max), "%d %b")`. Most of the Southern region had an early November start to its season while the northern part of the region saw its season begin in Dec. 

```{r onset-plot}
plot(static_r, 
     "onset", 
     type = "interval", 
     breaks = onset_breaks, 
     main = "Rainy Season Onset",
     axes = F,
     plg = list(title = "Week Starting On",
                legend = onset_labels[-length(onset_labels)]),
     col = onset_palette[1:(length(onset_labels) - 1)]) 
plot(southern_shp, add = T)

```

### Cessation

```{r cessation-setup}
#cessation_max <- minmax(static_r$cessation)[2]
cessation_max <- 156 ## FIX ME

cessation_breaks <- seq(134, (cessation_max + 7), by = 7) # +7 to ensure the max date is included. From = 15 Mar ie as.Date(134, origin = "2021-11-01")
cessation_labels <-  format(seq(from = as.Date('2022-03-15', format = "%Y-%m-%d"), 
                     to = as.Date('2021-11-01', format = "%Y-%m-%d") + cessation_max + 7, # cessation_max computed in days since 1 Nov
                     by = "7 days"),
                 format = "%d-%b")

cessation_palette <- c(RColorBrewer::brewer.pal(n = 10, name = "PuOr")[3], # one colour per month, darkens later in the month
                       RColorBrewer::brewer.pal(n = 10, name = "PuOr")[2],
                       RColorBrewer::brewer.pal(n = 10, name = "PuOr")[1], 
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[6],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[7],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[9],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[10])

```


Season cessation is defined as the last day before a 15-day period after 15 March with 25mm or less of rain (DCCMS 2008).

The map below shows during which week (7-day period) the season ended. Beige-brown indicates a March cessation date while blue-purple indicates April. The darker colours reflect cessation dates later in the month.  **FIX ME**


```{r cessation-plot}
plot(static_r, 
     "cessation", 
     type = "interval", 
     breaks = cessation_breaks, 
     main = "Rainy Season End",
     axes = F,
     plg = list(title = "Week Starting On",
                legend = cessation_labels[-length(cessation_labels)]),
     col = cessation_palette[1:(length(cessation_labels) - 1)])
plot(southern_shp, add = T)

```


### Duration

```{r duration-setup}
#duration_max <- minmax(static_r$duration)[2]
duration_max <- 156 ## FIX ME

duration_breaks <- seq(80, duration_max, by = 10)

duration_palette <-  RColorBrewer::brewer.pal(n = 9, name = "YlGnBu")

```

The map below shows the total duration of the rainy season in number of days between the season onset and cessation dates. 

```{r duration-plot}
plot(static_r, 
     "duration", 
     type = "interval", 
     breaks = duration_breaks, 
     main = "Rainy Season Duration",
     axes = F,
     plg = list(title = "In Days"),
     col = duration_palette[1:(length(duration_breaks) - 1)])
plot(southern_shp, add = T)

```

```{r q1}
perc_nov_onset <- season_dates %>% filter(onset_date < '2021-12-01') %>% summarise(nov_onset = as.numeric(n_distinct(cell))) %>% mutate(round(100 * nov_onset / nbr_cells, 0)) %>% select(-nov_onset) %>% as.numeric()

perc_24dec_onset <- season_dates %>% filter(onset_date <= '2021-12-24') %>% summarise(dec24_onset = as.numeric(n_distinct(cell))) %>% mutate(round(100 * dec24_onset / nbr_cells, 0)) %>% select(-dec24_onset) %>% as.numeric()

onset_90perc_known <- as.numeric(quantile(season_dates$onset_days_since_1nov, 0.9))
onset_50perc_known <- as.numeric(quantile(season_dates$onset_days_since_1nov, 0.5))
```

### Q1: Dec/Mar Dry Spells

The Anticipatory Action (AA) trigger monitored for January and February dry spells. Dry spells have historically occurred in December and March however those months were not monitored due to the difficulty in assessing in real-time whether a dry period during those months were a dry spell or a streak of dry days outside of the rainy season. The 2021-2022 trigger assumed that the rainy season would have begun over the Southern Region by 24 Dec.

The data for 2021-2022 confirms the challenge: while `r perc_nov_onset`% of the Southern Region began its rainy season in November, the remaining saw their season begin in December and as late as `r format(as.Date(onset_max, origin = "2021-11-01"), format = "%d %b")`. Due to the need for 40 days to pass after the onset date to confirm the season has begun, it took until `r format(as.Date(onset_max + 30, origin = "2021-11-01"), format = "%d %b")` to ascertain the onset for the entire region. Until then, it would not have been possible to confirm that a dry period was not an in-season dry spell for `r 100 - perc_nov_onset`% of the region. Note that November onsets could not be confirmed until the second week of December at the earliest, either. For the 2021-2022 season, 50% of onset dates occurred by `r format(as.Date(onset_50perc_known, origin = "2021-11-01"), format = "%d %b")` and 90%  by `r format(as.Date(onset_90perc_known, origin = "2021-11-01"), format = "%d %b")`.

As for cessation dates, [INSERT NARRATIVE HERE]


### KEY TAKEAWAYS
- The assumption of the trigger that the rainy season would have begun across the region by 24 Dec was correct for `r perc_24dec_onset`% of the territory.
- In the Southern Region, Dec and March dry spells are hard to differentiate from dry days outside the rainy season due to the difficulty in rapidly confirming the onset or cessation of the rainy season. 
- A single onset/cessation date for the entire region is not viable. Waiting for confirmation of the onset /cessation dates for the entire region causes too much delay to enable AA: it prevents AA in areas where dry spells occur because the rainy season has not begun or is already over in other areas.
- To address Dec and March dry spells, a probabilistic approach should be used to select onset/cessation dates per district (adm2 area) based on historical patterns (eg: 90% of the time in past 20 years, the season had begun by X for Nsanje). 

<br>

## Rainfall 

During the rainy season there are days during which it rained while other days were dry.

### Rainy Days

The ratio of days that were rainy (rainy = that received at least 3mm of rain) over the duration of the rainy season was computed. It is shown in the graph on the left below as a percentage of days. Yellow areas in the graph received rain on a small portion of days during the rainy season, while the dark blue areas received rain on the majority of days. 

### Rainfall Amount

The graph on the right shows total rainfall during the rainy season. Darker colours captured highest rainfall totals.

<br>

```{r rainy-days-plots}

rainy_ratio_labels <- c( "0-20", "21-40", "41-60", "61-80", "81-100")
  
rain_seas_tot_min <- plyr::round_any(minmax(static_r[["rain_seas_tot"]])[1], 100, f=floor)
rain_seas_tot_max <- plyr::round_any(minmax(static_r[["rain_seas_tot"]])[2], 100, f=ceiling)
rain_seas_tot_breaks <- seq(from = plyr::round_any(rain_seas_tot_min, 100, f=floor), 
                            to = plyr::round_any(rain_seas_tot_max, 100, f=ceiling),
                            by = 100)

par(mfrow = c(1,2),
    mar = c(1, 1, 3, 1)) # bottom, left, top, right.

plot(static_r, 
     "rainy_ratio", 
     breaks = seq(from = 0, to = 100, by = 20), 
     main = "Rainy Days \n During Rainy Season",
     axes = F,
     plg = list(title = "Rainy Days (%)",
                legend = rainy_ratio_labels),
     col = RColorBrewer::brewer.pal(n = 9, name = "YlGnBu"))
plot(southern_shp, add = T)

plot(static_r, 
     "rain_seas_tot", 
     breaks = rain_seas_tot_breaks, 
     main = "Total Rainfall \n During Rainy Season",
     axes = F,
     plg = list(title = "Rainfall (mm)"),
     col = RColorBrewer::brewer.pal(n = 9, name = "Blues"))
plot(southern_shp, add = T)
```

### Monthly Patterns

Days with less than 3mm of rainfall are considered dry days. Below the maps show the number of dry days per month. Note that the maps include days that precede or follow the formal onset or cessation of the rainy season as defined above.

<br>

```{r dry-days-per-month-plot}

dry_days_per_month_breaks <- seq(from = 0, to = 32, by = 5)

par(mfrow = c(1,5),
    mar = c(0, 0, 1.5, 0)) # bottom, left, top, right.

plot(dry_days_per_month_r, 
     "nov", 
     main = "Nov",
     type = "interval", 
     breaks = dry_days_per_month_breaks, 
     axes = F,
     col = rev(viridis::plasma(6)),
     alpha = 0.9,
     legend = "topleft",
     plg = list(title = "Dry Days", cex = 0.7),
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(dry_days_per_month_r, 
     "dec", 
     main = "Dec",
     type = "interval", 
     breaks = dry_days_per_month_breaks, 
     axes = F,
     legend = NULL,
     col = rev(viridis::plasma(6)),
     alpha = 0.9,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(dry_days_per_month_r, 
     "jan", 
     main = "Jan",
     type = "interval", 
     breaks = dry_days_per_month_breaks, 
     axes = F,
     legend = NULL,
     col = rev(viridis::plasma(6)),
     alpha = 0.9,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(dry_days_per_month_r, 
     "feb", 
     main = "Feb",
     type = "interval", 
     breaks = dry_days_per_month_breaks, 
     axes = F,
     legend = NULL,
     col = rev(viridis::plasma(6)),
     alpha = 0.9,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(dry_days_per_month_r, 
     "mar", 
     main = "Mar",
     type = "interval", 
     breaks = dry_days_per_month_breaks, 
     axes = F,
     legend = NULL,
     col = rev(viridis::plasma(6)),
     alpha = 0.9,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)
```


## Streaks

Dry days could be interspersed between rainy days, or tend to group into periods of consecutive dry days. The longest streak of dry days is represented on the right. Note that a dry day can receive up to 3mm of rain while the definition of dry spell used for Anticipatory Action was a 14-day streak with no more than 2mm in total.

### Dry Days Streaks

<br>

```{r longest-streak-plot, fig.show="hold", out.width="100%"}
#dry_ratio_r <- 100 - static_r[["rainy_ratio"]] 
#names(dry_ratio_r) <- "dry_ratio"

perc_bin_labels <- c( "0-20", "21-40", "41-60", "61-80", "81-100")

max_max_streak <- minmax(static_r$max_streak)[2]

plot(static_r, 
     "max_streak", 
     main = "Longest Streak of Dry Days During Rainy Season",
     plg = list(title = "Streak Duration in Days",
                legend = perc_bin_labels))
plot(southern_shp, add = T)
```

<br>

```{r dry-streak-counts-plot, fig.show="hold", out.width="100%"}

# side-by-side of streak counts
lg_min <- min(minmax(static_r$n_5dplus_streaks)[1],
               minmax(static_r$n_7dplus_streaks)[1],
               minmax(static_r$n_10dplus_streaks)[1],
               minmax(static_r$n_14dplus_streaks)[1])

lg_max <- max(minmax(static_r$n_5dplus_streaks)[2],
               minmax(static_r$n_7dplus_streaks)[2],
               minmax(static_r$n_10dplus_streaks)[2],
               minmax(static_r$n_14dplus_streaks)[2]) + 1 # so highest value will be include in legends/breaks

# plot number of streaks
par(mfrow = c(1,4),
    mar = c(1, 1, 2, 1)) # bottom, left, top, right.

plot(static_r, 
     "n_5dplus_streaks", 
     main = "5+day Streaks",
     type = 'continuous',
     breaks = seq(lg_min, lg_max, by = 1),
     axes = F,
     col = RColorBrewer::brewer.pal(name = "Oranges", n = lg_max - 1),
     legend = "topleft",
     plg = list(legend = seq(lg_min, lg_max - 1, by = 1)),
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(static_r, 
     "n_7dplus_streaks", 
     main = "7+day Streaks",
     type = 'continuous',
     breaks = seq(lg_min, lg_max, by = 1),
     axes = F,
     col = RColorBrewer::brewer.pal(name = "Oranges", n = lg_max - 1),
     legend = NULL,
     mar = NA,
     cex.main = 1.3, )
plot(southern_shp, add = T)

plot(static_r, 
     "n_10dplus_streaks", 
     main = "10+day Streaks",
     type = 'continuous',
     breaks = seq(lg_min, lg_max, by = 1),
     axes = F,
     col = RColorBrewer::brewer.pal(name = "Oranges", n = lg_max - 1),
     legend = NULL,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)

plot(static_r, 
     "n_14dplus_streaks", 
     main = "14+day Streaks",
     type = 'continuous',
     breaks = seq(lg_min, lg_max, by = 1),
     axes = F,
     col = RColorBrewer::brewer.pal(name = "Oranges", n = lg_max - 1),
     legend = NULL,
     mar = NA,
     cex.main = 1.3)
plot(southern_shp, add = T)
```

<br>

```{r dry-days-timelines}
#ggplot(subset(in_season, cell = 25), 
#       aes(x=dates, y=rainfall)) +
#       geom_line()
```

### Rainfall during 14-day streaks

During the 2021-2022 season, around `r round(100*ecdf(in_season$roll_sum_next_14d)(2), 2)`% of 14-day periods across the Southern Region received 2 or less mm of rain. This amount of cumulative rainfall, which is the definition of a dry spell selected for AA, is very rare. For comparison, around `r round(100*ecdf(in_season$roll_sum_next_14d)(10), 2)`% received 10 or less mm. The graph below shows shows how frequent was each total rainfall per 14-day period, with the taller bars being the most frequent.

<br>

```{r 14d-cum-rainfall}
  
in_season$lt5_rollsum14d_bin = ifelse(in_season$roll_sum_next_14d <= 5, 1, 0)

in_season %>%
  filter(!is.na(roll_sum_next_14d)) %>%
  ggplot(aes(x=roll_sum_next_14d, fill = lt5_rollsum14d_bin)) +
    geom_histogram(data=subset(in_season, lt5_rollsum14d_bin==1),
                   binwidth = 5, 
                   boundary = 0, # bars are left aligned
                   fill="deeppink4",
                   color="#e9ecef", # bar border
                   alpha=0.9) +
    geom_histogram(data=subset(in_season, lt5_rollsum14d_bin==0),
                   binwidth = 5, 
                   boundary = 0, 
                   fill="#6BAED6",
                   color="#e9ecef", 
                   alpha=0.9) +
    annotate("text", 
             label = "Less than\n5mm", 
             x = 2,
             y = 1200, 
             hjust = 0, 
             vjust = 2, 
             color = "deeppink4") +
  annotate("segment", 
           x = 2, 
           xend = 2, 
           y = 450, 
           yend = 800,
           color = "deeppink4", 
           size = 0.6, 
           linetype='dashed') +
    ggtitle("Rainfall Amounts in 14-day Periods") +
  theme_minimal() +
    theme(
      plot.title = element_text(size=12, hjust = 0.5, vjust = -2),
      axis.title.x = element_text(size=10),
      axis.title.y = element_text(size=10),
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank()) +
  labs(x = "Cumulative Rainfall (mm)",
       y = "Number of 14-day periods",
       caption = "A vertical bar covers a 5mm range.")
```

<br>

In other words, even when allowing for 5 times more rainfall than the selected definition for dry spell, the frequency of occurrence was still significantly less than 5% (a 1 in 20 year event). Note however that the analysis looks at a single year and that thresholds should be set based on historical data over longer period of times. Note also that the analysis examines small areas of about 10 x 10 km so patterns can change when computing metrics for larger areas such as adm2 (district) or adm3 (traditional authority) regions (for instance, by averaging). For AA, the trigger was intentionally designed to target severe, geographically widespread dry spells.
