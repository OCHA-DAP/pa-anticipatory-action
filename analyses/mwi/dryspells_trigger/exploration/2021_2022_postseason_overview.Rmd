---
title: '<img src="https://drive.google.com/uc?id=118y5T73-iSUZoAMtoJGddxq9QzD_GDKX" style="height:40px;float:align; margin:10px" /><img src="https://drive.google.com/uc?id=1fHQUzF3ZjaoHj9KQ33-94dK_X1hcmjzW" style="height:50px;float:align; margin:10px" />'
pagetitle: 'Malawi Rains Nov 2021 - April 2022'
output:
  html_document:
    css: ../../../country_template/docs/style.css
    includes:
      in_header: ../../../country_template/docs/header.html
    df_print: paged
    toc: yes
    toc_float: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options:
  chunk_output_type: console
---

<br> 
<br>

## Executive Summary

* Bullet point 1
* Bullet point 2

***
## Report Purpose
This report retrospectively examines rainfall patterns during the months of Nov 2021 through April 2022 to provide an evaluation of the trigger mechanism's performance. It uses ARC2 observational rainfall data to determine if, when, and where dry spells have occurred during the past year's rainy season.

## Background
Malawi implemented a multi-sectorial Anticipation Action Framework for the 2021-2022 rainy season to mitigate the humanitarian impact of dry spells. A trigger mechanism was designed to signal a higher risk of dry spells occurring (the **_predictive_** component) and the actual occurrence of a dry spell (the **_observational_** component) within the Southern region. Dry spells are defined as at least 14 consecutive days with no more than 2mm of cumulative rain. 

```{r global-setup, message = F, warning = F, echo = F}
knitr::opts_chunk$set(echo = FALSE) # do not print code by default
knitr::opts_chunk$set(include = TRUE) # include chunk output by default
knitr::opts_chunk$set(message = FALSE) # do not print messages by default
knitr::opts_chunk$set(warning = FALSE) # do not print warnings by default

options(scipen = 999) # turn off scientific notation
options(encoding = "UTF-8") # set encoding to UTF-8 instead of ANSI
```

```{r libraries, include = F}
packages <- c('tidyverse', 'ggthemes', 'kableExtra', 'knitr', 'flextable', 'terra')

# install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())

if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], repos = "https://cran.rstudio.com")
}

# load libraries 
lapply(packages, library, character.only = TRUE)
```

```{r paths}
data_dir <- Sys.getenv("AA_DATA_DIR")
shp_path <- paste0(data_dir, "/public/raw/mwi/cod_ab/mwi_adm_nso_20181016_shp")
postseason_folder_path <- paste0(data_dir, "/public/processed/mwi/dry_spells/2021_2022_postseason/")
```

```{r load_data, include = F}
adm3_shp <- vect(paste0(shp_path, "/mwi_admbnda_adm3_nso_20181016.shp"))
southern_shp <- adm3_shp[adm3_shp$ADM1_EN == 'Southern',]
#in_season <- readRDS(paste0(postseason_folder_path, "in_season_daily_measurements.RDS"))
season_dates <- readRDS(paste0(postseason_folder_path, "season_dates.RDS"))
streaks <- readRDS(paste0(postseason_folder_path, "streaks.RDS"))

static_r <- rast(paste0(postseason_folder_path, "static_r.tif"))
```

## Rainy Season Characteristics

### Onset
```{r onset-setup}
onset_max <- minmax(static_r$onset)[2]
onset_breaks <- seq(0, onset_max + 7, by = 7) # +7 to ensure the max date is included
onset_labels <-  format(seq(from = as.Date('2021-11-01', format = "%Y-%m-%d"), 
                     to = as.Date('2021-11-01', format = "%Y-%m-%d") + onset_max + 7, 
                     by = "7 days"),
                 format = "%d-%b")

onset_palette <- c(RColorBrewer::brewer.pal(n = 10, name = "PuOr")[5], # one colour per month, darkens later in the month
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[4],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[3],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[2],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[1],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[6],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[7],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[8],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[9],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[10])

```

Season onset is defined as the first day of a period after 1 Nov with at least 40mm of rain over 10 days and no 10 consecutive days with less than 2mm of total rain in the following 30 days (DCCMS 2008).

The map below shows which week (7-day period) the season began. Beige-brown indicates a November onset date while blue-purple indicates Dec. The darker colours reflect onset dates later in the month.

Across the region the rainy season onset was recorded between `r format((as.Date("2021-11-01") + minmax(static_r$onset)[1]), "%d %b")` and `r format((as.Date("2021-11-01") + onset_max), "%d %b")`. Most of the Southern region had an early November start to its season while the northern part of the region saw its season begin in Dec. 

```{r onset-plot}
plot(static_r, 
     "onset", 
     type = "interval", 
     breaks = onset_breaks, 
     main = "Rainy Season Onset",
     plg = list(title = "Week Starting On",
                legend = onset_labels[-length(onset_labels)]),
     col = onset_palette[1:(length(onset_labels) - 1)]) 
plot(southern_shp, add = T)

```

### Cessation

```{r cessation-setup}
#cessation_max <- minmax(static_r$cessation)[2]
cessation_max <- 156 ## FIX ME

cessation_breaks <- seq(134, (cessation_max + 7), by = 7) # +7 to ensure the max date is included. From = 15 Mar ie as.Date(134, origin = "2021-11-01")
cessation_labels <-  format(seq(from = as.Date('2022-03-15', format = "%Y-%m-%d"), 
                     to = as.Date('2021-11-01', format = "%Y-%m-%d") + cessation_max + 7, # cessation_max computed in days since 1 Nov
                     by = "7 days"),
                 format = "%d-%b")

cessation_palette <- c(RColorBrewer::brewer.pal(n = 10, name = "PuOr")[5], # one colour per month, darkens later in the month
                       RColorBrewer::brewer.pal(n = 10, name = "PuOr")[3],
                       RColorBrewer::brewer.pal(n = 10, name = "PuOr")[1], 
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[6],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[7],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[9],
                   RColorBrewer::brewer.pal(n = 10, name = "PuOr")[10])

```


Season cessation is defined as the last day before a 15-day period after 15 March with 25mm or less of rain (DCCMS 2008).

The map below shows during which week (7-day period) the season ended. Beige-brown indicates a March cessation date while blue-purple indicates April. The darker colours reflect cessation dates later in the month.  **FIX ME**


```{r cessation-plot}
plot(static_r, 
     "cessation", 
     type = "interval", 
     breaks = cessation_breaks, 
     main = "Rainy Season End",
     plg = list(title = "Week Starting On",
                legend = cessation_labels[-length(cessation_labels)]),
     col = cessation_palette[1:(length(cessation_labels) - 1)])
plot(southern_shp, add = T)

```


### Duration

```{r duration-setup}
#duration_max <- minmax(static_r$duration)[2]
duration_max <- 156 ## FIX ME

duration_breaks <- seq(80, duration_max, by = 10)

duration_palette <-  RColorBrewer::brewer.pal(n = 9, name = "YlGnBu")

```

The map below shows the total duration of the rainy season in number of days between the season onset and cessation dates. 

```{r duration-plot}
plot(static_r, 
     "duration", 
     type = "interval", 
     breaks = duration_breaks, 
     main = "Rainy Season Duration",
     plg = list(title = "In Days"),
     col = duration_palette[1:(length(duration_breaks) - 1)])
plot(southern_shp, add = T)

```

## Rainy Days

During the rainy season there are days during which it rained while other days were dry.

The ratio of days that were rainy (rainy = that received at least 3mm of rain) over the duration of the rainy season was computed. It is shown in the graph below as a percentage of days. Yellow areas in the graph received rain on a small portion of days during the rainy season, while the dark blue areas received rain on the majority of days.


```{r rainy-days-plot}

rainy_ratio_labels <- c( "0-20", "21-40", "41-60", "61-80", "81-100")

plot(static_r, 
     "rainy_ratio", 
     breaks = seq(from = 0, to = 100, by = 20), 
     main = "Rainy Days During Rainy Season",
     plg = list(title = "Rainy Days (%)",
                legend = rainy_ratio_labels),
     col = RColorBrewer::brewer.pal(n = 9, name = "YlGnBu"))
plot(southern_shp, add = T)
```


## Dry Days

The graph above also shows how frequently areas experienced dry days (dry = less than 3mm of rain) during the rainy season. It is reproduced below to highlight the ratio of days that were dry during the rainy season (left).

Dry days could be interspersed between rainy days, or tend to group into periods of consecutive dry days. The longest streak of dry days is represented on the right.


```{r dry-days-plots, fig.show="hold", out.width="50%"}
dry_ratio_r <- 100 - static_r[["rainy_ratio"]] 
names(dry_ratio_r) <- "dry_ratio"

dry_ratio_labels <- c( "0-20", "21-40", "41-60", "61-80", "81-100")

par(mar = c(4, 4, .1, .1))
plot(dry_ratio_r, 
     "dry_ratio", 
     breaks = seq(from = 0, to = 100, by = 20), 
     main = "Dry Days During Rainy Season",
     plg = list(title = "Dry Days (%)",
                legend = dry_ratio_labels),
     col = RColorBrewer::brewer.pal(n = 9, name = "YlOrBr"))
plot(southern_shp, add = T)

max_max_streak <- minmax(static_r$max_streak)[2]
plot(static_r, 
     "max_streak", 
     main = "Longest Dry Streaks During Rainy Season",
     plg = list(title = "Streak Duration in Days",
                legend = dry_ratio_labels))
plot(southern_shp, add = T)

```

