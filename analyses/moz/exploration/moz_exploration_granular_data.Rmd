---
title: "Mozambique Exploration"
author: "Seth Caldwell"
date: "10/01/2022"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

source(here::here("exploration", "moz_data_prep.R"))
```

## General situation

Overall, cholera cases peaked at the beginning of 2021 across the two provinces of Nampula and Cabo Delgado. Sharp rises in cases looks difficult to autoregress, as they are seen often but don't reach the scale seen in 2021.

```{r, echo = F, fig.width=8, fig.height=4}
overall_df %>%
  filter(epi_type == "cholera") %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases in Cabo Delgado and Nampula",
       subtitle = "2017 - 2021")
```

## Breakdown by province

The large spike in cases is being primarily driven by a rise in cases in Cabo Delgado.We can also see a near endemic presence of cholera since 2020 within the province.

```{r}
province_df %>%
  filter(epi_type == "cholera") %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_wrap(~province, nrow = 2) +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases in Cabo Delgado and Nampula",
       subtitle = "2017 - 2021")
```

## District level, Cabo Delgado

And here we can see that the vast majority of cases are coming from 2 districts in Cabo Delgado in 2021, Chiure and Metuge.

```{r}
district_df %>%
  filter(epi_type == "cholera", province == "Cabo Delgado") %>%
  group_by(district, year) %>%
  summarize(cases = sum(cases), .groups = "drop") %>%
  ggplot(aes(y = fct_rev(reorder(district, district)), x = year, fill = cases)) + 
  geom_tile() +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases in Cabo Delgado, district level",
       subtitle = "2017 - 2021") +
  scale_fill_gradient(low = "white", high = "#f28080")
```

## District level, Cabo Delgado

Spatially, we can see that these cases are typically clustered in the districts to the southeast of the province, or along the coast.

```{r}
district_df %>%
  filter(epi_type == "cholera", province == "Cabo Delgado") %>%
  group_by(district, year) %>%
  summarize(cases = sum(cases), .groups = "drop") %>%
  left_join(adm2_sf, by = c("district" = "ADM2_PT")) %>%
  st_as_sf() %>%
  ggplot(aes(fill = cases)) + 
  geom_sf(lwd = .3) +
  theme_void() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold")) +
  facet_wrap(~year) +
  labs(y = "",
       x = "",
       title = "Cholera cases in Cabo Delgado, district level",
       subtitle = "2017 - 2021") +
  scale_fill_gradient(low = "white", high = "#f28080")
```

## District level, both provinces

Although districts in Nampula see years with the most cholera in same general area bordering Cabo Delgado, not in the latest outbreak.

```{r}
df_map <- district_df %>%
  filter(epi_type == "cholera") %>%
  group_by(district, year) %>%
  summarize(cases = sum(cases), .groups = "drop") %>%
  left_join(adm2_sf, by = c("district" = "ADM2_PT")) %>%
  st_as_sf() 

df_lbl <- data.frame(
  province = c("Cabo Delgado", "Nampula"),
  year = 2019,
  cases = 0
) %>%
  left_join(adm1_cdn_sf, by = c("province" = "ADM1_PT")) %>%
  st_as_sf()

df_map %>%
  ggplot(aes(fill = cases)) + 
  geom_sf(lwd = 0.3) +
  geom_sf(data = adm1_cdn_sf,
          fill = NA,
          lwd = 0.5) +
  theme_void() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold")) +
  facet_wrap(~year) +
  geom_sf_label(data = df_lbl,
               aes(label = province),
               size = 2.9) +
  labs(y = "",
       x = "",
       title = "Cholera cases in Cabo Delgado and Nampula, district level",
       subtitle = "2017 - 2021") +
  scale_fill_gradient(low = "white", high = "#f28080")
```

## Provinces: useful signals

At the provincial level, isn't immediately clear that we will get useful signals from diarrhea or dysentery case data.

```{r, echo = F, fig.width=8, fig.height=4}
province_df %>%
  filter(age_group == "all") %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_grid(cols = vars(province),
             rows = vars(epi_type),
             scales = "free_y") +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  geom_text(data = data.frame(
    year_week = 120,
    epi_type = "dysentery",
    cases = 3000,
    province = "Cabo Delgado",
    label = "Error in the data?"),
    aes(label = label),
    size = 3) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases in Cabo Delgado and Nampula",
       subtitle = "2017 - 2021")
```

## Districts: useful signals

Although might be possible, usable signals from diarrhea or dysentery case data aren't immediately clear in all districts. 

```{r, echo = F, fig.width=8, fig.height=4}
district_df %>%
  filter(age_group == "all", district %in% c("Chiure", "Metuge")) %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_grid(cols = vars(district),
             rows = vars(epi_type),
             scales = "free_y") +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  geom_text(data = data.frame(
    year_week = 120,
    epi_type = "dysentery",
    cases = 3000,
    district = "Chiure",
    label = "Error in the data?"),
    aes(label = label),
    size = 3) +
  labs(y = "Cases",
       x = "Date",
       title = "Epidemiological cases in Cabo Delgado and Nampula",
       subtitle = "2017 - 2021")
```


## Province: rolling sums

Rolling sum threshold might not work at the provincial level, although possibly separate thresholds per province could work.

```{r, echo = F, fig.width=8, fig.height=4}
province_df %>%
  filter(epi_type == "cholera") %>%
  pivot_longer(starts_with("cases"),
               names_to = "case_type",
               values_to = "cases") %>%
  mutate(case_type = case_when(
    case_type == "cases" ~ "1 week",
    case_type == "cases_2_weeks" ~ "2 weeks",
    case_type == "cases_3_weeks" ~ "3 weeks",
    case_type == "cases_4_weeks" ~ "4 weeks"
  )) %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_grid(cols = vars(province),
             rows = vars(case_type),
             scales = "free_y") +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases and rolling sums, Cabo Delgado and Nampula",
       subtitle = "2017 - 2021")
```

## Overall: rolling sums

At the overall level, it's also difficult to identify when a rolling sum would work best.

```{r, echo = F, fig.width=8, fig.height=4}
overall_df %>%
  filter(epi_type == "cholera") %>%
  pivot_longer(starts_with("cases"),
               names_to = "case_type",
               values_to = "cases") %>%
  mutate(case_type = case_when(
    case_type == "cases" ~ "1 week",
    case_type == "cases_2_weeks" ~ "2 weeks",
    case_type == "cases_3_weeks" ~ "3 weeks",
    case_type == "cases_4_weeks" ~ "4 weeks"
  )) %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_grid(cols = NULL,
             rows = vars(case_type),
             scales = "free_y") +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases and rolling sums, overall",
       subtitle = "2017 - 2021")
```

## Overall: rolling sums

With a threshold of 600, could potentially trigger earlier in the outbreak in 2021. 

```{r, echo = F, fig.width=8, fig.height=4}
overall_df %>%
  filter(epi_type == "cholera") %>%
  pivot_longer(starts_with("cases"),
               names_to = "case_type",
               values_to = "cases") %>%
  mutate(case_type = case_when(
    case_type == "cases" ~ "1 week",
    case_type == "cases_2_weeks" ~ "2 weeks",
    case_type == "cases_3_weeks" ~ "3 weeks",
    case_type == "cases_4_weeks" ~ "4 weeks"
  )) %>%
  filter(case_type %in% c("1 week", "2 weeks")) %>%
  ggplot(aes(y = cases, x = year_week)) + 
  geom_area(fill = "#f28080") +
  facet_grid(cols = NULL,
             rows = vars(case_type),
             scales = "free_y") +
  geom_hline(data = data.frame(
    case_type = "2 weeks"
  ), aes(yintercept = 600),
  alpha = 0.5) +
  geom_vline(data = data.frame(
    case_type = "1 week"
  ), aes(xintercept = 207),
  alpha = 0.5) +
  geom_segment(data = data.frame(case_type = "2 weeks"),
               aes(x = 185, y = 700, xend = 207, yend = 647),
               arrow = arrow(length = unit(4, "pt")),
               alpha = 0.5) +
  geom_text(data = data.frame(case_type = "2 weeks"),
            aes(x = 183, y = 720, label = "637 cases"),
            hjust = 1,
            size = 3) +
  geom_text(data = data.frame(case_type = "2 weeks"),
            aes(x = 40, y = 680, label = "Trigger at 600 cases in past 2 weeks"),
            hjust = 0.5,
            size = 3.5,
            fontface = "bold") +
  geom_text(data = data.frame(case_type = "1 week"),
            aes(x = 201.5, y = 400, label = "Trigger point"),
            hjust = 0.5,
            size = 3,
            fontface = "bold",
            angle = 90) +
  theme_classic() +
  theme(axis.line = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold")) +
  scale_x_continuous(breaks = seq(1, 51*5, by = 51),
                     labels = ~ 2017 + (.x %/% 51)) +
  labs(y = "Cases",
       x = "Date",
       title = "Cholera cases and rolling sums, overall",
       subtitle = "2017 - 2021")
```

## Next steps:

### Questions:

- Are there particular areas in the provinces we want to focus on?
- Would ADMIN3 data allow us to focus more on urban areas and improve signaling?

### Further work:

- Explore with rigor the potential for using dysentery or diarrhea as a signal.
- Check case patterns across all districts and epidemiological data
